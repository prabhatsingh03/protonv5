<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROTON - Home</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .glow-on-hover:hover {
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.3);
        }

        /* Hide content until authentication check completes */
        .auth-check-pending {
            display: none;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 text-white min-h-screen auth-check-pending flex flex-col">
    <!-- Authentication utility -->
    <script src="/static/js/auth.js"></script>
    <script>
        // AUTHENTICATION CHECK
        // This page requires authentication using JWT tokens stored in localStorage.
        // Expected keys:
        //   - 'access_token': JWT access token for API requests
        //   - 'user_data': JSON string containing user info (name, email, role)
        // If either key is missing, user is redirected to landing page.
        // Legacy 'aiProjectControlTowerAuth_v2' key is cleaned up if present.
        verifyAuth('/', true);
    </script>

    <header class="bg-black/20 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3 flex-shrink-0">
                    <img src="/static/logo.png" alt="App Logo" class="h-10 w-auto">
                    <div>
                        <span
                            class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-blue-500">PROTON</span>
                        <p class="text-sm text-slate-400 italic hidden sm:block"> by Simon India Limited</p>
                    </div>
                </div>
                <div id="header-right" class="flex items-center space-x-2 sm:space-x-4">
                    <!-- User info and logout button will be injected here by script -->
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto mt-12 px-4 sm:px-6 lg:px-8 pb-20">
        <div class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-bold text-white" id="welcome-message">Welcome!</h1>
            <p class="mt-3 text-lg text-slate-300">Your central hub for project management and analytics.</p>
        </div>

        <!-- Navigation Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
            <a href="/dashboard" class="glass-card rounded-xl p-8 text-center relative group">
                <div class="flex justify-center mb-4">
                    <div
                        class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center border border-blue-400/30">
                        <svg class="w-8 h-8 text-sky-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Project Dashboard</h2>
                <p class="text-slate-300">Monitor projects, track tasks, and manage resources with our comprehensive
                    dashboard.</p>
                <div class="absolute bottom-6 right-6 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="w-12 h-12 bg-sky-500/30 rounded-full flex items-center justify-center animate-pulse">
                        <svg class="w-6 h-6 text-sky-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                    </div>
                </div>
            </a>

            <a href="/charts" class="glass-card rounded-xl p-8 text-center relative group">
                <div class="flex justify-center mb-4">
                    <div
                        class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center border border-green-400/30">
                        <svg class="w-8 h-8 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z">
                            </path>
                        </svg>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Analytics & Charts</h2>
                <p class="text-slate-300">Visualize project data, track performance metrics, and generate insightful
                    reports.</p>
                <div class="absolute bottom-6 right-6 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="w-12 h-12 bg-sky-500/30 rounded-full flex items-center justify-center animate-pulse">
                        <svg class="w-6 h-6 text-sky-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                    </div>
                </div>
            </a>

            <a href="/org/users" id="user-management-card" class="glass-card rounded-xl p-8 text-center relative group" style="display: none;" aria-label="User Management Dashboard">
                <div class="flex justify-center mb-4">
                    <div
                        class="w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center border border-purple-400/30">
                        <svg class="w-8 h-8 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">User Management</h2>
                <p class="text-slate-300">Manage organization users, create employee accounts, and control access permissions.</p>
                <div class="absolute bottom-6 right-6 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="w-12 h-12 bg-sky-500/30 rounded-full flex items-center justify-center animate-pulse">
                        <svg class="w-6 h-6 text-sky-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                    </div>
                </div>
            </a>
        </div>

        <!-- Additional Content -->
        <div class="glass-card rounded-xl p-8">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">Unlock Your Project's Potential</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                <div>
                    <h4 class="text-xl font-semibold text-sky-300 mb-2">Centralized Control</h4>
                    <p class="text-slate-300">Manage all your projects from a single, intuitive interface. Switch
                        between projects, track overall progress, and maintain a high-level overview with ease.</p>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-sky-300 mb-2">Data-Driven Decisions</h4>
                    <p class="text-slate-300">Leverage powerful analytics to understand project health. Our S-Curve and
                        delay analysis charts provide the insights you need to make informed decisions.</p>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-sky-300 mb-2">AI-Powered Assistance</h4>
                    <p class="text-slate-300">Utilize our integrated AI to assess risks, generate mitigation strategies,
                        and get intelligent updates, helping you stay ahead of potential issues.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="py-12 bg-black/40 border-t border-white/10 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                </div>
                <div class="text-center md:text-right">
                    <p class="text-slate-400 text-sm mb-2">
                        Developed by Simon India Limited
                    </p>
                    <p class="text-slate-500 text-xs">
                        Â© 2025 Simon India Limited. All rights reserved.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Use new format only - user_data is guaranteed to exist due to initial check
            const userDataString = localStorage.getItem('user_data');
            
            let authData = null;
            let name = '';
            let email = '';
            
            if (userDataString) {
                try {
                    authData = JSON.parse(userDataString);
                    name = authData.name || '';
                    email = authData.email || '';
                } catch (e) {
                    console.error('Error parsing user_data:', e);
                }
            }
            
            if (name || email) {
                if (name) {
                    document.getElementById('welcome-message').innerText = `Welcome, ${name}!`;
                }

                const headerRight = document.getElementById('header-right');
                headerRight.innerHTML = `
                    <span class="text-sm font-medium text-slate-300 hidden sm:inline">${email}</span>
                    <button onclick="handleLogout()" class="px-3 sm:px-4 py-2 text-sm font-medium text-white bg-red-600/50 hover:bg-red-600/80 border border-red-500/50 rounded-lg transition-colors">Logout</button>
                `;

                // Check role and show/hide User Management card
                try {
                    const accessToken = localStorage.getItem('access_token');
                    
                    if (accessToken) {
                        // Check if token is expired
                        function isTokenExpired(token) {
                            if (!token) return true;
                            try {
                                let payload = token.split('.')[1];
                                payload = payload.replace(/-/g, '+').replace(/_/g, '/');
                                while (payload.length % 4) {
                                    payload += '=';
                                }
                                const decoded = JSON.parse(atob(payload));
                                if (decoded.exp) {
                                    const expDate = new Date(decoded.exp * 1000);
                                    return expDate < new Date();
                                }
                                return false;
                            } catch {
                                return true;
                            }
                        }

                        // Show session timeout message and redirect
                        function handleSessionTimeout() {
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('refresh_token');
                            localStorage.removeItem('user_data');
                            localStorage.removeItem('aiProjectControlTowerAuth_v2');
                            sessionStorage.removeItem('trial_banner_dismissed');
                            sessionStorage.removeItem('trial_banner_dismissed_at');
                            
                            document.body.innerHTML = `
                                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
                                    <div class="text-center p-8 bg-white rounded-2xl shadow-xl border border-slate-200 max-w-md">
                                        <div class="mb-6">
                                            <div class="mx-auto w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center mb-4">
                                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </div>
                                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Session Timed Out</h2>
                                            <p class="text-slate-600 mb-4">Your session has expired for security reasons.</p>
                                            <p class="text-sm text-slate-500 mb-6">Redirecting to login...</p>
                                            <div class="flex justify-center">
                                                <div class="animate-spin h-8 w-8 border-4 border-slate-200 border-t-indigo-600 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);
                        }

                        if (isTokenExpired(accessToken)) {
                            handleSessionTimeout();
                            return;
                        }

                        // Handle base64url decoding (JWT uses base64url, not base64)
                        let payload = accessToken.split('.')[1];
                        // Replace base64url characters
                        payload = payload.replace(/-/g, '+').replace(/_/g, '/');
                        // Add padding if needed
                        while (payload.length % 4) {
                            payload += '=';
                        }
                        const decoded = JSON.parse(atob(payload));
                        const role = decoded.role;
                        
                        // Show User Management card for org_admin only
                        if (role === 'org_admin') {
                            const userManagementCard = document.getElementById('user-management-card');
                            if (userManagementCard) {
                                userManagementCard.style.display = 'block';
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error parsing role from token:', e);
                }
            }
        });

        function handleLogout() {
            localStorage.removeItem('aiProjectControlTowerAuth_v2');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            window.location.href = '/';
        }
    </script>
</body>

</html>
