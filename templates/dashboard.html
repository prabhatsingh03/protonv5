<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROTON - Dashboard</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        html {
            scroll-behavior: smooth;
        }

        .pulse-bg {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        /* Trial Banner Slide Down Animation */
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .trial-banner-enter {
            animation: slideDown 0.3s ease-out;
        }

        /* Pulsing Upgrade Button for Trial Banner */
        @keyframes pulseUpgrade {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.05);
            }
        }

        .trial-banner-pulse {
            animation: pulseUpgrade 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Banner Fade Out on Dismiss */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .trial-banner-exit {
            animation: fadeOut 0.2s ease-out;
        }

        .file-input-button {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gantt-chart-container {
            width: 100%;
            overflow-x: auto;
            padding: 30px;
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            margin-top: 20px;
            border: 1px solid #cbd5e1;
            position: relative;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            margin: 5px;
            font-size: 0.8rem;
            height: 25px;
        }

        .gantt-task-name-column {
            width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
            color: #334155;
            flex-shrink: 0;
        }

        .gantt-bars-area {
            flex-grow: 1;
            position: relative;
            height: 100%;
            display: flex;
        }

        .gantt-bar-segment {
            height: 20px;
            top: 2.5px;
            color: #ffffff;
            font-size: 0.7rem;
            line-height: 20px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding-left: 5px;
            padding-right: 5px;
            box-sizing: border-box;
            cursor: default;
            display: flex;
            align-items: center;
        }

        .gantt-bar-segment:first-child {
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .gantt-bar-segment:last-child {
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        .gantt-bar-segment.is-critical {
            border: 2px solid #dc2626;
            z-index: 5;
        }

        .gantt-timeline-header {
            display: flex;
            margin-bottom: 8px;
            padding-left: 210px;
            top: 0;
            background-color: #e2e8f0;
            z-index: 10;
            height: 30px;
            align-items: flex-end;
        }

        @media (min-width: 1024px) {
            .gantt-timeline-header {
                position: sticky;
            }
        }

        .gantt-timeline-unit {
            flex-shrink: 0;
            text-align: center;
            font-size: 0.7rem;
            color: #475569;
            border-left: 1px solid #cbd5e1;
            padding: 2px 0;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .gantt-bar-Not-Started {
            background-color: #9ca3af;
        }

        .gantt-bar-In-Progress {
            background-color: #2563eb;
        }

        .gantt-bar-Completed {
            background-color: #059669;
        }

        .gantt-bar-Delayed {
            background-color: #dc2626;
        }

        .gantt-bar-On-Hold {
            background-color: #d97706;
        }

        .gantt-bar-Ahead-of-Schedule {
            background-color: #0284c7;
        }

        .gantt-bar-delay-Weather {
            background-color: #bae6fd;
            color: #0369a1;
            border-left: 1px dashed #7dd3fc;
        }

        .gantt-bar-delay-contractor {
            background-color: #fde68a;
            color: #b45309;
            border-left: 1px dashed #fbbf24;
        }

        .gantt-bar-delay-Client {
            background-color: #fecaca;
            color: #b91c1c;
            border-left: 1px dashed #f87171;
        }

        .gantt-tooltip {
            position: fixed;
            background-color: #475569;
            color: #f1f5f9;
            border: 1px solid #334155;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }

        .gantt-tooltip strong {
            color: #cbd5e1;
        }

        .modal-content {
            background-color: #f8fafc;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }

        .modal-input {
            background-color: #ffffff;
            color: #1e293b;
            border: 1px solid #cbd5e1;
        }

        .modal-input:focus {
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.4);
        }

        .modal-input:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
        }

        .modal-label {
            color: #475569;
        }

        .comment-bubble {
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .admin-comment {
            background-color: #cffafe;
            color: #0e7490;
            margin-left: auto;
            text-align: right;
        }

        .client-response {
            background-color: #dcfce7;
            color: #15803d;
            margin-right: auto;
            text-align: left;
            font-style: italic;
        }

        .client-response-status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .ai-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .chatbot-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .chatbot-toggle-button {
            background-color: #1d4ed8;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .chatbot-toggle-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .chat-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 450px;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform-origin: bottom right;
        }

        @media (max-width: 640px) {
            .chat-window {
                width: 100vw;
                height: 85vh;
                right: -1rem;
                bottom: -1rem;
                border-radius: 1rem 1rem 0 0;
                transform-origin: bottom center;
            }
        }

        .chat-window.closed {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        .chat-header {
            background-color: #1d4ed8;
            color: white;
            padding: 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-message {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background-color: #eff6ff;
            color: #1e3a8a;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-message.model {
            background-color: #f1f5f9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }

        .chat-input-form {
            border-top: 1px solid #e2e8f0;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-form input {
            flex-grow: 1;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .chat-input-form input:focus {
            outline: none;
            border: 2px;
            border-color: #3b82f6;
        }

        .chat-input-form button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .chat-input-form button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        .chat-message .prose h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            margin-top: 1rem;
        }

        .chat-message .prose ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-top: 0.5rem;
        }

        .chat-message .prose p {
            margin-top: 0.5rem;
        }

        .chat-message .prose li {
            margin-bottom: 0.25rem;
        }

        .notification-toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
            z-index: 2000;
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        .oepc-nav-bar {
            position: fixed;
            top: 150px;
            /* Adjust this value as needed to fit below your header */
            right: 1rem;
            /* transform: translateY(-50%); */
            /* This line is removed */
            z-index: 40;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 0.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        .oepc-nav-bar:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .oepc-nav-link {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
            position: relative;
        }

        .oepc-nav-link:hover {
            background-color: #e2e8f0;
            transform: scale(1.1);
        }

        .oepc-nav-link .tooltip {
            visibility: hidden;
            width: 120px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            right: 110%;
            /* Changed from left */
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .oepc-nav-link:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .oepc-icon {
            width: 1.65rem;
            height: 1.65rem;
            color: #334155;
            transition: transform 0.2s ease-in-out;
        }

        .oepc-nav-link:hover .oepc-icon {
            transform: scale(1.1);
        }

        /* New styles for the slide-out navigation bar */
        .oepc-nav-bar-right {
            position: fixed;
            top: 50%;
            right: 0;
            z-index: 45;
            /* Below modals but above other content */
            background: rgba(241, 245, 249, 0.8);
            /* slate-100 with opacity */
            backdrop-filter: blur(8px);
            border: 1px solid #e2e8f0;
            /* slate-200 */
            border-right: none;
            padding: 1rem 0.5rem;
            border-radius: 1rem 0 0 1rem;
            /* Rounded corners on the left side */
            box-shadow: -5px 0px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: center;

            /* Animation properties */
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* Start mostly hidden, leaving a 20px handle visible */
            transform: translate(calc(100% - 20px), -50%);
        }

        .oepc-nav-bar-right:hover {
            transform: translate(0, -50%);
            /* Slide fully into view on hover */
        }

        /* Styling for the links within the new bar */
        .oepc-nav-bar-right .oepc-nav-link {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .oepc-nav-bar-right .oepc-nav-link:hover {
            background-color: rgba(203, 213, 225, 0.7);
            /* slate-300 with opacity */
        }

        /* New tooltip styles for the right-side bar */
        .oepc-nav-bar-right .oepc-nav-link .tooltip {
            position: absolute;
            right: 100%;
            /* Position tooltip to the left of the icon */
            top: 50%;
            transform: translateY(-50%);
            margin-right: 1rem;
            /* Space between icon and tooltip */
            background-color: #1e293b;
            /* slate-800 */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease 0.1s;
            /* Added a slight delay */
            pointer-events: none;
            /* Prevent tooltip from interfering */
        }

        .oepc-nav-bar-right:hover .oepc-nav-link:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Add a small visual tab/handle to the bar */
        .oepc-nav-bar-right::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 40px;
            background-color: #94a3b8;
            /* slate-400 */
            border-radius: 4px;
        }

        @keyframes blink-effect {

            0%,
            100% {
                background-color: #157dc2;
                box-shadow: 0 0 5px #157dc2;
            }

            50% {
                background-color: #ffffff;
                box-shadow: 0 0 10px #ffffff;
            }
        }

        /* Add a small visual tab/handle to the bar */
        .oepc-nav-bar-right::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 100%;
            /* The original background-color is now handled by the animation */
            border-radius: 4px;
            /* Add this line to apply the animation */
            animation: blink-effect 2s ease-in-out infinite;
        }

        /* Loading Screen Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #ffffff;
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">
            Just a moment, we're getting things ready for you<span class="loading-dots"></span>
        </div>
    </div>

    <div id="root"></div>

    <!-- AUTHENTICATION CHECK
         This page requires JWT authentication with the following localStorage keys:
         - 'access_token': JWT token for authenticated API requests
         - 'user_data': User information (name, email, role, org_id)
         
         Authentication Flow:
         1. Check for access_token and user_data in localStorage
         2. If missing, clean up any legacy 'aiProjectControlTowerAuth_v2' key
         3. Redirect to landing page (/) for login
         
         Token Refresh:
         - The makeAuthenticatedRequest() function automatically refreshes expired tokens
         - Uses 'refresh_token' from localStorage to obtain new access_token
         - On refresh failure, clears all auth data and redirects to landing page
    -->
    <!-- Early Auth Check Script - Updated for JWT -->
    <script>
        // Ensure Razorpay checkout script is loaded
        (function ensureRazorpayScript() {
            if (!document.querySelector('script[src*="checkout.razorpay.com"]')) {
                const s = document.createElement('script');
                s.src = 'https://checkout.razorpay.com/v1/checkout.js';
                s.async = true;
                document.head.appendChild(s);
            }
        })();

        // Expose global Razorpay checkout handlers
        window.openRazorpayCheckout = function(subscriptionData) {
            if (!subscriptionData || !subscriptionData.subscription_id || !subscriptionData.razorpay_key_id) {
                alert('Payment data missing.');
                return;
            }
            const options = {
                key: subscriptionData.razorpay_key_id,
                subscription_id: subscriptionData.subscription_id,
                name: 'PROTON',
                description: 'Subscription Payment',
                theme: { color: '#8b5cf6' },
                handler: function (response) {
                    window.verifyPayment(response);
                }
            };
            if (typeof Razorpay !== 'undefined') {
                const rz = new Razorpay(options);
                rz.open();
            } else {
                alert('Payment is not ready yet. Please try again in a moment.');
            }
        };

        window.verifyPayment = async function(resp) {
            try {
                const r = await makeAuthenticatedRequest('/api/razorpay/subscription/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(resp)
                });
                const data = await r.json();
                if (data.status === 'success') {
                    if (typeof window.refreshUsageStats === 'function') window.refreshUsageStats();
                    if (typeof window.refreshSubscriptionData === 'function') window.refreshSubscriptionData();
                    alert('Subscription upgraded successfully!');
                } else {
                    alert(data.message || 'Payment verification failed');
                }
            } catch (e) {
                alert('Payment verification failed');
            }
        };
        // Check for new JWT tokens, clear old format if exists
        const accessToken = localStorage.getItem('access_token');
        const userData = localStorage.getItem('user_data');
        
        if (!accessToken || !userData) {
            // Migrate from old auth format if needed
            const oldAuth = localStorage.getItem('aiProjectControlTowerAuth_v2');
            if (oldAuth) {
                localStorage.removeItem('aiProjectControlTowerAuth_v2');
            }
            // Redirect to landing page
            window.location.href = '/';
        }

        // Log current origin for troubleshooting API connection issues
        // Only log in development (when running on localhost/127.0.0.1)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('[Dashboard] Development mode detected');
            console.log('[Dashboard] Page origin:', window.location.origin);
            console.log('[Dashboard] API endpoint base:', window.location.origin + '/api');
            console.log('[Dashboard] Ensure Flask server is running on port', window.location.port || '80');
        }
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        /*
         * ============================================================================
         * DASHBOARD APPLICATION - API ARCHITECTURE
         * ============================================================================
         * 
         * This dashboard uses a client-side React application that communicates with
         * a Flask backend API using JWT authentication.
         * 
         * API ENDPOINT PATTERN:
         * 
         * - All API calls use RELATIVE URLs (e.g., '/api/upload', '/api/projects')
         * - Browser automatically resolves relative URLs against window.location.origin
         * - This ensures API calls always go to the same server that served the page
         * 
         * AUTHENTICATION:
         * 
         * - JWT tokens stored in localStorage (access_token, refresh_token)
         * - makeAuthenticatedRequest() wrapper adds Authorization header automatically
         * - Expired tokens are automatically refreshed once (401 response)
         * - Failed refresh redirects to landing page for re-login
         * 
         * KEY FUNCTIONS:
         * 
         * - makeAuthenticatedRequest(url, options): Authenticated fetch wrapper
         * - refreshAccessToken(): Refresh expired JWT token
         * - handleFileUpload(event): CSV file upload for task import
         * - saveDataToServer(tasks): Save task changes to backend
         * - loadProjectData(projectName): Load project tasks from backend
         * 
         * API ENDPOINTS USED:
         * 
         * - POST /api/upload?project=<name> - Upload CSV file
         * - GET /api/load?project=<name> - Load project tasks
         * - POST /api/save?project=<name> - Save task changes
         * - POST /api/add_task?project=<name> - Add new task
         * - POST /api/delete_task?project=<name> - Delete task
         * - POST /api/update_task?project=<name> - Update single task
         * - GET /api/projects - List all projects
         * - POST /api/projects - Create new project
         * - GET /api/org/usage - Get organization usage stats
         * - GET /api/org/subscription - Get subscription details
         * - And many more... (see makeAuthenticatedRequest usage throughout)
         * 
         * IMPORTANT NOTES:
         * 
         * - Never use absolute URLs (e.g., 'http://127.0.0.1:5000/api/upload')
         * - Always use relative URLs (e.g., '/api/upload')
         * - Always encode query parameters with encodeURIComponent()
         * - Always encode path parameters with encodeURIComponent()
         * - FormData uploads automatically set correct Content-Type header
         * 
         * TROUBLESHOOTING:
         * 
         * - See detailed troubleshooting guide below (search for "TROUBLESHOOTING")
         * - Check browser console for diagnostic logs on page load
         * - Verify Flask server is running on same port as page
         * 
         * ============================================================================
         */

        // --- SVG Icons ---
        const SVGIcon = ({ size = 18, className = "", children }) => (React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, children));
        const ChevronDown = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "6 9 12 15 18 9" }));
        const ChevronUp = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "18 15 12 9 6 15" }));
        const Edit3 = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M12 20h9" }), React.createElement("path", { d: "M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" }));
        const Zap = (props) => React.createElement(SVGIcon, props, React.createElement("polygon", { points: "13 2 3 14 12 14 11 22 21 10 12 10 13 2" }));
        const CheckCircle = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M22 11.08V12a10 10 0 1 1-5.93-9.14" }), React.createElement("polyline", { points: "22 4 12 14.01 9 11.01" }));
        const MessageSquareIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" }));
        const PlusCircle = (props) => React.createElement(SVGIcon, props, React.createElement("circle", { cx: "12", cy: "12", r: "10" }), React.createElement("line", { x1: "12", y1: "8", x2: "12", y2: "16" }), React.createElement("line", { x1: "8", y1: "12", x2: "16", y2: "12" }));
        const Save = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" }), React.createElement("polyline", { points: "17 21 17 13 7 13 7 21" }), React.createElement("polyline", { points: "7 3 7 8 15 8" }));
        const UploadCloud = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "16 16 12 12 8 16" }), React.createElement("line", { x1: "12", y1: "12", x2: "12", y2: "21" }), React.createElement("path", { d: "M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3" }), React.createElement("polyline", { points: "16 16 12 12 8 16" }));
        const DownloadCloud = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "8 17 12 21 16 17" }), React.createElement("line", { x1: "12", y1: "12", x2: "12", y2: "21" }), React.createElement("path", { d: "M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3" }));
        const AlertTriangle = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" }), React.createElement("line", { x1: "12", y1: "9", x2: "12", y2: "13" }), React.createElement("line", { x1: "12", y1: "17", x2: "12.01", y2: "17" }));
        const FileText = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" }), React.createElement("polyline", { points: "14 2 14 8 20 8" }), React.createElement("line", { x1: "16", y1: "13", x2: "8", y2: "13" }), React.createElement("line", { x1: "16", y1: "17", x2: "8", y2: "17" }), React.createElement("polyline", { points: "10 9 9 9 8 9" }));
        const Image = (props) => React.createElement(SVGIcon, props, React.createElement("rect", { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" }), React.createElement("circle", { cx: "8.5", cy: "8.5", r: "1.5" }), React.createElement("polyline", { points: "21 15 16 10 5 21" }));
        const LogOutIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement("polyline", { points: "16 17 21 12 16 7" }), React.createElement("line", { x1: "21", y1: "12", x2: "9", y2: "12" }));
        const UserCheck = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "8.5", cy: "7", r: "4" }), React.createElement("polyline", { points: "17 11 19 13 23 9" }));
        const SendIcon = (props) => React.createElement(SVGIcon, props, React.createElement("line", { x1: "22", y1: "2", x2: "11", y2: "13" }), React.createElement("polygon", { points: "22 2 15 22 11 13 2 9 22 2" }));
        const InfoIcon = (props) => React.createElement(SVGIcon, props, React.createElement("circle", { cx: "12", cy: "12", r: "10" }), React.createElement("line", { x1: "12", y1: "16", x2: "12", y2: "12" }), React.createElement("line", { x1: "12", y1: "8", x2: "12.01", y2: "8" }));
        const Trash2 = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "3 6 5 6 21 6" }), React.createElement("path", { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }), React.createElement("line", { x1: "10", y1: "11", x2: "10", y2: "17" }), React.createElement("line", { x1: "14", y1: "11", x2: "14", y2: "17" }));
        const HistoryIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M1 4v6h6" }), React.createElement("path", { d: "M3.51 15a9 9 0 1 0 2.13-9.36L1 10" }));
        const MenuIcon = (props) => React.createElement(SVGIcon, props, React.createElement("line", { x1: "3", y1: "12", x2: "21", y2: "12" }), React.createElement("line", { x1: "3", y1: "6", x2: "21", y2: "6" }), React.createElement("line", { x1: "3", y1: "18", x2: "21", y2: "18" }));
        const BarChartIcon = (props) => React.createElement(SVGIcon, props, React.createElement("line", { x1: "12", x2: "12", y1: "20", y2: "10" }), React.createElement("line", { x1: "18", x2: "18", y1: "20", y2: "4" }), React.createElement("line", { x1: "6", x2: "6", y1: "20", y2: "16" }));
        const HomeIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" }), React.createElement("polyline", { points: "9 22 9 12 15 12 15 22" }));
        const CornerDownRight = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "15 10 20 15 15 20" }), React.createElement("path", { d: "M4 4v7a4 4 0 0 0 4 4h12" }));
        const LightbulbIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M15.06 9A7 7 0 0 1 9 15.06M9 15.06c-1.33-1.33-2.06-3.06-2.06-4.94A5 5 0 0 1 12 5a5 5 0 0 1 5 5c0 1.88-.73 3.61-2.06 4.94" }), React.createElement("path", { d: "M12 1a7 7 0 0 0-7 7c0 1.62.66 3.1 1.67 4.22" }), React.createElement("path", { d: "M8 22h8" }), React.createElement("path", { d: "M10 19v3" }), React.createElement("path", { d: "M14 19v3" }));
        const ChatIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" }));
        const CloudWeather = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" }));
        const UserX = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "8.5", cy: "7", r: "4" }), React.createElement("line", { x1: "18", y1: "8", x2: "23", y2: "13" }), React.createElement("line", { x1: "23", y1: "8", x2: "18", y2: "13" }));
        const UserCog = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "9", cy: "7", r: "4" }), React.createElement("circle", { cx: "19", cy: "11.5", r: "1.5" }), React.createElement("path", { d: "M19 8.25V10" }), React.createElement("path", { d: "M19 13v1.75" }), React.createElement("path", { d: "m21.56 9.44-1.25.72" }), React.createElement("path", { d: "m16.44 13.56-1.25.72" }), React.createElement("path", { d: "m21.56 13.56-1.25-.72" }), React.createElement("path", { d: "m16.44 9.44-1.25-.72" }));
        const EyeIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" }), React.createElement("circle", { cx: "12", cy: "12", r: "3" }));
        const EyeOffIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07l-1.07-1.07-1.07 1.07" }), React.createElement("line", { x1: "1", y1: "1", x2: "23", y2: "23" }));
        const ProjectIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" }));
        const PaperclipIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" }));
        const DownloadIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), React.createElement("polyline", { points: "7 10 12 15 17 10" }), React.createElement("line", { x1: "12", y1: "15", x2: "12", y2: "3" }));
        const X = (props) => React.createElement(SVGIcon, props, React.createElement("line", { x1: "18", y1: "6", x2: "6", y2: "18" }), React.createElement("line", { x1: "6", y1: "6", x2: "18", y2: "18" }));

        /*
         * ============================================================================
         * API ENDPOINT CONFIGURATION & TROUBLESHOOTING
         * ============================================================================
         * 
         * This application uses RELATIVE URLs for all API calls (e.g., '/api/upload').
         * The browser automatically resolves these against window.location.origin.
         * 
         * Example:
         * - If page is served from: http://127.0.0.1:5000/dashboard
         * - Then '/api/upload' becomes: http://127.0.0.1:5000/api/upload
         * 
         * TROUBLESHOOTING CONNECTION ERRORS:
         * 
         * 1. ERR_CONNECTION_REFUSED:
         *    - Symptom: API calls fail with "net::ERR_CONNECTION_REFUSED"
         *    - Cause: Flask server is not running on the expected port
         *    - Solution: 
         *      a) Check window.location.origin in browser console
         *      b) Ensure Flask server is running on the same port
         *      c) Default Flask port is 5000, but can be changed with --port flag
         *      d) Example: python app.py --port 5000
         * 
         * 2. Port Mismatch:
         *    - Symptom: API calls go to wrong port (e.g., 5125 instead of 5000)
         *    - Cause: Page was accessed via wrong port or browser cached old page
         *    - Solution:
         *      a) Clear browser cache (Ctrl+Shift+Delete)
         *      b) Hard refresh (Ctrl+F5 or Cmd+Shift+R)
         *      c) Access page via correct port: http://127.0.0.1:5000/dashboard
         *      d) Check Flask server logs to confirm which port it's running on
         * 
         * 3. CORS Errors:
         *    - Symptom: "Access-Control-Allow-Origin" errors in console
         *    - Cause: API requests going to different origin than page
         *    - Solution: Ensure page and API are served from same origin
         * 
         * 4. 401 Unauthorized:
         *    - Symptom: API calls return 401 status
         *    - Cause: JWT token expired or invalid
         *    - Solution: Token is automatically refreshed once; if persists, re-login
         * 
         * 5. 403 Forbidden (Plan Limit):
         *    - Symptom: API calls return 403 with PLAN_LIMIT_EXCEEDED error
         *    - Cause: Organization has exceeded plan limits
         *    - Solution: Upgrade plan or contact admin
         * 
         * IMPORTANT: Never use absolute URLs (e.g., 'http://127.0.0.1:5000/api/upload')
         *            Always use relative URLs (e.g., '/api/upload')
         *            This ensures API calls always go to the same origin as the page.
         * 
         * ============================================================================
         */

        // --- Configuration & Constants ---
        const APP_TITLE = "PROTON ";
        const APP_TITLE2 = " by Simon India Limited";
        const TASK_STATUSES = ['Not Started', 'In Progress', 'Completed', 'Delayed', 'On Hold', 'Ahead of Schedule'];
        const CLIENT_COMMENT_STATUSES = ['Acknowledged', 'Approved', 'Return with Comments', 'Hold for Review'];
        const GEMINI_API_KEY = "AIzaSyAXC5LPqgA8SF0qURPBfqTEmTRu_hgixe4";
        const CHATBOT_GEMINI_API_KEY = "AIzaSyAXC5LPqgA8SF0qURPBfqTEmTRu_hgixe4";

        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });

        // Helper function to base64url-decode JWT payloads
        // Replaces base64url characters (- → +, _ → /) and adds padding (=)
        function decodeBase64Url(base64Url) {
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) {
                base64 += '=';
            }
            return atob(base64);
        }

        // Session Timeout Handler Functions
        // Check if JWT token is expired
        function isTokenExpired(token) {
            if (!token) return true;
            try {
                let payload = token.split('.')[1];
                payload = payload.replace(/-/g, '+').replace(/_/g, '/');
                while (payload.length % 4) {
                    payload += '=';
                }
                const decoded = JSON.parse(atob(payload));
                if (decoded.exp) {
                    const expDate = new Date(decoded.exp * 1000);
                    return expDate < new Date();
                }
                return false;
            } catch {
                return true;
            }
        }

        // Show session timeout message and redirect
        function handleSessionTimeout() {
            // Clear all auth data
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            localStorage.removeItem('aiProjectControlTowerAuth_v2');
            sessionStorage.removeItem('trial_banner_dismissed');
            sessionStorage.removeItem('trial_banner_dismissed_at');
            
            // Show timeout message
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
                        <div class="text-center p-8 bg-white rounded-2xl shadow-xl border border-slate-200 max-w-md">
                            <div class="mb-6">
                                <div class="mx-auto w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center mb-4">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h2 class="text-2xl font-bold text-slate-800 mb-2">Session Timed Out</h2>
                                <p class="text-slate-600 mb-4">Your session has expired for security reasons.</p>
                                <p class="text-sm text-slate-500 mb-6">Redirecting to login...</p>
                                <div class="flex justify-center">
                                    <div class="animate-spin h-8 w-8 border-4 border-slate-200 border-t-indigo-600 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }

        // JWT Authentication Helper Functions
        const refreshAccessToken = async () => {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) {
                handleSessionTimeout();
                return false;
            }
            
            try {
                const response = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.access_token) {
                        localStorage.setItem('access_token', data.access_token);
                        return true;
                    }
                }
                // Refresh failed - show session timeout
                handleSessionTimeout();
                return false;
            } catch (error) {
                // Refresh failed - show session timeout
                handleSessionTimeout();
                return false;
            }
        };

        /**
         * Authenticated API request wrapper
         * 
         * @param {string} url - Relative URL path (e.g., '/api/upload', '/api/projects')
         *                       IMPORTANT: Always use relative URLs starting with '/'
         *                       The browser will automatically resolve against window.location.origin
         * @param {Object} options - Standard fetch options (method, headers, body, etc.)
         * @returns {Promise<Response>} - Fetch Response object
         * 
         * Features:
         * - Automatically adds JWT Authorization header
         * - Handles token refresh on 401 (expired token)
         * - Handles plan limit errors on 403 with user notifications
         * - Supports FormData uploads (preserves multipart/form-data content type)
         * 
         * Troubleshooting:
         * - ERR_CONNECTION_REFUSED: Server not running on expected port
         *   Check that Flask server port matches window.location.origin
         *   Example: If page is at http://127.0.0.1:5000, server must run on port 5000
         * - 401 Unauthorized: Token expired or invalid (auto-refreshed once)
         * - 403 Forbidden: Plan limit exceeded (shows upgrade notification)
         */
        const makeAuthenticatedRequest = async (url, options = {}) => {
            // Defensive check: Warn if URL is not relative
            if (!url.startsWith('/')) {
                console.warn(`[makeAuthenticatedRequest] Warning: URL should be relative (start with '/'): ${url}`);
                console.warn(`[makeAuthenticatedRequest] Current origin: ${window.location.origin}`);
            }

            let accessToken = localStorage.getItem('access_token');
            
            // Check if token is expired before making request
            if (isTokenExpired(accessToken)) {
                const newToken = await refreshAccessToken();
                if (!newToken || isTokenExpired(newToken)) {
                    throw new Error('Session expired');
                }
                accessToken = localStorage.getItem('access_token');
            }
            
            // Handle FormData specially - only add Authorization, don't touch Content-Type
            if (options.body instanceof FormData) {
                options = {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': 'Bearer ' + accessToken
                    }
                };
            } else {
                // For non-FormData requests, ensure headers object exists
                if (!options.headers) {
                    options.headers = {};
                }
                // Add Authorization header
                options.headers['Authorization'] = 'Bearer ' + accessToken;
            }
            
            // Make the request
            // Relative URL is resolved by browser against window.location.origin
            // Example: '/api/upload' becomes 'http://127.0.0.1:5000/api/upload' if page is served from port 5000
            let response = await fetch(url, options);
            
            // If 401, try to refresh token and retry once
            if (response.status === 401) {
                const refreshSuccess = await refreshAccessToken();
                if (refreshSuccess) {
                    const newAccessToken = localStorage.getItem('access_token');
                    if (newAccessToken && !isTokenExpired(newAccessToken)) {
                        // Reconstruct options for retry
                        if (options.body instanceof FormData) {
                            options = {
                                ...options,
                                headers: {
                                    ...options.headers,
                                    'Authorization': 'Bearer ' + newAccessToken
                                }
                            };
                        } else {
                            options.headers['Authorization'] = 'Bearer ' + newAccessToken;
                        }
                        
                        response = await fetch(url, options);
                    } else {
                        throw new Error('Session expired');
                    }
                } else {
                    throw new Error('Session expired');
                }
            }
            
            // Plan limit error handling and usage refresh
            if (response.status === 403) {
                try {
                    const clone = response.clone();
                    const data = await clone.json();
                    if (data && data.error_code === 'PLAN_LIMIT_EXCEEDED') {
                        const role = (window.loggedInUser && window.loggedInUser.role) || 'org_user';
                        const isAdmin = role === 'org_admin' || role === 'super_admin';
                        const upgradeUrl = data.upgrade_url || '/upgrade';
                        const suggested = data.suggested_plan ? ` Upgrade to ${data.suggested_plan}.` : '';
                        const message = (data.message || 'Plan limit reached.') + suggested;
                        const action = isAdmin
                            ? { label: 'Upgrade Now', onClick: () => { window.location.href = upgradeUrl; } }
                            : { label: 'Contact Admin', onClick: () => { try { alert('Please contact your Organization Admin to upgrade your plan.'); } catch (e) {} } };
                        if (typeof window.showNotification === 'function') {
                            window.showNotification({ message, type: 'error', action, duration: 12000 });
                        }
                        if (typeof window.refreshUsageStats === 'function') {
                            window.refreshUsageStats();
                        }
                        try { window.dispatchEvent(new CustomEvent('planLimitExceeded', { detail: data })); } catch (e) {}
                    }
                } catch (e) {}
            }
            
            return response;
        };

        // Utility function to find a task by ID in nested task structure
        const findTaskById = (tasks, taskId) => {
            for (const task of tasks) {
                if (task.id === taskId) {
                    return task;
                }
                if (task.subtasks && task.subtasks.length > 0) {
                    const found = findTaskById(task.subtasks, taskId);
                    if (found) return found;
                }
            }
            return null;
        };
        const LoadingSpinner = ({ message }) => React.createElement("div", { className: "text-center py-10 bg-white shadow rounded-lg" }, React.createElement("div", { className: "flex items-center justify-center" }, React.createElement("div", { className: "animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-sky-500" }), React.createElement("p", { className: "ml-4 text-lg text-slate-500" }, message || "Loading...")));
        const formatDateForDisplay = (dateStr) => { if (!dateStr) return 'N/A'; try { const date = new Date(dateStr + 'T00:00:00Z'); if (isNaN(date.getTime())) return 'Invalid Date'; return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' }); } catch (e) { return 'Invalid Date'; } };
        const formatDateForExport = (dateStr) => dateStr || '';
        const formatDateForInput = (dateStr) => dateStr || '';

        const parseCSVDate = (dateStr) => {
            if (!dateStr) return null;
            let cleanedDateStr = String(dateStr).trim().replace(/^"|"$/g, '');
            if (cleanedDateStr.includes(' ')) {
                cleanedDateStr = cleanedDateStr.split(' ')[0];
            }
            const monthMap = { 'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12' };
            const parts = cleanedDateStr.split(/[-/]/);
            if (parts.length === 3) {
                const p1 = parts[0], p2 = parts[1], p3 = parts[2];
                if (p1.length === 4 && p2.length === 2 && p3.length === 2) return cleanedDateStr;
                if (p1.length === 2 && p2.length === 2 && p3.length === 4) return `${p3}-${p2}-${p1}`;
                if (p1.length >= 1 && p1.length <= 2 && monthMap[p2] && p3.length === 2) {
                    const year = parseInt(`20${p3}`, 10);
                    const month = monthMap[p2];
                    const day = String(p1).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }
            return null;
        };

        const generateCSV = (tasksToExport) => {
            const headers = ["WBS", "Task Name", "Original Duration (Days)", "Weightage (%)", "Planned Start Date", "Planned End Date", "Actual Start Date", "Actual End Date", "Progress (%)", "Status", "Is Critical", "Predecessors", "Weather Delay (Days)", "Contractor Delay (Days)", "Client Delay (Days)", "Is Client Deliverable", "Notes", "Client Communications Log"];
            const flattenedTasks = [];
            const flatten = (tasks) => {
                tasks.forEach(task => {
                    flattenedTasks.push(task);
                    if (task.subtasks && task.subtasks.length > 0) flatten(task.subtasks);
                });
            };
            flatten(tasksToExport);
            const rows = flattenedTasks.map(task => {
                const clientCommLog = (task.clientComments || []).map(cc => {
                    let log = `${cc.adminName || 'Admin'} (${formatDateForDisplay(cc.adminTimestamp)}): ${cc.adminComment.replace(/"/g, '""')}`;
                    if (cc.clientStatus) {
                        log += ` | Client (${formatDateForDisplay(cc.clientResponseTimestamp)}): ${cc.clientStatus}`;
                        if (cc.clientComment) log += ` - Comment: ${cc.clientComment.replace(/"/g, '""')}`;
                    }
                    return log;
                }).join(' || ');
                return [task.wbs || '', task.taskName || '', task.originalDurationDays || 0, task.weightage ?? 0, formatDateForExport(task.plannedStartDate), formatDateForExport(task.plannedEndDate), formatDateForExport(task.actualStartDate), formatDateForExport(task.actualEndDate), task.progress || 0, task.status || 'Not Started', task.isCritical ? 'Yes' : 'No', task.predecessorString || '', task.delayWeatherDays || 0, task.delayContractorDays || 0, task.delayClientDays || 0, task.isClientDeliverable ? 'Yes' : 'No', (task.notes || []).map(n => `${new Date(n.timestamp).toLocaleString()} [${n.source}]: ${n.text.replace(/"/g, '""')}`).join('; '), clientCommLog];
            });
            return [headers.join(','), ...rows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))].join('\n');
        };

        const NotificationToast = ({ message, type = 'info', onDismiss, action, duration }) => {
            const { useState, useEffect } = React;
            const [show, setShow] = useState(false);
            useEffect(() => {
                setShow(true);
                const displayMs = typeof duration === 'number' ? duration : 5000;
                const timer = setTimeout(() => { setShow(false); setTimeout(onDismiss, 500); }, displayMs);
                return () => clearTimeout(timer);
            }, [message, onDismiss]);
            const typeClasses = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
            const Icon = { info: InfoIcon, success: CheckCircle, error: AlertTriangle }[type];
            return React.createElement('div', { className: `notification-toast ${show ? 'show' : ''}` },
                React.createElement('div', { className: `flex items-center justify-between w-full text-white text-sm font-medium px-4 py-3 rounded-lg shadow-lg ${typeClasses[type]}` },
                    React.createElement('div', { className: 'flex items-center' },
                        React.createElement(Icon, { size: 20, className: 'mr-2' }),
                        React.createElement('p', null, message)
                    ),
                    action && React.createElement('button', { onClick: action.onClick, className: 'ml-4 px-3 py-1 bg-white/20 hover:bg-white/30 rounded-md text-white text-xs font-semibold' }, action.label)
                )
            );
        };

        // Usage Stats Widget
        const UsageStatsWidget = ({ role }) => {
            const { useState, useEffect, useRef } = React;
            const [usage, setUsage] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const intervalRef = useRef(null);

            const fetchUsage = async () => {
                setLoading(true);
                setError('');
                try {
                    const res = await makeAuthenticatedRequest('/api/org/usage', { method: 'GET' });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setUsage(data);
                        window.latestUsageStats = data;
                    } else {
                        setError(data.message || 'Failed to load usage');
                    }
                } catch (e) {
                    setError('Failed to load usage');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchUsage();
                window.refreshUsageStats = fetchUsage;
                intervalRef.current = setInterval(fetchUsage, 5 * 60 * 1000);
                const onExceeded = () => fetchUsage();
                window.addEventListener('planLimitExceeded', onExceeded);
                return () => {
                    clearInterval(intervalRef.current);
                    window.removeEventListener('planLimitExceeded', onExceeded);
                };
            }, []);

            const Progress = ({ label, value, limit, percent }) => {
                const pct = Math.max(0, Math.min(100, percent || (limit > 0 && limit < 999999 ? Math.round((value / limit) * 100) : 0)));
                return React.createElement('div', { className: 'mb-3' },
                    React.createElement('div', { className: 'flex justify-between text-xs mb-1' },
                        React.createElement('span', null, label),
                        React.createElement('span', null, limit >= 999999 ? `${value} / ∞` : `${value} / ${limit} (${pct}%)`)
                    ),
                    React.createElement('div', { className: 'w-full h-2 bg-slate-700 rounded' },
                        React.createElement('div', { className: 'h-2 bg-sky-500 rounded', style: { width: `${pct}%` } })
                    )
                );
            };

            if (loading) return React.createElement('div', { className: 'mt-6 text-xs text-slate-300' }, 'Loading usage...');
            if (error) return React.createElement('div', { className: 'mt-6 text-xs text-red-300' }, error);
            if (!usage) return null;

            const limits = usage.limits || {};
            const u = usage.usage || {};
            const pct = usage.percentage || {};

            return React.createElement('div', { className: 'mt-6 p-3 bg-slate-900/50 rounded-lg border border-slate-700' },
                React.createElement('div', { className: 'text-xs font-bold text-slate-200 mb-2' }, 'Organization Usage'),
                React.createElement(Progress, { label: 'Projects', value: u.projects || 0, limit: limits.projects ?? 0, percent: pct.projects }),
                React.createElement(Progress, { label: 'Team Members', value: u.users || 0, limit: limits.users ?? 0, percent: pct.users }),
                React.createElement(Progress, { label: 'AI Prompts (This Week)', value: u.ai_prompts_this_week || 0, limit: (limits.ai_prompts_per_week ?? 0), percent: pct.ai_prompts }),
                React.createElement('div', { className: 'mt-2 text-[10px] text-slate-400' }, usage.subscription?.plan ? `Plan: ${usage.subscription.plan}` : ''),
                (role === 'super_admin' || role === 'org_admin') && React.createElement('button', { onClick: () => { if (window.openSubscriptionManagement) window.openSubscriptionManagement(); }, className: 'w-full mt-3 py-2 px-3 text-xs font-medium text-purple-300 bg-purple-900/30 rounded hover:bg-purple-900/40 transition-colors' }, 'Manage Subscription →')
            );
        };

        const OverallProgress = ({ tasks, selectedProject }) => {
            const { useState, useEffect, useMemo } = React;
            const [plannedProgress, setPlannedProgress] = useState(0);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (selectedProject) {
                    setIsLoading(true);
                    makeAuthenticatedRequest(`/api/overall_planned_progress?project=${encodeURIComponent(selectedProject)}`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                        .then(res => res.json())
                        .then(data => {
                            setPlannedProgress(data.planned_progress || 0);
                        })
                        .catch(err => {
                            console.error("Failed to fetch planned progress:", err);
                            setPlannedProgress(0); // Set to 0 on error
                        })
                        .finally(() => {
                            setIsLoading(false);
                        });
                }
            }, [selectedProject, tasks]); // Re-fetch if project or tasks change

            const overallProgress = useMemo(() => {
                const mainProjectTask = tasks.find(t => t.wbs === '1');
                return mainProjectTask ? mainProjectTask.progress || 0 : 0;
            }, [tasks]);

            const flattenedTasks = useMemo(() => { const allTasks = []; const flatten = (tasksToFlatten) => { if (!tasksToFlatten) return; tasksToFlatten.forEach(task => { allTasks.push(task); flatten(task.subtasks); }); }; flatten(tasks); return allTasks; }, [tasks]);
            const totalWeatherDelay = useMemo(() => flattenedTasks.reduce((sum, task) => sum + (task.delayWeatherDays || 0), 0), [flattenedTasks]);
            const totalContractorDelay = useMemo(() => flattenedTasks.reduce((sum, task) => sum + (task.delayContractorDays || 0), 0), [flattenedTasks]);
            const totalClientDelay = useMemo(() => flattenedTasks.reduce((sum, task) => sum + (task.delayClientDays || 0), 0), [flattenedTasks]);

            return (React.createElement("div", { className: "mb-6 p-4 bg-white shadow rounded-lg" },
                React.createElement("h3", { className: "text-lg font-semibold text-slate-700 mb-2" }, "Overall Project Progress"),
                React.createElement("div", { className: "w-full bg-slate-200 rounded-full h-4 relative" },
                    React.createElement("div", { className: "bg-blue-300 h-4 rounded-full", style: { width: `${plannedProgress.toFixed(2)}%` }, title: `Planned Progress: ${plannedProgress.toFixed(2)}%` }),
                    React.createElement("div", { className: "bg-blue-600 h-4 rounded-full absolute top-0", style: { width: `${overallProgress}%` }, title: `Actual Progress: ${overallProgress}%` })
                ),
                React.createElement("div", { className: "flex justify-between text-sm mt-2" },
                    React.createElement("div", { className: "flex items-center" },
                        React.createElement("span", { className: "h-3 w-3 rounded-full bg-blue-600 mr-2" }),
                        React.createElement("span", null, `Actual: `, React.createElement("strong", null, `${overallProgress}%`))
                    ),
                    isLoading
                        ? React.createElement("div", { className: "text-xs text-slate-500" }, "Calculating Planned...")
                        : React.createElement("div", { className: "flex items-center" },
                            React.createElement("span", { className: "h-3 w-3 rounded-full bg-blue-300 mr-2" }),
                            React.createElement("span", null, `Planned: `, React.createElement("strong", null, `${plannedProgress.toFixed(2)}%`))
                        )
                ),
                (totalWeatherDelay > 0 || totalContractorDelay > 0 || totalClientDelay > 0) && React.createElement("div", { className: "text-xs text-slate-500 mt-3 border-t pt-2 flex flex-col sm:flex-row flex-wrap justify-between gap-x-4" },
                    totalWeatherDelay > 0 && React.createElement("span", null, "Weather Delay: ", totalWeatherDelay, " days"),
                    totalContractorDelay > 0 && React.createElement("span", null, "Contractor Delay: ", totalContractorDelay, " days"),
                    totalClientDelay > 0 && React.createElement("span", null, "Client Delay: ", totalClientDelay, " days")
                )
            ));
        };

        const GanttChart = ({ tasks }) => {
            const { useState, useMemo, useCallback } = React;
            const DAY_WIDTH = 30;
            const GANTT_CHART_AREA_ID = "gantt-chart-render-area";
            const [tooltip, setTooltip] = useState({ visible: false, content: null, x: 0, y: 0 });
            const flattenedTasks = useMemo(() => {
                const visibleTasks = [];
                const getVisibleTasks = (tasksToProcess) => {
                    if (!tasksToProcess) return;
                    tasksToProcess.forEach(task => {
                        visibleTasks.push(task);
                        if (task.isExpanded && task.subtasks && task.subtasks.length > 0) {
                            getVisibleTasks(task.subtasks);
                        }
                    });
                };
                getVisibleTasks(tasks);
                return visibleTasks;
            }, [tasks]);
            const handleMouseEnter = (event, task, segmentType = 'main') => {
                let details = [
                    React.createElement("p", { key: "name" }, React.createElement("strong", null, "Task: "), task.taskName),
                    React.createElement("p", { key: "wbs" }, React.createElement("strong", null, "WBS: "), task.wbs),
                    React.createElement("p", { key: "planned" }, React.createElement("strong", null, "Planned: "), `${formatDateForDisplay(task.plannedStartDate)} - ${formatDateForDisplay(task.plannedEndDate)}`),
                    React.createElement("p", { key: "status" }, React.createElement("strong", null, "Status: "), task.status),
                    React.createElement("p", { key: "progress" }, React.createElement("strong", null, "Progress: "), `${task.progress || 0}%`)
                ];
                if (task.delayWeatherDays > 0) { details.push(React.createElement("p", { key: "Weather" }, React.createElement("strong", null, "Weather Delay: "), `${task.delayWeatherDays} day(s)`)); }
                if (task.delayContractorDays > 0) { details.push(React.createElement("p", { key: "contractor" }, React.createElement("strong", null, "Contractor Delay: "), `${task.delayContractorDays} day(s)`)); }
                if (task.delayClientDays > 0) { details.push(React.createElement("p", { key: "client" }, React.createElement("strong", null, "Client Delay: "), `${task.delayClientDays} day(s)`)); }
                if (segmentType === 'Weather') { details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-sky-300" }, "Segment: Weather Delay")); }
                else if (segmentType === 'contractor') { details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-amber-300" }, "Segment: Contractor Delay")); }
                else if (segmentType === 'Client') { details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-red-300" }, "Segment: Client Delay")); }
                const content = React.createElement("div", null, ...details);
                setTooltip({ visible: true, content: content, x: event.clientX + 15, y: event.clientY + 15 });
            };
            const handleMouseLeave = () => { setTooltip({ visible: false, content: null, x: 0, y: 0 }); };
            const { projectStartDate, totalDays, timelineUnits } = useMemo(() => {
                if (!flattenedTasks || flattenedTasks.length === 0) return { projectStartDate: null, totalDays: 0, timelineUnits: [] };
                let minDate = null, maxDate = null;
                flattenedTasks.forEach(task => {
                    if (task.plannedStartDate) { const d = new Date(task.plannedStartDate + 'T00:00:00Z'); if (!minDate || d < minDate) minDate = d; }
                    if (task.plannedEndDate) {
                        let effectiveEndDate = new Date(task.plannedEndDate + 'T00:00:00Z');
                        effectiveEndDate.setDate(effectiveEndDate.getDate() + (task.delayWeatherDays || 0) + (task.delayContractorDays || 0) + (task.delayClientDays || 0));
                        if (!maxDate || effectiveEndDate > maxDate) maxDate = effectiveEndDate;
                    }
                });
                if (!minDate || !maxDate) return { projectStartDate: null, totalDays: 0, timelineUnits: [] };
                const pStartDate = new Date(minDate); const pEndDate = new Date(maxDate);
                pEndDate.setDate(pEndDate.getDate() + 1);
                const tDays = Math.max(1, Math.ceil(Math.abs(pEndDate - pStartDate) / (1000 * 60 * 60 * 24)));
                const units = []; let currentDate = new Date(pStartDate);
                for (let i = 0; i < tDays; i++) {
                    units.push({ date: new Date(currentDate), label: currentDate.toLocaleDateString('en-US', { day: 'numeric', timeZone: 'UTC' }), monthLabel: i === 0 || currentDate.getDate() === 1 ? currentDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit', timeZone: 'UTC' }) : null, });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return { projectStartDate: pStartDate, totalDays: tDays, timelineUnits: units };
            }, [flattenedTasks]);
            if (!projectStartDate) return React.createElement("div", { className: "text-center text-gray-400 py-4" }, "Not enough data for Gantt chart.");
            const getBarColorClass = (status) => `gantt-bar-${String(status || 'Not Started').replace(/\s+/g, '-')}`;
            return (
                React.createElement("div", { id: GANTT_CHART_AREA_ID, className: "gantt-chart-container" },
                    React.createElement("div", { className: "gantt-timeline-header", style: { width: `${210 + totalDays * DAY_WIDTH}px` } },
                        timelineUnits.map((unit, index) => (
                            React.createElement("div", { key: index, className: "gantt-timeline-unit", style: { width: `${DAY_WIDTH}px` } },
                                unit.monthLabel && React.createElement("div", { style: { position: 'absolute', top: '-18px', left: `${index * DAY_WIDTH}px`, fontWeight: 'bold', fontSize: '0.65rem' } }, unit.monthLabel),
                                unit.label
                            )
                        ))
                    ),
                    flattenedTasks.map(task => {
                        if (!task.plannedStartDate || !task.plannedEndDate) return null;
                        const taskStartDate = new Date(task.plannedStartDate + 'T00:00:00Z');
                        const taskPlannedEndDate = new Date(task.plannedEndDate + 'T00:00:00Z');
                        if (isNaN(taskStartDate.getTime()) || isNaN(taskPlannedEndDate.getTime())) return null;
                        const startOffsetDays = Math.max(0, Math.ceil((taskStartDate - projectStartDate) / (1000 * 60 * 60 * 24)));
                        const plannedDurationDays = Math.max(1, Math.ceil((taskPlannedEndDate - taskStartDate) / (1000 * 60 * 60 * 24)) + 1);
                        const weatherDelay = task.delayWeatherDays || 0; const contractorDelay = task.delayContractorDays || 0; const clientDelay = task.delayClientDays || 0;
                        const plannedWidth = plannedDurationDays * DAY_WIDTH; const weatherDelayWidth = weatherDelay * DAY_WIDTH; const contractorDelayWidth = contractorDelay * DAY_WIDTH; const clientDelayWidth = clientDelay * DAY_WIDTH;
                        let mainBarWidth = plannedWidth;
                        const barSegments = [];
                        if (mainBarWidth > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-main`, className: `gantt-bar-segment ${getBarColorClass(task.status)} ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${mainBarWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'main'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Planned)`
                                }, task.wbs)
                            );
                        }
                        if (weatherDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-weather`, className: `gantt-bar-segment gantt-bar-delay-Weather ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${weatherDelayWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'Weather'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Weather Delay: ${weatherDelay}d)`
                                })
                            );
                        }
                        if (contractorDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-contractor`, className: `gantt-bar-segment gantt-bar-delay-contractor ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${contractorDelayWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'contractor'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Contractor Delay: ${contractorDelay}d)`
                                })
                            );
                        }
                        if (clientDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-client`, className: `gantt-bar-segment gantt-bar-delay-Client ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${clientDelayWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'Client'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Client Delay: ${clientDelay}d)`
                                })
                            );
                        }
                        return (
                            React.createElement("div", { key: task.id, className: "gantt-row" },
                                React.createElement("div", { className: "gantt-task-name-column", title: task.taskName }, task.taskName),
                                React.createElement("div", { className: "gantt-bars-area", style: { width: `${totalDays * DAY_WIDTH}px` } },
                                    React.createElement("div", { className: "flex absolute", style: { left: `${startOffsetDays * DAY_WIDTH}px`, top: '2.5px', height: '20px' } }, ...barSegments)
                                )
                            )
                        );
                    }).filter(Boolean),
                    tooltip.visible && React.createElement("div", { className: "gantt-tooltip", style: { top: `${tooltip.y}px`, left: `${tooltip.x}px` } }, tooltip.content)
                )
            );
        };
        const SimpleMarkdownRenderer = ({ text }) => {
            let html = '';
            let in_list = false;
            const lines = text.split('\n');
            const processInlineFormatting = (line) => {
                return line
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
            };
            for (const line of lines) {
                if (line.startsWith('* ') || line.startsWith('- ')) {
                    if (!in_list) {
                        html += '<ul>';
                        in_list = true;
                    }
                    html += `<li>${processInlineFormatting(line.substring(2))}</li>`;
                } else {
                    if (in_list) {
                        html += '</ul>';
                        in_list = false;
                    }
                    if (line.startsWith('### ')) {
                        html += `<h3>${processInlineFormatting(line.substring(4))}</h3>`;
                    } else if (line.trim() !== '') {
                        html += `<p>${processInlineFormatting(line)}</p>`;
                    }
                }
            }
            if (in_list) {
                html += '</ul>';
            }
            return React.createElement('div', { className: 'prose', dangerouslySetInnerHTML: { __html: html } });
        };
        // Retry mechanism for API calls
        const retryApiCall = async (apiCall, maxRetries = 3, baseDelay = 1000, onRetry = null) => {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await apiCall();
                    return response;
                } catch (error) {
                    console.error(`API call attempt ${attempt} failed:`, error);
                    
                    // Check if it's a retryable error (503, 502, 504, network errors)
                    const isRetryableError = error.message.includes('503') || 
                                           error.message.includes('502') || 
                                           error.message.includes('504') || 
                                           error.message.includes('network') ||
                                           error.message.includes('fetch') ||
                                           error.message.includes('timeout');
                    
                    if (attempt === maxRetries || !isRetryableError) {
                        throw error;
                    }
                    
                    // Show user-friendly message for retryable errors
                    if (attempt === 1) {
                        throw new Error("Hold on, there's a problem with the network. Retrying...");
                    }
                    
                    // Call retry callback if provided
                    if (onRetry) {
                        onRetry(attempt, maxRetries);
                    }
                    
                    // Exponential backoff delay
                    const delay = baseDelay * Math.pow(2, attempt - 1);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        const Chatbot = ({ projectTasks, projectName }) => {
            const { useState, useEffect, useRef } = React;
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isTranslating, setIsTranslating] = useState(false);
            const [retryStatus, setRetryStatus] = useState(null);
            const messagesEndRef = useRef(null);
            const typingIntervalRef = useRef(null);
            const [currentLanguage, setCurrentLanguage] = useState('English');
            const [uiTranslations, setUiTranslations] = useState({
                header: 'PROTON AI',
                placeholder: 'Ask about the project...',
                suggestions: 'Suggestions',
                critical_activities_query: 'What are Critical Activities?',
                progress_query: 'Overall Project Progress',
                risk_query: 'Risk Assessment & Mitigation Ideas',
            });
            const LANGUAGES = {
                'English': 'en', 'Japanese': 'ja', 'French': 'fr', 'Spanish': 'es', 'Russian': 'ru', 'Mandarin': 'zh', 'Korean': 'ko', 'Kannada': 'kn', 'Hindi': 'hi', 'Gujarati': 'gu', 'Marathi': 'mr', 'Odia': 'or', 'Telugu': 'te', 'Malayalam': 'ml', 'Tamil': 'ta', 'Bengali': 'bn'
            };
            const englishDefaults = {
                header: 'PROTON AI',
                placeholder: 'Ask about the project...',
                suggestions: 'Suggestions',
                critical_activities_query: 'What are Critical Activities?',
                progress_query: 'Overall Project Progress',
                risk_query: 'Risk Assessment & Mitigation Ideas',
                greeting_template: `Hi, how can I help you with the "${projectName}" project today?'`
            };
            const predefinedQueryKeys = ["critical_activities_query", "progress_query", "risk_query"];
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            useEffect(scrollToBottom, [messages]);
            useEffect(() => {
                return () => {
                    if (typingIntervalRef.current) {
                        clearInterval(typingIntervalRef.current);
                    }
                };
            }, []);
            useEffect(() => {
                if (!isOpen) return;
                setIsTranslating(true);
                const translateAndSetGreeting = async () => {
                    const targetLangCode = LANGUAGES[currentLanguage];
                    try {
                        let finalTranslations;
                        if (!targetLangCode || targetLangCode === 'en') {
                            finalTranslations = englishDefaults;
                        } else {
                            // Proactive check for AI prompt limits
                            const usage = window.latestUsageStats;
                            if (usage && usage.at_limit && usage.at_limit.ai_prompts) {
                                throw new Error('You have reached your weekly AI prompt limit.');
                            }
                            const response = await makeAuthenticatedRequest('/api/translate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    texts: englishDefaults,
                                    target_lang: targetLangCode
                                })
                            });
                            if (!response.ok) throw new Error(`Server error: ${response.status}`);
                            const data = await response.json();
                            if (data.status === 'success') {
                                finalTranslations = data.translations;
                            } else {
                                throw new Error(data.message);
                            }
                        }
                        setUiTranslations(finalTranslations);
                        const greeting = (finalTranslations.greeting_template || englishDefaults.greeting_template)
                            .replace('{projectName}', projectName || 'project');
                        setMessages([{ role: 'model', text: greeting }]);
                    } catch (error) {
                        console.error("Error fetching translations:", error);
                        setUiTranslations(englishDefaults);
                        const greeting = englishDefaults.greeting_template.replace('{projectName}', projectName || 'project');
                        setMessages([{ role: 'model', text: greeting }]);
                    } finally {
                        setIsTranslating(false);
                    }
                };
                translateAndSetGreeting();
            }, [currentLanguage, projectName, isOpen]);
            const sendQuery = async (queryText) => {
                if (!queryText.trim() || isLoading) return;
                if (typingIntervalRef.current) {
                    clearInterval(typingIntervalRef.current);
                }
                const userMessage = { role: 'user', text: queryText };
                setMessages(prev => [...prev, userMessage]);
                setInputValue('');
                setIsLoading(true);
                const summarizeTasksForAI = (tasksToSummarize) => {
                    let summarizedData = [];
                    const processTask = (task) => {
                        summarizedData.push({
                            wbs: task.wbs, name: task.taskName, status: task.status,
                            progress: task.progress, planned_start: task.plannedStartDate,
                            planned_end: task.plannedEndDate, is_critical: task.isCritical,
                            predecessors: task.predecessorString
                        });
                        if (task.subtasks) task.subtasks.forEach(processTask);
                    };
                    tasksToSummarize.forEach(processTask);
                    return JSON.stringify(summarizedData);
                };
                const projectContext = `
             You are a helpful project assistant for the "${projectName}" project.
            You must provide response in the "${currentLanguage}" language.
            The Response should have word limit of 100-150 words.
            Here is a summary of the current project tasks:
            ${summarizeTasksForAI(projectTasks)}
            ---
            INSTRUCTIONS:
            1. Format every response using simple Markdown headings, bold, bullets.
            2. NEVER mention the parameter names. For example, do not say "based on the data" or "the 'is_critical' parameter is true". Simply state the facts naturally.
            3. If it is not related to provided data, clearly state that but if the question is related to Project Management in general, you can use your general knowledge.`;
                const chatHistory = [
                    { role: "user", parts: [{ text: projectContext }] },
                    { role: "model", parts: [{ text: "Understood." }] },
                    ...[...messages, userMessage].map(msg => ({
                        role: msg.role,
                        parts: [{ text: msg.text }]
                    }))
                ];
                try {
                    const payload = { contents: chatHistory };
                    const apiKey = CHATBOT_GEMINI_API_KEY;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const result = await retryApiCall(async () => {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                        return await response.json();
                    }, 3, 1000, (attempt, maxRetries) => {
                        setRetryStatus(`Retrying... (${attempt}/${maxRetries})`);
                    });
                    
                    const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't process that.";
                    setIsLoading(false);
                    setMessages(prev => [...prev, { role: 'model', text: '' }]);
                    let charIndex = 0;
                    typingIntervalRef.current = setInterval(() => {
                        if (charIndex < modelResponse.length) {
                            setMessages(prev => {
                                const newMessages = [...prev];
                                const lastMessage = newMessages[newMessages.length - 1];
                                if (lastMessage && lastMessage.role === 'model') {
                                    lastMessage.text = modelResponse.substring(0, charIndex + 1);
                                }
                                return newMessages;
                            });
                            charIndex++;
                        } else {
                            clearInterval(typingIntervalRef.current);
                        }
                    }, 20);
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    setIsLoading(false);
                    setRetryStatus(null);
                    setMessages(prev => [...prev, { role: 'model', text: `Sorry, an error occurred: ${error.message}` }]);
                }
            };
            const handleSendMessage = (e) => {
                e.preventDefault();
                sendQuery(inputValue);
            };
            const LoadingPlaceholder = ({ className = 'w-24 h-4' }) => {
                return React.createElement('div', { className: `bg-slate-200 rounded pulse-bg ${className}` });
            };
            return React.createElement('div', { className: 'chatbot-container' },
                React.createElement('div', { className: `chat-window ${!isOpen ? 'closed' : ''}` },
                    React.createElement('div', { className: 'chat-header' },
                        React.createElement('span', null, isTranslating ? React.createElement(LoadingPlaceholder, { className: 'w-20 h-5' }) : uiTranslations.header),
                        React.createElement('select', {
                            value: currentLanguage,
                            onChange: (e) => setCurrentLanguage(e.target.value),
                            disabled: isTranslating,
                            className: 'bg-blue-800 text-white text-xs rounded p-1 focus:outline-none cursor-pointer disabled:opacity-50'
                        },
                            Object.keys(LANGUAGES).map(lang => React.createElement('option', { key: lang, value: lang }, lang))
                        ),
                        React.createElement('button', { onClick: () => setIsOpen(false) }, '×')
                    ),
                    React.createElement('div', { className: 'chat-messages' },
                        messages.map((msg, index) => {
                            if (index === 0 && isTranslating) {
                                return React.createElement('div', { key: 'translating-loader', className: 'chat-message model' },
                                    React.createElement(LoadingPlaceholder, { className: 'w-48 h-5' })
                                );
                            }
                            return React.createElement('div', { key: index, className: `chat-message ${msg.role}` },
                                msg.role === 'model' ? React.createElement(SimpleMarkdownRenderer, { text: msg.text }) : msg.text
                            );
                        }),
                        messages.length === 1 && !isLoading && !isTranslating && (
                            React.createElement('div', { className: 'flex flex-col items-center gap-2 p-2' },
                                React.createElement('p', { className: 'text-xs text-slate-500 mb-1' }, uiTranslations.suggestions),
                                predefinedQueryKeys.map(queryKey => (
                                    React.createElement('button', {
                                        key: queryKey,
                                        onClick: () => sendQuery(uiTranslations[queryKey]),
                                        className: 'w-full text-center px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200 transition-colors border border-slate-200'
                                    }, uiTranslations[queryKey])
                                ))
                            )
                        ),
                        isLoading && React.createElement('div', { className: 'chat-message model' },
                            React.createElement('div', { className: 'flex items-center gap-2' },
                                React.createElement('div', { className: 'w-2 h-2 bg-slate-400 rounded-full animate-pulse' }),
                                React.createElement('div', { className: 'w-2 h-2 bg-slate-400 rounded-full animate-pulse delay-75' }),
                                React.createElement('div', { className: 'w-2 h-2 bg-slate-400 rounded-full animate-pulse delay-150' })
                            ),
                            retryStatus && React.createElement('div', { className: 'text-sm text-amber-600 mt-2' }, retryStatus)
                        ),
                        React.createElement('div', { ref: messagesEndRef })
                    ),
                    React.createElement('form', { className: 'chat-input-form', onSubmit: handleSendMessage },
                        React.createElement('input', {
                            type: 'text',
                            placeholder: isTranslating ? 'Loading...' : uiTranslations.placeholder,
                            value: inputValue,
                            onChange: (e) => setInputValue(e.target.value),
                            disabled: isLoading || isTranslating
                        }),
                        React.createElement('button', { type: 'submit', disabled: isLoading || isTranslating || !inputValue.trim() },
                            React.createElement(SendIcon, { size: 16 })
                        )
                    )
                ),
                React.createElement('button', {
                    className: 'chatbot-toggle-button',
                    onClick: () => setIsOpen(prev => !prev)
                }, React.createElement(ChatIcon, { size: 28 }))
            );
        };
        const ApprovalDashboard = ({ pendingAdmins, onApprove, onReject, setNotification, setAppError }) => {
            const handleApproveClick = (email) => {
                makeAuthenticatedRequest('/api/approve_admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => { throw new Error(err.message || 'Approval failed') });
                        }
                        return res.json();
                    })
                    .then(data => {
                        onApprove(email);
                        setNotification({ message: data.message, type: 'success' });
                    })
                    .catch(err => setAppError(err.message));
            };
            const handleRejectClick = (email) => {
                if (window.confirm(`Are you sure you want to reject and delete the admin request for ${email}? This action cannot be undone.`)) {
                    makeAuthenticatedRequest('/api/reject_admin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    })
                        .then(res => {
                            if (!res.ok) {
                                return res.json().then(err => { throw new Error(err.message || 'Rejection failed') });
                            }
                            return res.json();
                        })
                        .then(data => {
                            onReject(email);
                            setNotification({ message: data.message, type: 'info' });
                        })
                        .catch(err => setAppError(err.message));
                }
            };
            if (!pendingAdmins || pendingAdmins.length === 0) {
                return null;
            }
            return React.createElement('div', { className: 'mb-6 p-4 bg-amber-100 border-l-4 border-amber-500 shadow rounded-lg' },
                React.createElement('h3', { className: 'text-lg font-semibold text-amber-800 mb-2 flex items-center' },
                    React.createElement(UserCheck, { size: 20, className: "mr-2" }),
                    'Pending Admin Approvals'
                ),
                React.createElement('ul', { className: 'space-y-2' },
                    pendingAdmins.map(admin => React.createElement('li', {
                        key: admin.email,
                        className: 'flex items-center justify-between bg-white p-2 rounded-md shadow-sm'
                    },
                        React.createElement('span', { className: 'text-sm text-slate-700' }, admin.email),
                        React.createElement('div', { className: 'flex items-center gap-2' },
                            React.createElement('button', {
                                onClick: () => handleRejectClick(admin.email),
                                className: 'px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-md hover:bg-red-600 transition-colors'
                            },
                                'Reject'
                            ),
                            React.createElement('button', {
                                onClick: () => handleApproveClick(admin.email),
                                className: 'px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-md hover:bg-green-600 transition-colors'
                            },
                                'Approve'
                            )
                        )
                    ))
                )
            );
        };

        const UserManagementModal = ({ onClose, loggedInUser, onUserCreated, onUserUpdated, onUserDeleted }) => {
            const { useState, useEffect } = React;
            const [users, setUsers] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [formData, setFormData] = useState({ email: '', password: '', role: 'org_user', status: 'approved' });
            const [error, setError] = useState('');
            const [orgAdminCount, setOrgAdminCount] = useState(0);

            // Role Badge Helper
            const getRoleBadge = (role) => {
                const badges = {
                    'super_admin': { label: 'Super Admin', color: 'bg-purple-100 text-purple-700' },
                    'org_admin': { label: 'Org Admin', color: 'bg-blue-100 text-blue-700' },
                    'org_user': { label: 'User', color: 'bg-green-100 text-green-700' },
                    'client': { label: 'Client', color: 'bg-slate-100 text-slate-700' }
                };
                
                const badge = badges[role] || badges['org_user'];
                
                return React.createElement('span', {
                    className: `px-2 py-1 text-xs font-semibold rounded-full ${badge.color}`
                }, badge.label);
            };

            // Centralized API error handler for 403
            const handleAPIError = (response, data) => {
                if (response && response.status === 403) {
                    const errorMsg = data?.message || 'You do not have permission to perform this action.';
                    setError(errorMsg);
                    // Special handling for org_admin limit error
                    if (errorMsg.includes('Maximum 2 org admins')) {
                        // Keep modal open so user can select different role
                    }
                    return true;
                }
                return false;
            };

            // Fetch users on component mount
            useEffect(() => {
                fetchUsers();
            }, []);

            const fetchUsers = async () => {
                setIsLoading(true);
                try {
                    const response = await makeAuthenticatedRequest('/api/org/users', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    if (handleAPIError(response, data)) return;
                    if (data.status === 'success') {
                        setUsers(data.users);
                        // Calculate org_admin count
                        const adminCount = data.users.filter(u => u.role === 'org_admin').length;
                        setOrgAdminCount(adminCount);
                    } else {
                        setError(data.message || 'Failed to fetch users');
                    }
                } catch (error) {
                    console.error('Error fetching users:', error);
                    setError('Failed to fetch users');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleCreateUser = async (formData) => {
                // Proactive check for admin limits
                const usage = window.latestUsageStats;
                if (usage && usage.at_limit && usage.at_limit.users) {
                    setError('You have reached the maximum number of team members for your plan.');
                    if (typeof window.refreshUsageStats === 'function') window.refreshUsageStats();
                    return;
                }
                try {
                    const response = await makeAuthenticatedRequest('/api/org/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    const data = await response.json();
                    if (handleAPIError(response, data)) return;
                    if (data.status === 'success') {
                        // fetchUsers() will recalculate orgAdminCount from database
                        fetchUsers();
                        setShowCreateForm(false);
                        setFormData({ email: '', password: '', role: 'org_user', status: 'approved' });
                        onUserCreated(data.user);
                    } else {
                        setError(data.message || 'Failed to create user');
                    }
                } catch (error) {
                    console.error('Error creating user:', error);
                    setError('Failed to create user');
                }
            };

            const handleUpdateUser = async (userId, formData) => {
                try {
                    const response = await makeAuthenticatedRequest(`/api/org/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    const data = await response.json();
                    if (handleAPIError(response, data)) return;
                    if (data.status === 'success') {
                        fetchUsers();
                        setEditingUser(null);
                        onUserUpdated(data.user);
                    } else {
                        setError(data.message || 'Failed to update user');
                    }
                } catch (error) {
                    console.error('Error updating user:', error);
                    setError('Failed to update user');
                }
            };

            const handleChangeRole = async (userId, newRole) => {
                // Find user to check current role
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                // Client-side validation: Check org_admin limit
                if (newRole === 'org_admin' && user.role !== 'org_admin' && loggedInUser.role !== 'super_admin' && orgAdminCount >= 2) {
                    setError('Maximum 2 org admins allowed. Please change an existing admin\'s role first.');
                    return;
                }
                
                try {
                    const response = await makeAuthenticatedRequest(`/api/org/users/${userId}/role`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: newRole })
                    });
                    const data = await response.json();
                    if (handleAPIError(response, data)) return;
                    if (data.status === 'success') {
                        // fetchUsers() will recalculate orgAdminCount from database
                        fetchUsers();
                        setError('');
                    } else {
                        setError(data.message || 'Failed to change role');
                    }
                } catch (error) {
                    console.error('Error changing role:', error);
                    setError('Failed to change role');
                }
            };

            const handleDeleteUser = async (userId) => {
                if (!confirm('Are you sure you want to delete this user?')) return;
                
                // Find user to check role before deletion
                const user = users.find(u => u.id === userId);
                const wasOrgAdmin = user && user.role === 'org_admin';
                
                try {
                    const response = await makeAuthenticatedRequest(`/api/org/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    if (handleAPIError(response, data)) return;
                    if (data.status === 'success') {
                        // fetchUsers() will recalculate orgAdminCount from database
                        fetchUsers();
                        onUserDeleted(userId);
                    } else {
                        setError(data.message || 'Failed to delete user');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    setError('Failed to delete user');
                }
            };

            const resetForm = () => {
                setFormData({ email: '', password: '', role: 'org_user', status: 'approved' });
                setError('');
            };

            return React.createElement('div', {
                className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4'
            },
                React.createElement('div', {
                    className: 'bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden'
                },
                    // Header
                    React.createElement('div', {
                        className: 'flex items-center justify-between p-6 border-b border-gray-200'
                    },
                        React.createElement('h2', {
                            className: 'text-xl font-semibold text-gray-900'
                        }, 'User Management'),
                        React.createElement('div', {
                            className: 'flex items-center space-x-2'
                        },
                            React.createElement('span', {
                                className: `text-sm px-2 py-1 rounded ${orgAdminCount < 2 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`
                            }, `Org Admins: ${orgAdminCount}/2`),
                            canManageUsers(loggedInUser.role) && React.createElement('button', {
                                onClick: () => { setShowCreateForm(true); resetForm(); },
                                className: 'px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors'
                            }, 'Add User'),
                            React.createElement('button', {
                                onClick: onClose,
                                className: 'p-2 text-gray-400 hover:text-gray-600 transition-colors'
                            }, React.createElement(X, { size: 20 }))
                        )
                    ),
                    
                    // Content
                    React.createElement('div', {
                        className: 'p-6 overflow-y-auto max-h-[calc(90vh-140px)]'
                    },
                        error && React.createElement('div', {
                            className: 'mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm'
                        }, error),
                        
                        // Users Table
                        React.createElement('div', {
                            className: 'overflow-x-auto'
                        },
                            React.createElement('table', {
                                className: 'min-w-full divide-y divide-gray-200'
                            },
                                React.createElement('thead', {
                                    className: 'bg-gray-50'
                                },
                                    React.createElement('tr', null,
                                        React.createElement('th', {
                                            className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
                                        }, 'Email'),
                                        React.createElement('th', {
                                            className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
                                        }, 'Role'),
                                        React.createElement('th', {
                                            className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
                                        }, 'Status'),
                                        React.createElement('th', {
                                            className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
                                        }, 'Created'),
                                        isSuperAdmin(loggedInUser.role) && React.createElement('th', {
                                            className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
                                        }, 'Organization'),
                                        React.createElement('th', {
                                            className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
                                        }, 'Actions')
                                    )
                                ),
                                React.createElement('tbody', {
                                    className: 'bg-white divide-y divide-gray-200'
                                },
                                    isLoading ? React.createElement('tr', null,
                                        React.createElement('td', {
                                            colSpan: isSuperAdmin(loggedInUser.role) ? 6 : 5,
                                            className: 'px-6 py-4 text-center text-gray-500'
                                        }, 'Loading users...')
                                    ) : users.map(user => React.createElement('tr', {
                                        key: user.id,
                                        className: 'hover:bg-gray-50'
                                    },
                                        React.createElement('td', {
                                            className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900'
                                        }, user.email),
                                        React.createElement('td', {
                                            className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500'
                                        }, getRoleBadge(user.role)),
                                        React.createElement('td', {
                                            className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500'
                                        }, user.status),
                                        React.createElement('td', {
                                            className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500'
                                        }, new Date(user.created_at).toLocaleDateString()),
                                        isSuperAdmin(loggedInUser.role) && React.createElement('td', {
                                            className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500'
                                        }, user.org_id),
                                        React.createElement('td', {
                                            className: 'px-6 py-4 whitespace-nowrap text-sm font-medium'
                                        },
                                            React.createElement('div', {
                                                className: 'flex items-center space-x-2'
                                            },
                                                canManageUsers(loggedInUser.role) && user.role !== 'super_admin' && user.id !== loggedInUser.id && React.createElement('button', {
                                                    onClick: () => handleChangeRole(user.id, user.role === 'org_admin' ? 'org_user' : 'org_admin'),
                                                    className: 'text-blue-600 hover:text-blue-900 text-xs'
                                                }, user.role === 'org_admin' ? 'Demote' : 'Promote'),
                                                canManageUsers(loggedInUser.role) && user.role !== 'super_admin' && user.id !== loggedInUser.id && React.createElement('button', {
                                                    onClick: () => handleDeleteUser(user.id),
                                                    className: 'text-red-600 hover:text-red-900 text-xs'
                                                }, 'Delete')
                                            )
                                        )
                                    ))
                                )
                            )
                        ),
                        
                        // Create/Edit Form
                        (showCreateForm || editingUser) && React.createElement('div', {
                            className: 'mt-6 p-4 bg-gray-50 rounded-lg'
                        },
                            React.createElement('h3', {
                                className: 'text-lg font-medium text-gray-900 mb-4'
                            }, editingUser ? 'Edit User' : 'Create New User'),
                            
                            React.createElement('div', {
                                className: 'grid grid-cols-1 md:grid-cols-2 gap-4'
                            },
                                React.createElement('div', null,
                                    React.createElement('label', {
                                        className: 'block text-sm font-medium text-gray-700 mb-1'
                                    }, 'Email'),
                                    React.createElement('input', {
                                        type: 'email',
                                        value: formData.email,
                                        onChange: (e) => setFormData({ ...formData, email: e.target.value }),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                        placeholder: 'user@example.com'
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', {
                                        className: 'block text-sm font-medium text-gray-700 mb-1'
                                    }, 'Password'),
                                    React.createElement('input', {
                                        type: 'password',
                                        value: formData.password,
                                        onChange: (e) => setFormData({ ...formData, password: e.target.value }),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                        placeholder: 'Enter password'
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', {
                                        className: 'block text-sm font-medium text-gray-700 mb-1'
                                    }, 
                                        'Role',
                                        React.createElement('span', {
                                            className: 'ml-2 text-xs text-gray-500'
                                        }, `Org Admins: ${orgAdminCount}/2`)
                                    ),
                                    React.createElement('select', {
                                        value: formData.role,
                                        onChange: (e) => setFormData({ ...formData, role: e.target.value }),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500'
                                    },
                                        React.createElement('option', { value: 'org_user' }, 'Org User'),
                                        React.createElement('option', {
                                            value: 'org_admin',
                                            disabled: orgAdminCount >= 2 && loggedInUser.role !== 'super_admin' && (!editingUser || editingUser.role !== 'org_admin')
                                        }, orgAdminCount >= 2 && loggedInUser.role !== 'super_admin' && (!editingUser || editingUser.role !== 'org_admin') ? 'Org Admin (Limit Reached)' : 'Org Admin')
                                    ),
                                    (orgAdminCount >= 2 && loggedInUser.role !== 'super_admin' && (!editingUser || editingUser.role !== 'org_admin')) && React.createElement('div', {
                                        className: 'mt-1 text-sm text-yellow-600'
                                    }, '⚠️ Maximum 2 org admins allowed. Please change an existing admin\'s role to org_user before adding new admins.')
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', {
                                        className: 'block text-sm font-medium text-gray-700 mb-1'
                                    }, 'Status'),
                                    React.createElement('select', {
                                        value: formData.status,
                                        onChange: (e) => setFormData({ ...formData, status: e.target.value }),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500'
                                    },
                                        React.createElement('option', { value: 'approved' }, 'Approved'),
                                        React.createElement('option', { value: 'suspended' }, 'Suspended'),
                                        React.createElement('option', { value: 'pending' }, 'Pending')
                                    )
                                )
                            ),
                            
                            React.createElement('div', {
                                className: 'flex items-center justify-end space-x-3 mt-4'
                            },
                                React.createElement('button', {
                                    onClick: () => { setShowCreateForm(false); setEditingUser(null); resetForm(); },
                                    className: 'px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors'
                                }, 'Cancel'),
                                React.createElement('button', {
                                    onClick: () => editingUser ? handleUpdateUser(editingUser.id, formData) : handleCreateUser(formData),
                                    className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                                }, editingUser ? 'Update User' : 'Create User')
                            )
                        )
                    )
                )
            );
        };

        const CSVImportModal = ({ onClose, onImport, selectedProject, loggedInUser }) => {
            const { useState, useRef } = React;
            const [isUploading, setIsUploading] = useState(false);
            const fileInputRef = useRef(null);

            const generateSampleCSV = () => {
                const sampleData = [
                    ['WBS', 'Name', 'Duration', 'Start_Date', 'Finish_Date', 'Predecessors', 'Weightage', 'Actual_Start_Date', 'Actual_End_Date', 'Progress', 'Status', 'Is_Critical', 'Notes'],
                    ['1', 'Project Root', '100', '01-01-2024', '31-12-2024', '', '100', '', '', '25', 'In Progress', 'Yes', 'Main project task'],
                    ['1.1', 'Engineering Phase', '60', '01-01-2024', '28-02-2024', '', '30', '01-01-2024', '', '80', 'In Progress', 'Yes', 'Design and engineering work'],
                    ['1.1.1', 'Detailed Design', '30', '01-01-2024', '31-01-2024', '', '15', '01-01-2024', '29-01-2024', '100', 'Completed', 'Yes', 'Completed ahead of schedule'],
                    ['1.1.2', 'Technical Review', '15', '01-02-2024', '15-02-2024', '1.1.1', '10', '01-02-2024', '', '60', 'In Progress', 'No', 'Review in progress'],
                    ['1.2', 'Procurement', '45', '15-02-2024', '31-03-2024', '1.1', '25', '', '', '0', 'Not Started', 'No', 'Awaiting engineering completion'],
                    ['1.3', 'Construction', '120', '01-04-2024', '31-07-2024', '1.2', '45', '', '', '0', 'Not Started', 'Yes', 'Critical path activity']
                ];
                
                const csvContent = sampleData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'sample_project_template.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            /**
             * Handle CSV file upload for task import
             * 
             * @param {Event} event - File input change event
             * 
             * Process:
             * 1. Extract file from input
             * 2. Create FormData with file and user email
             * 3. Upload to /api/upload?project=<encoded_project_name>
             * 4. Parse response and import tasks on success
             * 
             * Note: Project name is URL-encoded using encodeURIComponent() to handle
             *       special characters, spaces, and international characters safely.
             * 
             * API Endpoint: POST /api/upload?project=<project_name>
             * Request Body: FormData with 'file' and 'user_email' fields
             * Response: { status: 'uploaded', rows: [...] } on success
             */
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                setIsUploading(true);
                const formData = new FormData();
                formData.append('file', file);
                formData.append('user_email', loggedInUser?.email || 'Unknown User');
                
                try {
                    // Upload CSV file to server
                    // URL is relative and will be resolved against window.location.origin
                    // Project name is URL-encoded to handle special characters
                    const response = await makeAuthenticatedRequest(`/api/upload?project=${encodeURIComponent(selectedProject)}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.status === 'uploaded') {
                        onImport(data.rows);
                        onClose();
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    alert(`Upload failed: ${error.message}`);
                } finally {
                    setIsUploading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            return React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4' },
                React.createElement('div', { className: 'bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto' },
                    React.createElement('div', { className: 'p-6 border-b border-slate-200' },
                        React.createElement('div', { className: 'flex items-center justify-between' },
                            React.createElement('h2', { className: 'text-2xl font-bold text-slate-800 flex items-center' },
                                React.createElement(UploadCloud, { size: 24, className: 'mr-3 text-blue-600' }),
                                'Import CSV File'
                            ),
                            React.createElement('button', { 
                                onClick: onClose,
                                className: 'text-slate-400 hover:text-slate-600 transition-colors'
                            }, React.createElement(X, { size: 24 }))
                        )
                    ),
                    React.createElement('div', { className: 'p-6 space-y-6' },
                        React.createElement('div', { className: 'bg-blue-50 border border-blue-200 rounded-lg p-4' },
                            React.createElement('h3', { className: 'text-lg font-semibold text-blue-800 mb-3' }, 'CSV Format Requirements'),
                            React.createElement('div', { className: 'space-y-2 text-sm text-blue-700' },
                                React.createElement('p', null, '• Date format must be: ', React.createElement('strong', null, 'DD-MM-YYYY'), ' (e.g., 15-03-2024)'),
                                React.createElement('p', null, '• Required columns: WBS, Name, Duration, Start_Date, Finish_Date'),
                                React.createElement('p', null, '• Optional columns: Predecessors, Weightage, Actual_Start_Date, Actual_End_Date, Progress, Status, Is_Critical, Notes'),
                                React.createElement('p', null, '• WBS should follow hierarchical numbering (1, 1.1, 1.1.1, etc.)')
                            )
                        ),
                        React.createElement('div', { className: 'text-center' },
                            React.createElement('button', {
                                onClick: generateSampleCSV,
                                className: 'inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium'
                            },
                                React.createElement(DownloadCloud, { size: 18, className: 'mr-2' }),
                                'Download Sample CSV Template'
                            )
                        ),
                        React.createElement('div', { className: 'border-2 border-dashed border-slate-300 rounded-lg p-8 text-center' },
                            React.createElement('input', {
                                ref: fileInputRef,
                                type: 'file',
                                accept: '.csv',
                                onChange: handleFileUpload,
                                className: 'hidden'
                            }),
                            React.createElement('div', { className: 'space-y-4' },
                                React.createElement(UploadCloud, { size: 48, className: 'mx-auto text-slate-400' }),
                                React.createElement('div', null,
                                    React.createElement('button', {
                                        onClick: () => fileInputRef.current?.click(),
                                        disabled: isUploading,
                                        className: 'inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed'
                                    },
                                        isUploading ? 'Uploading...' : 'Select CSV File to Import'
                                    )
                                ),
                                React.createElement('p', { className: 'text-sm text-slate-500 mt-2' }, 'Choose a CSV file')
                            )
                        )
                    ),
                    React.createElement('div', { className: 'p-6 border-t border-slate-200 bg-slate-50 rounded-b-xl' },
                        React.createElement('div', { className: 'flex justify-end space-x-3' },
                            React.createElement('button', {
                                onClick: onClose,
                                className: 'px-4 py-2 text-slate-600 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors font-medium'
                            }, 'Cancel')
                        )
                    )
                )
            );
        };

        const ActivityLogModal = ({ onClose }) => {
            const { useState, useEffect, useRef } = React;
            const [logs, setLogs] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const modalContentRef = useRef(null);
            useEffect(() => {
                makeAuthenticatedRequest('/api/activity_log', { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                    .then(res => res.json())
                    .then(data => setLogs(data))
                    .catch(err => console.error("Failed to fetch activity log:", err))
                    .finally(() => setIsLoading(false));
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);
            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" },
                    React.createElement("div", { className: "flex justify-between items-center mb-4 text-blue-600 border-b pb-2" },
                        React.createElement("h2", { className: "text-xl font-semibold flex items-center" },
                            React.createElement(HistoryIcon, { size: 20, className: "mr-2" }),
                            "Admin Activity Log"
                        ),
                        React.createElement("button", {
                            onClick: async () => {
                                try {
                                    const response = await makeAuthenticatedRequest('/api/activity_log/download', { 
                                        method: 'GET',
                                        headers: { 'Content-Type': 'application/json' }
                                    });
                                    const blob = await response.blob();
                                    const url = window.URL.createObjectURL(blob);
                                    const link = document.createElement('a');
                                    link.href = url;
                                    link.download = 'activity_log.csv';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    window.URL.revokeObjectURL(url);
                                } catch (error) {
                                    alert('Failed to download activity log: ' + error.message);
                                }
                            },
                            className: "px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md flex items-center"
                        },
                            React.createElement("svg", { className: "w-4 h-4 mr-1", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24" },
                                React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" })
                            ),
                            "Download CSV"
                        )
                    ),
                    React.createElement("div", { className: "flex-grow overflow-y-auto" },
                        React.createElement("p", { className: "text-sm text-slate-500 mb-2 italic" }, "Showing latest 100 entries. Use 'Download CSV' for complete log."),
                        isLoading ? React.createElement("p", null, "Loading logs...") :
                            React.createElement("table", { className: "min-w-full divide-y divide-slate-200" },
                                React.createElement("thead", { className: "bg-slate-50 sticky top-0" }, React.createElement("tr", null,
                                    React.createElement("th", { className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase" }, "Timestamp"),
                                    React.createElement("th", { className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase" }, "User"),
                                    React.createElement("th", { className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase" }, "Project"),
                                    React.createElement("th", { className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase" }, "Action"),
                                    React.createElement("th", { className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase" }, "Details"),
                                )),
                                React.createElement("tbody", { className: "bg-white divide-y divide-slate-200" },
                                    logs.map((log, index) => React.createElement("tr", { key: index, className: "hover:bg-slate-50" },
                                        React.createElement("td", { className: "px-3 py-2 whitespace-nowrap text-xs text-slate-500" }, new Date(log.timestamp).toLocaleString()),
                                        React.createElement("td", { className: "px-3 py-2 whitespace-nowrap text-sm text-slate-800" }, log.user),
                                        React.createElement("td", { className: "px-3 py-2 whitespace-nowrap text-sm text-slate-600" }, log.project || 'N/A'),
                                        React.createElement("td", { className: "px-3 py-2 whitespace-nowrap text-sm text-slate-600" }, log.action),
                                        React.createElement("td", { className: "px-3 py-2 text-sm text-slate-600" }, log.details)
                                    ))
                                )
                            )
                    ),
                    React.createElement("div", { className: "flex justify-end pt-6 mt-auto border-t" },
                        React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close")
                    )
                )
            );
        };
        const TaskDetailsModal = ({ task, onClose, loggedInUserType }) => {
            const { useEffect, useRef } = React;
            const modalContentRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);

            // Filter for notes that have a string in the 'text' property to avoid rendering errors
            const validNotes = Array.isArray(task.notes) ? task.notes.filter(n => typeof n.text === 'string' && n.text) : [];

            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col" },
                    React.createElement("h2", { className: "text-xl font-semibold mb-4 text-blue-600 border-b pb-2" }, "Details for: ", React.createElement("span", { className: "font-bold" }, task.taskName)),
                    React.createElement("div", { className: "space-y-4 overflow-y-auto" },
                        // Details Section
                        React.createElement("div", null,
                            React.createElement("h3", { className: "font-semibold text-slate-700 mb-2" }, "Key Info"),
                            React.createElement("div", { className: "text-sm space-y-1" },
                                React.createElement("p", { className: "text-slate-600" }, "Predecessors: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.predecessorString || 'None')),
                                React.createElement("p", { className: "text-slate-600" }, "Weather Delay: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.delayWeatherDays || 0, " days")),
                                React.createElement("p", { className: "text-slate-600" }, "Contractor Delay: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.delayContractorDays || 0, " days")),
                                React.createElement("p", { className: "text-slate-600" }, "Client Delay: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.delayClientDays || 0, " days"))
                            )
                        ),
                        // Notes Section (Conditional)
                        loggedInUserType !== 'client' && React.createElement("div", null,
                            React.createElement("h3", { className: "font-semibold text-slate-700 mb-2" }, "Notes"),
                            validNotes.length > 0 ?
                                React.createElement("ul", { className: "list-none space-y-2 max-h-48 overflow-y-auto pr-2" },
                                    validNotes.map((note, index) =>
                                        React.createElement("li", { key: index, className: "text-xs bg-slate-50 p-2 rounded-md border border-slate-200" },
                                            React.createElement("span", { className: "block font-medium text-slate-500" }, `[${new Date(note.timestamp).toLocaleString()}] [${note.source}]`),
                                            React.createElement("p", { className: "text-slate-800 mt-1 whitespace-pre-wrap" }, note.text)
                                        )
                                    )
                                ) : React.createElement("p", { className: "italic text-sm text-slate-500" }, "No valid notes for this task.")
                        )
                    ),
                    React.createElement("div", { className: "flex justify-end pt-6 mt-auto" },
                        React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close")
                    )
                )
            );
        };

        const TaskTable = ({ tasks, viewType, loggedInUserType, sortBy, onSort, areAllExpanded, onToggleAllExpansion, hasMoreTasks, isLoadingMore, loadMoreTasks, isTrialExpired, ...props }) => {
            const { useMemo } = React;

            const commonHeaders = [{ key: 'wbs', label: 'WBS' }, { key: 'taskName', label: 'Task Name / Deliverable' }, { key: 'plannedStartDate', label: 'Planned Start' }, { key: 'plannedEndDate', label: 'Planned End' }, { key: 'status', label: 'Status' }, { key: 'progress', label: 'Progress' },];
            let headers = (loggedInUserType !== 'client' && viewType === 'admin') ? [...commonHeaders, { key: 'actualStartDate', label: 'Actual Start' }, { key: 'actualEndDate', label: 'Actual End' }, { key: 'isCritical', label: 'Critical?' }, { key: 'delayWeatherDays', label: 'Weather Delay' }, { key: 'delayContractorDays', label: 'Ctr. Delay' }, { key: 'delayClientDays', label: 'Client Delay' }, { key: 'isClientDeliverable', label: 'Client View?' }, { key: 'clientComm', label: 'Client Comm.' }, { key: 'actions', label: 'Actions' }] : [...commonHeaders, { key: 'actualStartDate', label: 'Actual Start' }, { key: 'actualEndDate', label: 'Actual End' }, { key: 'isCritical', label: 'Critical' }, { key: 'delayWeatherDays', label: 'Weather Delay' }, { key: 'delayContractorDays', label: 'Ctr. Delay' }, { key: 'delayClientDays', label: 'Client Delay' }, { key: 'clientComm', label: 'Actions' }];

            const areAllClientDeliverablesSelected = useMemo(() => {
                let allDeliverables = true;
                const checkTasks = (taskList) => {
                    if (!taskList) return;
                    for (const task of taskList) {
                        if (!task.isClientDeliverable) {
                            allDeliverables = false;
                            return;
                        }
                        if (task.subtasks) checkTasks(task.subtasks);
                    }
                };
                checkTasks(tasks);
                return tasks.length > 0 && allDeliverables;
            }, [tasks]);

            return (React.createElement("div", { className: "overflow-x-auto bg-white shadow-xl rounded-xl" },
                React.createElement("table", { className: "min-w-full divide-y divide-slate-200 border-collapse" },
                    React.createElement("thead", { className: "bg-slate-50" },
                        React.createElement("tr", null, headers.map((header, index) => {
                            const isWBS = header.key === 'wbs';
                            // --- Removed sticky classes ---
                            const headerClasses = `px-4 py-3.5 text-left text-sm font-semibold text-slate-700 bg-slate-50 ${isWBS ? 'cursor-pointer hover:bg-slate-200' : ''}`;

                            return React.createElement("th", {
                                key: header.key,
                                scope: "col",
                                className: headerClasses,
                                onClick: isWBS ? onToggleAllExpansion : undefined,
                                title: isWBS ? (areAllExpanded ? 'Collapse All Tasks' : 'Expand All Tasks') : undefined
                            },
                                React.createElement("div", { className: "flex items-center" },
                                    isWBS && (areAllExpanded ? React.createElement(ChevronUp, { className: "inline mr-1 h-4 w-4 text-sky-600" }) : React.createElement(ChevronDown, { className: "inline mr-1 h-4 w-4 text-sky-600" })),
                                    header.key === 'isClientDeliverable' && viewType === 'admin' ?
                                        React.createElement(React.Fragment, null,
                                            React.createElement("input", {
                                                type: "checkbox",
                                                className: "h-4 w-4 rounded text-sky-600 border-slate-300 focus:ring-sky-500 mr-2",
                                                checked: areAllClientDeliverablesSelected,
                                                onChange: () => props.onToggleAllClientDeliverables(!areAllClientDeliverablesSelected),
                                                title: areAllClientDeliverablesSelected ? "Deselect All" : "Select All"
                                            }),
                                            header.label
                                        ) : header.label
                                ));
                        }))
                    ),
                    React.createElement("tbody", { className: "divide-y divide-slate-200 bg-white" }, tasks.map(task => (
                        React.createElement(TaskRow, {
                            key: task.id,
                            task: task,
                            viewType: viewType,
                            loggedInUserType: loggedInUserType,
                            level: 0,
                            isTrialExpired: isTrialExpired,
                            ...props
                        })
                    )))
                ),
                // Load More Section
                hasMoreTasks && React.createElement("div", { className: "border-t border-slate-200 bg-slate-50 p-4 text-center" },
                    isLoadingMore ?
                        React.createElement("div", { className: "flex items-center justify-center space-x-2" },
                            React.createElement("div", { className: "animate-spin rounded-full h-4 w-4 border-b-2 border-sky-600" }),
                            React.createElement("span", { className: "text-sm text-slate-600" }, "Loading more tasks...")
                        ) :
                        React.createElement("button", {
                            onClick: loadMoreTasks,
                            className: "px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white text-sm rounded-md transition-colors"
                        }, "Load More Tasks")
                )
            ));
        };

        // --- Role-Based UI Helper Functions (defined before TaskRow for scope access) ---
        const canManageUsers = (role) => ['super_admin', 'org_admin'].includes(role);
        const canManageProjects = (role) => ['super_admin', 'org_admin'].includes(role);
        const canViewActivityLogs = (role) => ['super_admin', 'org_admin'].includes(role);
        const canApproveAdmins = (role) => role === 'super_admin';
        const isSuperAdmin = (role) => role === 'super_admin';
        const isOrgAdmin = (role) => role === 'org_admin';
        const isOrgUser = (role) => role === 'org_user';
        const canEditTask = (role) => ['super_admin', 'org_admin', 'org_user'].includes(role);

        const TaskRow = ({ task, viewType, loggedInUserType, onUpdateTask, onEditTask, onAIUpdate, onShowNotes, onShowDetails, onClientComm, onToggleClientDeliverable, onToggleExpansion, onAddTask, onAddSubTask, onDeleteTask, level, isTrialExpired }) => {
            const renderStatusPill = (status) => { const baseClasses = "px-2 py-1 text-xs font-semibold rounded-full"; const colorClasses = { 'Not Started': 'bg-slate-200 text-slate-700', 'In Progress': 'bg-blue-100 text-blue-700', 'Completed': 'bg-green-100 text-green-700', 'Delayed': 'bg-red-100 text-red-700', 'On Hold': 'bg-yellow-100 text-yellow-700', 'Ahead of Schedule': 'bg-sky-100 text-sky-700' }; return React.createElement("span", { className: `${baseClasses} ${colorClasses[status] || 'bg-slate-200 text-slate-700'}` }, status || 'Not Started'); };
            const handleCriticalToggle = () => { if (loggedInUserType !== 'client') { onUpdateTask(task.id, { isCritical: !task.isCritical }); } };
            const latestClientComment = task.clientComments && task.clientComments.length > 0 ? task.clientComments[task.clientComments.length - 1] : null;

            const isPendingForClient = task.clientComments && task.clientComments.some(c => !c.clientStatus);
            const isPendingForAdmin = task.clientComments && task.clientComments.some(c => c.clientStatus && c.adminSeen === false);

            const hasSubtasks = task.subtasks && task.subtasks.length > 0;
            const indentStyle = { paddingLeft: `${1 + (level * 1.5)}rem` };

            let actionButtons = [];
            if (canEditTask(loggedInUserType) && viewType === 'admin') {
                const disabledClass = isTrialExpired ? 'opacity-50 cursor-not-allowed' : '';
                const disabledTitle = isTrialExpired ? 'Trial expired. Upgrade to continue.' : undefined;
                actionButtons = [
                    React.createElement("button", { key: "addSub", onClick: () => onAddSubTask(task), disabled: isTrialExpired, title: disabledTitle || "Add Sub-task", className: `text-sky-500 hover:text-sky-600 ${disabledClass}` }, React.createElement(CornerDownRight, { size: 18 })),
                    React.createElement("button", { key: "add", onClick: () => onAddTask(task), disabled: isTrialExpired, title: disabledTitle || "Add Task Below", className: `text-green-500 hover:text-green-600 ${disabledClass}` }, React.createElement(PlusCircle, { size: 18 })),
                    React.createElement("button", { key: "edit", onClick: () => onEditTask(task), disabled: isTrialExpired, title: disabledTitle || "Edit Task", className: `text-yellow-500 hover:text-yellow-600 ${disabledClass}` }, React.createElement(Edit3, { size: 18 })),
                    React.createElement("button", { key: "ai", onClick: () => onAIUpdate(task), disabled: isTrialExpired, title: disabledTitle || "AI Update & Risk Assessment", className: `text-purple-500 hover:text-purple-600 ${disabledClass}` }, React.createElement(Zap, { size: 18 })),
                    React.createElement("button", { key: "notes", onClick: () => onShowNotes(task), disabled: isTrialExpired, title: disabledTitle || "View/Add Notes", className: `text-blue-500 hover:text-blue-600 ${disabledClass}` }, React.createElement(MessageSquareIcon, { size: 18 }))
                ];
                
                // Only SuperAdmin and Org Admin can delete tasks
                if (canManageProjects(loggedInUserType)) {
                    actionButtons.push(
                        React.createElement("button", { key: "delete", onClick: () => onDeleteTask(task.id), disabled: isTrialExpired, title: disabledTitle || "Delete Task", className: `text-red-500 hover:text-red-600 ${disabledClass}` }, React.createElement(Trash2, { size: 18 }))
                    );
                }
            }

            const isDelayed = task.status === 'Delayed' || (task.delayWeatherDays || 0) > 0 || (task.delayContractorDays || 0) > 0 || (task.delayClientDays || 0) > 0;

            let rowClasses = ['transition-colors', 'duration-150'];
            if (hasSubtasks) { rowClasses.push('font-bold'); }
            if (task.isCritical) { rowClasses.push('bg-red-50'); }


            return (
                React.createElement(React.Fragment, null,
                    React.createElement("tr", { id: `wbs-${task.wbs}`, className: rowClasses.join(' ') },
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } },
                            React.createElement("span", { style: indentStyle }, task.wbs)
                        ),
                        React.createElement("td", { className: `px-4 py-3 text-sm w-[300px] max-w-[300px] ${hasSubtasks ? 'text-slate-900' : 'text-slate-800'}`, style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } },
                            hasSubtasks && (
                                React.createElement("button", {
                                    onClick: () => onToggleExpansion(task.id),
                                    className: "mr-1 text-xs text-sky-600 hover:text-sky-700 align-middle"
                                }, task.isExpanded ? React.createElement(ChevronUp, { size: 16, className: "inline" }) : React.createElement(ChevronDown, { size: 16, className: "inline" }))
                            ),
                            task.isCritical && React.createElement(AlertTriangle, { size: 14, className: "inline mr-1 text-red-500" }),
                            React.createElement("span", null, task.taskName),
                            React.createElement("button", { onClick: () => onShowDetails(task), className: "ml-2 text-slate-400 hover:text-blue-500 align-middle", title: "View Details" }, React.createElement(InfoIcon, { size: 14 }))
                        ),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, formatDateForDisplay(task.plannedStartDate)),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, formatDateForDisplay(task.plannedEndDate)),
                        React.createElement("td", { className: "px-4 py-3 text-sm whitespace-nowrap w-[140px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, renderStatusPill(task.status)),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, React.createElement("div", { className: "w-full bg-slate-200 rounded-full h-2.5" }, React.createElement("div", { className: "bg-blue-500 h-2.5 rounded-full", style: { width: `${task.progress || 0}%` } })), React.createElement("span", { className: "text-xs ml-1" }, task.progress || 0, "%")),
                        loggedInUserType !== 'client' && viewType === 'admin' && (React.createElement(React.Fragment, null,
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, formatDateForDisplay(task.actualStartDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, formatDateForDisplay(task.actualEndDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-center cursor-pointer hover:bg-slate-100 w-[80px]", onClick: handleCriticalToggle, title: "Toggle Critical Status", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.isCritical ? React.createElement(CheckCircle, { size: 18, className: "text-red-500" }) : React.createElement("span", { className: "text-slate-400" }, "-")),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center w-[100px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.delayWeatherDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center w-[100px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.delayContractorDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center w-[100px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.delayClientDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, React.createElement("input", { type: "checkbox", className: "h-5 w-5 rounded text-sky-600 border-slate-300 focus:ring-sky-500 cursor-pointer", checked: !!task.isClientDeliverable, onChange: (e) => onToggleClientDeliverable(task, e.target.checked) })),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } },
                                React.createElement("button", { onClick: () => onClientComm(task), className: "relative text-blue-500 hover:text-blue-600 text-xs p-1 rounded hover:bg-blue-50 flex items-center" },
                                    React.createElement(MessageSquareIcon, { size: 16, className: "mr-1" }), "Comm ",
                                    isPendingForAdmin && React.createElement("span", { className: "absolute -top-1 -right-1 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white" })
                                )
                            ),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap space-x-2 w-[200px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, ...actionButtons)
                        )),
                        (loggedInUserType === 'client' || viewType === 'client') && (React.createElement(React.Fragment, null,
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, formatDateForDisplay(task.actualStartDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[120px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, formatDateForDisplay(task.actualEndDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-center w-[80px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.isCritical ? React.createElement(CheckCircle, { size: 18, className: "text-red-500" }) : React.createElement("span", { className: "text-slate-400" }, "-")),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center w-[100px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.delayWeatherDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center w-[100px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.delayContractorDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center w-[100px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } }, task.delayClientDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap w-[150px]", style: { backgroundColor: task.isCritical ? '#fef2f2' : '#ffffff' } },
                                React.createElement("div", { className: "flex items-center space-x-2" },
                                    React.createElement("button", { onClick: () => onClientComm(task), className: "relative text-blue-500 hover:text-blue-600", title: "View Comments" },
                                        React.createElement(MessageSquareIcon, { size: 18 }),
                                        isPendingForClient && React.createElement("span", { className: "absolute -top-1 -right-1 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white" })
                                    ),
                                    React.createElement("button", { onClick: () => onAIUpdate(task), className: "text-purple-500 hover:text-purple-600", title: "AI Suggestions" }, React.createElement(Zap, { size: 18 }))
                                )
                            )
                        ))
                    ),
                    task.isExpanded && hasSubtasks && task.subtasks.map(subtask => (
                        React.createElement(TaskRow, {
                            key: subtask.id,
                            task: subtask,
                            level: level + 1,
                            onAddTask: onAddTask,
                            onAddSubTask: onAddSubTask,
                            onDeleteTask: onDeleteTask,
                            viewType, loggedInUserType, onUpdateTask, onEditTask, onAIUpdate, onShowNotes, onShowDetails, onClientComm, onToggleClientDeliverable, onToggleExpansion, isTrialExpired
                        })
                    ))
                )
            );
        };


        const EditTaskModal = ({ task, onClose, onSave, isTrialExpired }) => {
            const { useState, useEffect, useRef } = React;
            const [formData, setFormData] = useState({ ...task });
            const modalContentRef = useRef(null);
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [onClose]);
            useEffect(() => {
                setFormData({ ...task, weightage: task.weightage ?? 0 });
            }, [task]);
            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                const newValue = type === 'checkbox' ? checked : (type === 'number' ? parseFloat(value) || 0 : value);
                setFormData(prev => {
                    const updatedData = { ...prev, [name]: newValue };
                    if (name === 'progress') {
                        const progressValue = Number(newValue);
                        if (progressValue > 0 && progressValue < 100) {
                            updatedData.status = 'In Progress';
                        } else if (progressValue >= 100) {
                            updatedData.status = 'Completed';
                        } else if (progressValue <= 0) {
                            updatedData.status = 'Not Started';
                        }
                    }
                    if (name === 'status' && newValue === 'Completed') {
                        updatedData.progress = 100;
                    }
                    if (name === 'status' && newValue === 'Not Started') {
                        updatedData.progress = 0;
                    }
                    return updatedData;
                });
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                let finalData = {
                    ...formData,
                    progress: Math.max(0, Math.min(100, Number(formData.progress) || 0)),
                    plannedStartDate: formData.plannedStartDate || null,
                    plannedEndDate: formData.plannedEndDate || null,
                    actualStartDate: formData.actualStartDate || null,
                    actualEndDate: formData.actualEndDate || null,
                    delayWeatherDays: Number(formData.delayWeatherDays) || 0,
                    delayContractorDays: Number(formData.delayContractorDays) || 0,
                    delayClientDays: Number(formData.delayClientDays) || 0,
                    weightage: Number(formData.weightage) ?? 0
                };
                if (finalData.progress === 100) {
                    finalData.status = 'Completed';
                }
                onSave(finalData);
            };
            return (React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-2xl w-full max-w-md sm:max-w-lg max-h-[90vh] overflow-y-auto" },
                    React.createElement("h2", { className: "text-xl sm:text-2xl font-semibold mb-6 text-sky-600" }, "Edit Task: ", React.createElement("span", { className: "font-bold" }, task.taskName)),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "plannedStartDate", className: "modal-label block text-sm font-medium mb-1" }, "Planned Start Date"),
                                React.createElement("input", { type: "date", name: "plannedStartDate", id: "plannedStartDate", value: formatDateForInput(formData.plannedStartDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" })
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "plannedEndDate", className: "modal-label block text-sm font-medium mb-1" }, "Planned End Date"),
                                React.createElement("input", { type: "date", name: "plannedEndDate", id: "plannedEndDate", value: formatDateForInput(formData.plannedEndDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" })
                            )
                        ),
                        React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "actualStartDate", className: "modal-label block text-sm font-medium mb-1" }, "Actual Start Date"),
                                React.createElement("input", { type: "date", name: "actualStartDate", id: "actualStartDate", value: formatDateForInput(formData.actualStartDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" })
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "actualEndDate", className: "modal-label block text-sm font-medium mb-1" }, "Actual End Date"),
                                React.createElement("input", { type: "date", name: "actualEndDate", id: "actualEndDate", value: formatDateForInput(formData.actualEndDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" }))
                        ),
                        React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "progress", className: "modal-label block text-sm font-medium mb-1" }, "Progress (%)"),
                                hasSubtasks && React.createElement("p", { className: "text-xs text-slate-500 mb-1" }, "Calculated from subtasks."),
                                React.createElement("input", { type: "number", name: "progress", id: "progress", value: formData.progress || 0, onChange: handleChange, min: "0", max: "100", className: "w-full p-2 modal-input rounded-md", disabled: hasSubtasks })
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "weightage", className: "modal-label block text-sm font-medium mb-1" }, "Weightage (%)"),
                                React.createElement("input", { type: "number", name: "weightage", id: "weightage", value: formData.weightage ?? 0, onChange: handleChange, min: "0", step: "any", className: "w-full p-2 modal-input rounded-md" })
                            )
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "status", className: "modal-label block text-sm font-medium mb-1" }, "Status"),
                            React.createElement("select", { name: "status", id: "status", value: formData.status, onChange: handleChange, className: "w-full p-2 modal-input rounded-md" }, TASK_STATUSES.map(s => React.createElement("option", { key: s, value: s }, s)))
                        ),
                        React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-3 gap-4" },
                            React.createElement("div", null, React.createElement("label", { htmlFor: "delayWeatherDays", className: "modal-label block text-sm font-medium mb-1" }, "Weather Delay"), React.createElement("input", { type: "number", name: "delayWeatherDays", id: "delayWeatherDays", value: formData.delayWeatherDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" })),
                            React.createElement("div", null, React.createElement("label", { htmlFor: "delayContractorDays", className: "modal-label block text-sm font-medium mb-1" }, "Contractor Delay"), React.createElement("input", { type: "number", name: "delayContractorDays", id: "delayContractorDays", value: formData.delayContractorDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" })),
                            React.createElement("div", null, React.createElement("label", { htmlFor: "delayClientDays", className: "modal-label block text-sm font-medium mb-1" }, "Client Delay"), React.createElement("input", { type: "number", name: "delayClientDays", id: "delayClientDays", value: formData.delayClientDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" }))
                        ),
                        React.createElement("div", null, React.createElement("label", { htmlFor: "predecessorString", className: "modal-label block text-sm font-medium mb-1" }, "Predecessors"), React.createElement("input", { type: "text", name: "predecessorString", id: "predecessorString", value: formData.predecessorString || '', onChange: handleChange, className: "w-full p-2 modal-input rounded-md", placeholder: "e.g., 17, 3FS+4d" })),
                        React.createElement("div", { className: "flex items-center space-x-4" }, React.createElement("label", { htmlFor: "isCritical", className: "flex items-center text-sm font-medium modal-label" }, React.createElement("input", { type: "checkbox", name: "isCritical", id: "isCritical", checked: !!formData.isCritical, onChange: handleChange, className: "h-4 w-4 text-red-600 border-slate-300 rounded focus:ring-red-500 mr-2" }), "Mark as Critical"), React.createElement("label", { htmlFor: "isClientDeliverable", className: "flex items-center text-sm font-medium modal-label" }, React.createElement("input", { type: "checkbox", name: "isClientDeliverable", id: "isClientDeliverable", checked: !!formData.isClientDeliverable, onChange: handleChange, className: "h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500 mr-2" }), "Client Deliverable")),
                        React.createElement("div", { className: "flex justify-end space-x-3 pt-4" }, React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors" }, "Cancel"), React.createElement("button", { type: "submit", disabled: isTrialExpired, title: isTrialExpired ? 'Trial expired. Upgrade to continue.' : undefined, className: `px-4 py-2 rounded-md bg-sky-600 hover:bg-sky-700 text-white font-semibold transition-colors flex items-center ${isTrialExpired ? 'opacity-50 cursor-not-allowed' : ''}` }, React.createElement(Save, { size: 18, className: "mr-2" }), " Save Changes"))))));
        };
        const AIUpdateModal = ({ task, allTasks, loggedInUserType, onClose, onApplySuggestion, setAppError }) => {
            const { useState, useEffect, useRef } = React;
            const [suggestedProgress, setSuggestedProgress] = useState(task.progress || 0);
            const [suggestedStatus, setSuggestedStatus] = useState(task.status || "Not Started");
            const [riskMitigationPairs, setRiskMitigationPairs] = useState([]);
            const [isGeneratingRiskAssessment, setIsGeneratingRiskAssessment] = useState(false);
            const [generationError, setGenerationError] = useState(null);
            const [retryStatus, setRetryStatus] = useState(null);
            const modalContentRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [onClose]);
            const handleGenerateRiskAssessment = async () => {
                setIsGeneratingRiskAssessment(true);
                setGenerationError(null);
                setRiskMitigationPairs([]);
                setAppError(null);
                const allTasksSummary = allTasks.map(t => JSON.stringify({ wbs: t.wbs, name: t.taskName, status: t.status, predecessors: t.predecessorString })).join('\n');
                const prompt = `
                Full Project Schedule Summary (WBS, Name, Status, Predecessors):
                ${allTasksSummary}
                
                ---
                Focus Task for Risk Assessment: "${task.taskName}" (WBS: ${task.wbs})
                Current Status: ${task.status}
                Current Progress: ${task.progress || 0}%
                Planned Start: ${task.plannedStartDate}
                Planned End: ${task.plannedEndDate}
                Predecessors: ${task.predecessorString || 'None'}
                Delays: Weather: ${task.delayWeatherDays || 0}d, Contractor: ${task.delayContractorDays || 0}d, Client: ${task.delayClientDays || 0}d

                Based on the full project schedule context and the specific details of the focus task, please identify potential risks and suggest a corresponding mitigation strategy for each. Your assessment MUST consider how delays or issues in predecessor tasks impact this focus task, and how this task's status could impact its successors.

                Return your response ONLY as a valid JSON array of objects. Each object must have two keys: "risk" and "mitigation".
                Example format:
                [
                  {"risk": "The critical predecessor 'Task A' is delayed, which will directly delay the start of this task.", "mitigation": "Immediately follow up with the team for 'Task A' to get a revised completion date. Evaluate re-sequencing non-dependent sub-tasks to begin earlier."},
                  {"risk": "This task has a long duration and no progress, indicating a potential bottleneck.", "mitigation": "Break down the task into smaller, manageable sub-tasks with weekly check-ins to monitor progress more closely."}
                ]
                Do not include any text, markdown, or formatting outside of the JSON array.
                `;
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = GEMINI_API_KEY;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const result = await retryApiCall(async () => {
                        const response = await fetch(apiUrl, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(payload) 
                        });
                        if (!response.ok) { 
                            throw new Error(`API request failed with status ${response.status}`); 
                        }
                        return await response.json();
                    }, 3, 1000, (attempt, maxRetries) => {
                        setRetryStatus(`Retrying... (${attempt}/${maxRetries})`);
                    });
                    
                    let responseText = result.candidates[0].content.parts[0].text;
                    responseText = responseText.trim().replace(/^```json\s*/, '').replace(/```$/, '');
                    try {
                        const parsedData = JSON.parse(responseText);
                        if (Array.isArray(parsedData)) {
                            setRiskMitigationPairs(parsedData);
                        } else {
                            throw new Error("AI did not return a JSON array.");
                        }
                    } catch (parseError) {
                        console.error("JSON Parsing Error:", parseError, "Raw Response:", responseText);
                        setGenerationError("The AI response was not in the correct format. Please try again.");
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    setRetryStatus(null);
                    setGenerationError(`Failed to generate risk assessment: ${error.message}.`);
                } finally {
                    setIsGeneratingRiskAssessment(false);
                }
            };
            const handleApplySuggestions = () => {
                const aiAssessmentNote = riskMitigationPairs.length > 0
                    ? `AI Risk Assessment & Mitigation:\n\n` + riskMitigationPairs.map(p => `Risk: ${p.risk}\nMitigation: ${p.mitigation}`).join('\n\n')
                    : 'No AI suggestions were applied.';

                // Create a new note entry instead of replacing existing notes
                const newNote = {
                    text: aiAssessmentNote,
                    timestamp: new Date().toISOString(),
                    source: 'AI Assessment'
                };

                // Append to existing notes array
                const updatedNotes = [...(task.notes || []), newNote];

                onApplySuggestion(task.id, {
                    progress: task.progress,
                    status: task.status,
                    notes: updatedNotes
                });
                onClose();
            };
            return (
                React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                    React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-lg sm:max-w-2xl max-h-[90vh] flex flex-col" },
                        React.createElement("h2", { className: "text-xl sm:text-2xl font-semibold mb-4 text-purple-600 flex items-center flex-shrink-0" },
                            React.createElement(Zap, { size: 22, className: "mr-2" }),
                            `AI Assessment for "${task.taskName}"`
                        ),
                        React.createElement("div", { className: "space-y-4 overflow-y-auto pr-2 flex-grow" },
                            React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                                React.createElement("div", null,
                                    React.createElement("label", { className: "modal-label block text-sm font-medium mb-1" }, "Current Progress (%)"),
                                    React.createElement("input", {
                                        type: "text",
                                        value: suggestedProgress,
                                        className: "w-full p-2 modal-input rounded-md",
                                        disabled: true
                                    })
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { className: "modal-label block text-sm font-medium mb-1" }, "Current Status"),
                                    React.createElement("input", {
                                        type: "text",
                                        value: suggestedStatus,
                                        className: "w-full p-2 modal-input rounded-md",
                                        disabled: true
                                    })
                                )
                            ),
                            React.createElement("button", {
                                type: "button",
                                onClick: handleGenerateRiskAssessment,
                                disabled: isGeneratingRiskAssessment,
                                className: "w-full mt-2 px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-md flex items-center justify-center transition-colors disabled:opacity-50"
                            },
                                isGeneratingRiskAssessment ? React.createElement("div", { className: "ai-spinner" }) : React.createElement(LightbulbIcon, { size: 18, className: "mr-2" }),
                                isGeneratingRiskAssessment ? (retryStatus || "Generating Insights...") : "Generate Risk Assessment & Mitigation Ideas"
                            ),
                            generationError && React.createElement("p", { className: "text-sm text-red-600 bg-red-50 p-2 rounded-md" }, generationError),
                            (riskMitigationPairs.length > 0) && React.createElement("div", { className: "mt-4" },
                                React.createElement("table", { className: "min-w-full divide-y divide-slate-200 border border-slate-200 rounded-lg" },
                                    React.createElement("thead", { className: "bg-slate-50" },
                                        React.createElement("tr", null,
                                            React.createElement("th", { className: "px-4 py-2 text-left text-sm font-semibold text-slate-700 w-1/2" }, "Risk Assessment"),
                                            React.createElement("th", { className: "px-4 py-2 text-left text-sm font-semibold text-slate-700 w-1/2" }, "Mitigation Idea")
                                        )
                                    ),
                                    React.createElement("tbody", { className: "divide-y divide-slate-200" },
                                        riskMitigationPairs.map((pair, index) => React.createElement("tr", { key: index },
                                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 align-top" }, pair.risk),
                                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 align-top border-l border-slate-200" }, pair.mitigation)
                                        ))
                                    )
                                )
                            )
                        ),
                        React.createElement("div", { className: "flex justify-end gap-3 pt-6 flex-shrink-0" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close"),
                            loggedInUserType !== 'client' && React.createElement("button", { type: "button", onClick: handleApplySuggestions, disabled: riskMitigationPairs.length === 0, className: "px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold flex items-center disabled:opacity-50" }, React.createElement(CheckCircle, { size: 18, className: "mr-2" }), "Apply to Notes")
                        )
                    )
                )
            );
        };
        const NotesModal = ({ task, loggedInUser, onClose, onAddNote }) => {
            const { useState, useEffect, useRef } = React;
            const [noteText, setNoteText] = useState("");
            const modalContentRef = useRef(null);
            const loggedInUserType = loggedInUser.userType;

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [onClose]);

            // Filter notes to ensure 'n.text' is a string before rendering.
            const validNotes = Array.isArray(task.notes) ? task.notes.filter(n => typeof n.text === 'string' && n.text) : [];

            return (
                React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                    React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto" },
                        React.createElement("h2", { className: "text-xl font-semibold mb-4 text-green-600 flex items-center" }, React.createElement(MessageSquareIcon, { size: 20, className: "mr-2" }), loggedInUserType !== 'client' ? `Notes for "${task.taskName}"` : `View Notes for "${task.taskName}"`),
                        React.createElement("div", { className: "space-y-4" },
                            React.createElement("div", null,
                                React.createElement("h3", { className: "font-medium text-slate-800 mb-2 text-sm" }, "Existing Notes"),
                                validNotes.length > 0 ? (
                                    React.createElement("ul", { className: "list-none space-y-2 max-h-48 overflow-y-auto pr-2" },
                                        validNotes.slice().reverse().map((n, idx) => (
                                            React.createElement("li", { key: idx, className: "mb-1 p-2.5 bg-slate-50 rounded-md border border-slate-200 text-xs" },
                                                React.createElement("span", { className: "block font-medium text-slate-700" }, `${n.source} (`, new Date(n.timestamp).toLocaleString(), ")"),
                                                React.createElement("p", { className: "text-slate-600 mt-0.5 whitespace-pre-wrap" }, n.text)
                                            )
                                        ))
                                    )
                                ) : (React.createElement("p", { className: "text-sm italic text-slate-500" }, "No valid notes to display."))
                            ),
                            loggedInUserType !== 'client' && (
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "noteText", className: "modal-label block text-sm font-medium mb-1" }, "New Note"),
                                    React.createElement("textarea", { id: "noteText", rows: "3", className: "w-full p-2 modal-input rounded-md", value: noteText, onChange: (e) => setNoteText(e.target.value) })
                                )
                            )
                        ),
                        React.createElement("div", { className: "flex justify-end gap-3 pt-6" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close"),
                            loggedInUserType !== 'client' && (React.createElement("button", { type: "button", onClick: () => { if (noteText.trim()) { onAddNote(task.id, noteText.trim()); onClose(); } }, className: "px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold flex items-center" }, React.createElement(PlusCircle, { size: 18, className: "mr-2" }), "Add Note"))
                        )
                    )
                )
            );
        };

        const ClientCommunicationModal = ({ task, loggedInUser, onClose, onAdminAddComment, onClientRespond, selectedProject }) => {
    const { useState, useEffect, useRef, useMemo } = React;
    const [adminCommentText, setAdminCommentText] = useState("");
    const [communicationType, setCommunicationType] = useState("");
    const [attachments, setAttachments] = useState([]);
    const [isUploading, setIsUploading] = useState(false);
    const [selectedCommentForReply, setSelectedCommentForReply] = useState(null);
    const [selectedStatus, setSelectedStatus] = useState("");
    const [clientCommentText, setClientCommentText] = useState('');
    const [clientAttachments, setClientAttachments] = useState([]);
    const modalContentRef = useRef(null);
    const loggedInUserType = loggedInUser.userType;

    const pendingComments = useMemo(() => {
        if (!task.clientComments) return [];
        return task.clientComments.filter(c => !c.clientStatus);
    }, [task.clientComments]);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (modalContentRef.current && !modalContentRef.current.contains(event.target)) { onClose(); }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => { document.removeEventListener("mousedown", handleClickOutside); };
    }, [onClose]);

    const handleFileDownload = async (projectName, taskId, filename) => {
        try {
            // Download document endpoint uses path parameters
            // Each segment should be URL-encoded to handle special characters
            // Example: project name "Test & Demo" becomes "Test%20%26%20Demo"
            const response = await makeAuthenticatedRequest(`/download_document/${encodeURIComponent(projectName)}/${encodeURIComponent(taskId)}/${encodeURIComponent(filename)}`, { method: 'GET' });
            if (!response.ok) {
                if (response.status === 403) { alert("Access denied. You don't have permission to download this file."); return; }
                if (response.status === 404) { alert('File not found.'); return; }
                if (response.status === 401) { alert('Authentication required.'); return; }
                const txt = await response.text();
                throw new Error(txt || 'Download failed');
            }
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (err) {
            alert(`Download error: ${err.message}`);
        }
    };

    const handleFileChange = (e, uploader) => {
        const files = Array.from(e.target.files);
        if (files.length > 5) {
            alert("You can upload a maximum of 5 documents at a time.");
            e.target.value = null;
            if (uploader === 'admin') {
                setAttachments([]);
            } else {
                setClientAttachments([]);
            }
            return;
        }
        if (uploader === 'admin') {
            setAttachments(files);
        } else {
            setClientAttachments(files);
        }
    };

    const handleAdminSubmit = async () => {
        if (!adminCommentText.trim() || !communicationType) {
            alert("Please provide a comment and select a communication type.");
            return;
        }
        // Proactive per-project file limit check
        const usage = window.latestUsageStats;
        if (usage && usage.limits && usage.files_by_project && selectedProject) {
            const current = usage.files_by_project[selectedProject] || 0;
            const limit = usage.limits.files_per_project ?? 999999;
            const pending = (attachments || []).length;
            if (limit < 999999 && current + pending > limit) {
                alert(`Uploading ${pending} files would exceed the per-project limit (${current}/${limit}).`);
                if (typeof window.refreshUsageStats === 'function') window.refreshUsageStats();
                return;
            }
        }
        setIsUploading(true);
        let uploadedFilePaths = [];
        if (attachments.length > 0) {
            const formData = new FormData();
            attachments.forEach(file => {
                formData.append('files[]', file);
            });
            formData.append('project_name', selectedProject);
            formData.append('task_id', String(task.id));
            try {
                const response = await makeAuthenticatedRequest('/api/upload_document', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'success') {
                    uploadedFilePaths = result.filepaths;
                } else { throw new Error(result.message || 'File upload failed'); }
            } catch (error) {
                alert(`Error uploading files: ${error.message}`);
                setIsUploading(false);
                return;
            }
        }
        onAdminAddComment(task.id, adminCommentText.trim(), communicationType, uploadedFilePaths);
        setIsUploading(false);
        onClose();
    };

    const handleSendResponse = async () => {
        if (selectedCommentForReply && selectedStatus) {
            // Proactive per-project file limit check for client reply
            const usage = window.latestUsageStats;
            if (usage && usage.limits && usage.files_by_project && selectedProject) {
                const current = usage.files_by_project[selectedProject] || 0;
                const limit = usage.limits.files_per_project ?? 999999;
                const pending = (clientAttachments || []).length;
                if (limit < 999999 && current + pending > limit) {
                    alert(`Uploading ${pending} files would exceed the per-project limit (${current}/${limit}).`);
                    if (typeof window.refreshUsageStats === 'function') window.refreshUsageStats();
                    return;
                }
            }
            setIsUploading(true);
            let clientUploadedFilePaths = [];
            if (clientAttachments.length > 0) {
                const formData = new FormData();
                clientAttachments.forEach(file => {
                    formData.append('files[]', file);
                });
                formData.append('project_name', selectedProject);
                formData.append('task_id', String(task.id));
                 try {
                    const response = await makeAuthenticatedRequest('/api/upload_document', { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.status === 'success') {
                        clientUploadedFilePaths = result.filepaths;
                    } else { throw new Error(result.message || 'File upload failed'); }
                } catch (error) {
                    alert(`Error uploading files: ${error.message}`);
                    setIsUploading(false);
                    return;
                }
            }
            onClientRespond(task.id, selectedCommentForReply.id, selectedStatus, clientCommentText, clientUploadedFilePaths);
            setIsUploading(false);
            onClose();
        }
    };

    const handleSelectCommentForReply = (comment) => {
        setSelectedCommentForReply(comment);
        setSelectedStatus('');
        setClientCommentText('');
        setClientAttachments([]);
    };

    const isClientButtonDisabled = !selectedStatus || (selectedStatus === 'Return with Comments' && !clientCommentText.trim()) || isUploading;
    const isAdminButtonDisabled = !adminCommentText.trim() || !communicationType || isUploading;

    const communicationLog = (
        React.createElement("div", { className: "flex-shrink-0" },
            React.createElement("h3", { className: "font-medium text-slate-800 mb-2 text-sm" }, "Communication Log"),
            task.clientComments && task.clientComments.length > 0 ? (
                React.createElement("ul", { className: "list-none space-y-3 max-h-40 overflow-y-auto pr-2 border rounded-md p-2 bg-slate-50" },
                    task.clientComments
                        .slice()
                        .sort((a, b) => new Date(b.adminTimestamp) - new Date(a.adminTimestamp))
                        .map((cc) => (
                            React.createElement("li", { key: cc.id, className: "p-2.5 rounded-md border text-xs " + (cc.clientStatus ? "bg-white border-green-200" : "bg-white border-sky-200") },
                                React.createElement("div", { className: "flex justify-between items-center" },
                                    React.createElement("span", { className: "block font-medium text-slate-700" }, `Admin (${new Date(cc.adminTimestamp).toLocaleString()})`),
                                    cc.communicationType && React.createElement("span", { className: `px-2 py-0.5 text-xs rounded-full ${cc.communicationType === 'Approval' ? 'bg-orange-100 text-orange-800' : cc.communicationType === 'Review' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}` }, cc.communicationType)
                                ),
                                React.createElement("p", { className: "text-slate-600 mt-1 whitespace-pre-wrap" }, cc.adminComment),
                                cc.attachments && cc.attachments.length > 0 &&
                                React.createElement("div", {className: "mt-2"},
                                    React.createElement("p", {className: "text-xs font-medium text-slate-600 mb-1"}, "Admin Uploads:"),
                                    React.createElement("div", {className: "flex flex-col items-start gap-1.5"},
                                        cc.attachments.map((attachment, index) =>
                                            React.createElement("a", {
                                                key: index,
                                                href: '#',
                                                onClick: (e) => { e.preventDefault(); handleFileDownload(selectedProject, task.id, attachment); },
                                                className: "inline-flex items-center text-xs text-blue-600 hover:text-blue-800 bg-blue-100 px-2 py-1 rounded",
                                                style: { cursor: 'pointer' }
                                            }, React.createElement(PaperclipIcon, { size: 14, className: "mr-1.5" }), `Download Attachment ${index + 1}`)
                                        )
                                    )
                                ),
                                cc.clientStatus && (React.createElement(React.Fragment, null,
                                    React.createElement("hr", { className: "my-2 border-slate-300" }),
                                    React.createElement("span", { className: "block font-medium text-slate-700" }, `Client (${new Date(cc.clientResponseTimestamp).toLocaleString()}):`),
                                    React.createElement("p", { className: "text-slate-600 mt-0.5 whitespace-pre-wrap" }, React.createElement("strong", null, cc.clientStatus)),
                                    cc.clientComment && React.createElement("p", { className: "text-slate-500 mt-1 pl-2 border-l-2 border-slate-300" }, cc.clientComment),
                                    cc.clientAttachments && cc.clientAttachments.length > 0 &&
                                    React.createElement("div", {className: "mt-2"},
                                        React.createElement("p", {className: "text-xs font-medium text-slate-600 mb-1"}, "Client Uploads:"),
                                        React.createElement("div", {className: "flex flex-col items-start gap-1.5"},
                                             cc.clientAttachments.map((attachment, index) =>
                                                React.createElement("a", {
                                                    key: index,
                                                    href: '#',
                                                    onClick: (e) => { e.preventDefault(); handleFileDownload(selectedProject, task.id, attachment); },
                                                    className: "inline-flex items-center text-xs text-green-600 hover:text-green-800 bg-green-100 px-2 py-1 rounded",
                                                    style: { cursor: 'pointer' }
                                                }, React.createElement(PaperclipIcon, { size: 14, className: "mr-1.5" }), `Download Attachment ${index + 1}`)
                                            )
                                        )
                                    )
                                ))
                            )
                        ))
                )
            ) : (React.createElement("p", { className: "text-sm italic text-slate-500" }, "No comments yet."))
        )
    );

    return (
        React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
            React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col" },
                React.createElement("h2", { className: "text-xl font-semibold mb-4 text-sky-600 flex items-center flex-shrink-0" }, React.createElement(MessageSquareIcon, { size: 20, className: "mr-2" }), `Communication for "${task.taskName}"`),
                React.createElement("div", { className: "flex-grow flex flex-col gap-4 min-h-0" },
                    loggedInUserType !== "client" && React.createElement(React.Fragment, null,
                        communicationLog,
                        React.createElement("div", { className: "flex-grow flex flex-col gap-3 min-h-0 border-t pt-4" },
                            React.createElement("label", { htmlFor: "adminComment", className: "modal-label block text-sm font-medium" }, "New Comment to Client"),
                            React.createElement("textarea", { id: "adminComment", className: "w-full p-2 modal-input rounded-md flex-grow", value: adminCommentText, onChange: (e) => setAdminCommentText(e.target.value), placeholder: "Type your comment here..." }),
                            React.createElement("div", null,
                                React.createElement("label", { className: "modal-label block text-sm font-medium mb-2" }, "Communication Type (Required)"),
                                React.createElement("div", { className: "flex flex-wrap gap-3" }, ["Information", "Review", "Approval"].map(type => React.createElement("label", { key: type, className: "flex items-center text-sm" }, React.createElement("input", { type: "radio", name: "commType", value: type, checked: communicationType === type, onChange: (e) => setCommunicationType(e.target.value), className: "h-4 w-4" }), React.createElement("span", { className: "ml-2" }, type))))
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { htmlFor: "attachment", className: "modal-label block text-sm font-medium" }, "Attach Documents (Up to 5)"),
                                React.createElement("input", { type: "file", id: "attachment", onChange: (e) => handleFileChange(e, 'admin'), multiple: true, className: "w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100" }),
                                attachments.length > 0 && React.createElement("div", {className: "mt-2 text-xs text-slate-500"},
                                    React.createElement("p", {className:"font-medium"}, "Selected files:"),
                                    React.createElement("ul", {className: "list-disc pl-5"},
                                        attachments.map((file, index) => React.createElement("li", {key: index}, file.name))
                                    )
                                )
                            )
                        )
                    ),

                    loggedInUserType === "client" && React.createElement(React.Fragment, null,
                        communicationLog,
                        pendingComments.length > 0 ? React.createElement("div", { className: "flex-grow flex flex-col gap-3 min-h-0 border-t pt-4" },
                            React.createElement("h3", { className: "font-medium text-slate-800 text-sm" }, "Pending Comments (", pendingComments.length, ") - Select one to reply"),
                            React.createElement("div", { className: "space-y-2 overflow-y-auto pr-2" },
                                pendingComments.map(comment => React.createElement("div", {
                                    key: comment.id,
                                    onClick: () => handleSelectCommentForReply(comment),
                                    className: `p-2.5 rounded-md text-sm cursor-pointer border-2 ${selectedCommentForReply?.id === comment.id ? 'border-blue-500 bg-blue-50' : 'border-slate-200 bg-slate-50 hover:bg-slate-100'}`
                                },
                                    React.createElement("strong", null, `Admin (${new Date(comment.adminTimestamp).toLocaleString()}):`),
                                    React.createElement("p", { className: "mt-1 whitespace-pre-wrap text-slate-700" }, comment.adminComment)
                                ))
                            ),
                            selectedCommentForReply && React.createElement("div", { className: "pt-3 border-t space-y-3 flex-shrink-0" },
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "clientStatus", className: "modal-label block text-sm font-medium mb-1" }, "Your Response"),
                                    React.createElement("select", { id: "clientStatus", className: "w-full p-2 modal-input rounded-md", value: selectedStatus, onChange: (e) => setSelectedStatus(e.target.value) }, React.createElement("option", { value: "" }, "Select a response status..."), CLIENT_COMMENT_STATUSES.map((st) => (React.createElement("option", { key: st, value: st }, st))))
                                ),
                                selectedStatus === 'Return with Comments' && React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "clientCommentText", className: "modal-label block text-sm font-medium mb-1" }, "Add Comments"),
                                    React.createElement("textarea", { id: "clientCommentText", rows: "3", className: "w-full p-2 modal-input rounded-md", value: clientCommentText, onChange: (e) => setClientCommentText(e.target.value) })
                                ),
                                 React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "clientAttachment", className: "modal-label block text-sm font-medium" }, "Attach Documents (Up to 5)"),
                                    React.createElement("input", { type: "file", id: "clientAttachment", onChange: (e) => handleFileChange(e, 'client'), multiple: true, className: "w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" }),
                                     clientAttachments.length > 0 && React.createElement("div", {className: "mt-2 text-xs text-slate-500"},
                                        React.createElement("p", {className:"font-medium"}, "Selected files:"),
                                        React.createElement("ul", {className: "list-disc pl-5"},
                                            clientAttachments.map((file, index) => React.createElement("li", {key: index}, file.name))
                                        )
                                    )
                                )
                            )
                        ) : React.createElement("p", { className: "text-center text-slate-500 italic pt-4" }, "No pending comments from the admin.")
                    )
                ),

                React.createElement("div", { className: "flex justify-end gap-3 pt-4 flex-shrink-0 border-t" },
                    React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Cancel"),
                    loggedInUserType !== 'client' && React.createElement("button", { type: "button", onClick: handleAdminSubmit, disabled: isAdminButtonDisabled, className: "px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-semibold flex items-center disabled:bg-blue-300 disabled:cursor-not-allowed" }, isUploading ? React.createElement(React.Fragment, null, React.createElement("div", { className: "animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" }), "Submitting...") : React.createElement(React.Fragment, null, React.createElement(SendIcon, { size: 16, className: "mr-2" }), "Submit to Client")),
                    loggedInUserType === 'client' && selectedCommentForReply && React.createElement("button", { type: "button", onClick: handleSendResponse, className: "px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold flex items-center disabled:bg-green-300", disabled: isClientButtonDisabled }, isUploading ? React.createElement(React.Fragment, null, React.createElement("div", { className: "animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" }), "Sending...") :React.createElement(React.Fragment, null, React.createElement(SendIcon, { size: 16, className: "mr-2" }), "Send Response"))
                )
            )
        )
    );
};

        const AddTaskModal = ({ onClose, onAdd, mode }) => {
            const { useState, useRef, useEffect } = React;
            const [taskName, setTaskName] = useState('');
            const [plannedStartDate, setPlannedStartDate] = useState('');
            const [plannedEndDate, setPlannedEndDate] = useState('');
            const modalContentRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!taskName.trim()) {
                    alert("Task Name is required.");
                    return;
                }
                onAdd({ taskName, plannedStartDate, plannedEndDate });
                onClose();
            };
            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-2xl w-full max-w-md" },
                    React.createElement("h2", { className: "text-xl font-semibold mb-4 text-blue-600" }, mode === 'child' ? "Add New Sub-task" : "Add New Task"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "taskName", className: "modal-label block text-sm font-medium mb-1" }, "Task Name"),
                            React.createElement("input", { type: "text", id: "taskName", value: taskName, onChange: e => setTaskName(e.target.value), required: true, className: "w-full p-2 modal-input rounded-md" })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "plannedStartDate", className: "modal-label block text-sm font-medium mb-1" }, "Planned Start Date"),
                            React.createElement("input", { type: "date", id: "plannedStartDate", value: plannedStartDate, onChange: e => setPlannedStartDate(e.target.value), className: "w-full p-2 modal-input rounded-md" })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "plannedEndDate", className: "modal-label block text-sm font-medium mb-1" }, "Planned End Date"),
                            React.createElement("input", { type: "date", id: "plannedEndDate", value: plannedEndDate, onChange: e => setPlannedEndDate(e.target.value), className: "w-full p-2 modal-input rounded-md" })
                        ),
                        React.createElement("div", { className: "flex justify-end space-x-3 pt-4" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-700" }, "Cancel"),
                            React.createElement("button", { type: "submit", className: "px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white font-semibold" }, "Add Task")
                        )
                    )
                )
            );
        };

        const AddProjectModal = ({ onClose, onAdd }) => {
            const { useState, useRef, useEffect } = React;
            const [projectName, setProjectName] = useState('');
            const [clientAccessCode, setClientAccessCode] = useState('');
            const modalContentRef = useRef(null);
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!projectName.trim()) {
                    alert("Project Name is required.");
                    return;
                }
                if (!clientAccessCode.trim()) {
                    alert("Client Access Code is required.");
                    return;
                }
                onAdd(projectName, clientAccessCode);
            };
            
            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-2xl w-full max-w-md" },
                    React.createElement("h2", { className: "text-xl font-semibold mb-4 text-green-600" }, "Add New Project"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "projectName", className: "modal-label block text-sm font-medium mb-1" }, "Project Name"),
                            React.createElement("input", { 
                                type: "text", 
                                id: "projectName", 
                                value: projectName, 
                                onChange: e => setProjectName(e.target.value), 
                                required: true, 
                                className: "w-full p-2 modal-input rounded-md",
                                placeholder: "Enter project name"
                            })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "clientAccessCode", className: "modal-label block text-sm font-medium mb-1" }, "Client Access Code"),
                            React.createElement("input", { 
                                type: "text", 
                                id: "clientAccessCode", 
                                value: clientAccessCode, 
                                onChange: e => setClientAccessCode(e.target.value), 
                                required: true, 
                                className: "w-full p-2 modal-input rounded-md",
                                placeholder: "Enter client access code"
                            })
                        ),
                        React.createElement("div", { className: "flex justify-end space-x-3 pt-4" },
                            React.createElement("button", { 
                                type: "button", 
                                onClick: onClose, 
                                className: "px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-700" 
                            }, "Cancel"),
                            React.createElement("button", { 
                                type: "submit", 
                                className: "px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white font-semibold" 
                            }, "Add Project")
                        )
                    )
                )
            );
        };

        const imageToBase64 = async (url) => {
            const response = await fetch(url);
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };

        // Subscription Management Modal
        const SubscriptionManagementModal = ({ onClose, loggedInUser, onSubscriptionUpdated }) => {
            const { useState, useEffect } = React;
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [activeTab, setActiveTab] = useState('overview');
            const [subscription, setSubscription] = useState(null);
            const [billingHistory, setBillingHistory] = useState([]);
            const [pagination, setPagination] = useState({ page: 1, limit: 10, total_pages: 1, total_count: 0 });
            // Upgrade tab state - must be at top level to follow Rules of Hooks
            const [selPlan, setSelPlan] = useState('si_plus');
            const [selUsers, setSelUsers] = useState(1);
            const [selCycle, setSelCycle] = useState('monthly');

            useEffect(() => { fetchSubscription(); }, []);
            useEffect(() => { window.refreshSubscriptionData = fetchSubscription; return () => { try { delete window.refreshSubscriptionData; } catch (e) {} } }, []);
            
            // Update upgrade tab state when subscription data is loaded
            useEffect(() => {
                if (subscription) {
                    setSelUsers(subscription.user_count || 1);
                    setSelCycle(subscription.billing_cycle || 'monthly');
                }
            }, [subscription]);

            const fetchSubscription = async () => {
                setIsLoading(true);
                setError('');
                try {
                    const res = await makeAuthenticatedRequest('/api/org/subscription', { method: 'GET', headers: { 'Content-Type': 'application/json' } });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setSubscription(data.subscription);
                        fetchBillingHistory(1, {});
                    } else {
                        setError(data.message || 'Failed to fetch subscription');
                    }
                } catch (e) {
                    setError('Failed to fetch subscription');
                } finally {
                    setIsLoading(false);
                }
            };

            const fetchBillingHistory = async (page = 1, filters = {}) => {
                try {
                    const qp = new URLSearchParams({ page, limit: 10, ...filters });
                    const res = await makeAuthenticatedRequest(`/api/org/billing/history?${qp.toString()}`, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setBillingHistory(data.transactions || []);
                        setPagination(data.pagination || { page, limit: 10, total_pages: 1, total_count: 0 });
                    }
                } catch (e) { /* no-op */ }
            };

            const handleUpgrade = async (newPlanType, userCount, billingCycle) => {
                try {
                    const res = await makeAuthenticatedRequest('/api/org/subscription/upgrade', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ new_plan_type: newPlanType, user_count: userCount, billing_cycle: billingCycle }) });
                    const data = await res.json();
                    if (data.status === 'success') {
                        if (window.openRazorpayCheckout) {
                            window.openRazorpayCheckout(data);
                        }
                    } else {
                        setError(data.message || 'Failed to upgrade subscription');
                    }
                } catch (e) {
                    setError('Failed to upgrade subscription');
                }
            };

            const handleCancel = async (cancelAtCycleEnd = true, reason = '') => {
                try {
                    const res = await makeAuthenticatedRequest('/api/org/subscription/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cancel_at_cycle_end: cancelAtCycleEnd, reason }) });
                    const data = await res.json();
                    if (data.status === 'success') {
                        alert(data.message);
                        fetchSubscription();
                        if (onSubscriptionUpdated) onSubscriptionUpdated();
                    } else {
                        setError(data.message || 'Failed to cancel subscription');
                    }
                } catch (e) { setError('Failed to cancel subscription'); }
            };

            const handlePause = async (pauseDuration = 1, reason = '') => {
                try {
                    const res = await makeAuthenticatedRequest('/api/org/subscription/pause', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pause_duration: pauseDuration, reason }) });
                    const data = await res.json();
                    if (data.status === 'success') {
                        alert(data.message);
                        fetchSubscription();
                        if (onSubscriptionUpdated) onSubscriptionUpdated();
                    } else {
                        setError(data.message || 'Failed to pause subscription');
                    }
                } catch (e) { setError('Failed to pause subscription'); }
            };

            const downloadInvoice = async (transactionId) => {
                try {
                    const response = await makeAuthenticatedRequest(`/api/org/billing/invoice/${transactionId}`, { method: 'GET' });
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = `invoice_${transactionId}.pdf`; document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
                    } else {
                        const data = await response.json();
                        alert(data.message || 'Failed to download invoice');
                    }
                } catch (e) { alert('Failed to download invoice'); }
            };

            if (isLoading) {
                return React.createElement('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50' },
                    React.createElement('div', { className: 'bg-white rounded-lg p-8 max-w-md' },
                        React.createElement('div', { className: 'animate-pulse' },
                            React.createElement('div', { className: 'h-8 bg-slate-200 rounded w-3/4 mb-4' }),
                            React.createElement('div', { className: 'h-4 bg-slate-200 rounded w-full mb-2' }),
                            React.createElement('div', { className: 'h-4 bg-slate-200 rounded w-5/6 mb-2' }),
                            React.createElement('div', { className: 'h-4 bg-slate-200 rounded w-4/6' })
                        )
                    )
                );
            }

            if (error) {
                return React.createElement('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50' },
                    React.createElement('div', { className: 'bg-white rounded-lg p-8 max-w-md' },
                        React.createElement('div', { className: 'text-red-600 text-center' },
                            React.createElement('p', { className: 'font-medium mb-2' }, 'Failed to load subscription'),
                            React.createElement('p', { className: 'text-sm text-slate-600 mb-4' }, error),
                            React.createElement('button', { onClick: () => { setError(''); fetchSubscription(); }, className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700' }, 'Retry')
                        )
                    )
                );
            }

            const closeArea = React.createElement('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50', onClick: onClose });
            const content = React.createElement('div', { className: 'fixed inset-0 z-50 flex items-center justify-center p-4' },
                React.createElement('div', { className: 'bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-auto' },
                    React.createElement('div', { className: 'flex items-center justify-between p-4 border-b' },
                        React.createElement('h2', { className: 'text-xl font-bold text-slate-800' }, 'Manage Subscription'),
                        React.createElement('button', { onClick: onClose, className: 'p-2 rounded hover:bg-slate-100' }, '✕')
                    ),
                    React.createElement('div', { className: 'px-4 pt-2' },
                        React.createElement('div', { className: 'flex gap-2 mb-4' },
                            ['overview','billing','upgrade'].map(tab => (
                                React.createElement('button', { key: tab, onClick: () => setActiveTab(tab), className: `px-4 py-2 rounded-lg text-sm ${activeTab === tab ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}` }, tab.charAt(0).toUpperCase()+tab.slice(1))
                            ))
                        ),
                        activeTab === 'overview' && subscription && React.createElement('div', { className: 'space-y-4 mb-6' },
                            React.createElement('div', { className: 'p-4 bg-slate-50 rounded-lg border' },
                                React.createElement('div', { className: 'flex flex-wrap gap-4 items-center justify-between' },
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-sm text-slate-500' }, 'Current Plan'),
                                        React.createElement('div', { className: 'text-lg font-semibold' }, subscription.plan_display_name || subscription.plan_type)
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-sm text-slate-500' }, 'Status'),
                                        React.createElement('div', { className: 'text-sm font-medium' }, subscription.status)
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-sm text-slate-500' }, 'Next Billing'),
                                        React.createElement('div', { className: 'text-sm font-medium' }, subscription.next_billing_date || '—')
                                    )
                                )
                            ),
                            React.createElement('div', { className: 'flex gap-2' },
                                subscription.can_upgrade && React.createElement('button', { onClick: () => setActiveTab('upgrade'), className: 'px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg' }, 'Upgrade Plan'),
                                subscription.can_pause && React.createElement('button', { onClick: () => handlePause(1, '') , className: 'px-4 py-2 bg-yellow-500 text-white rounded-lg' }, 'Pause'),
                                subscription.can_cancel && React.createElement('button', { onClick: () => handleCancel(true, '') , className: 'px-4 py-2 bg-red-600 text-white rounded-lg' }, 'Cancel')
                            )
                        ),
                        activeTab === 'billing' && React.createElement('div', null,
                            // Summary cards
                            subscription && React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4' },
                                React.createElement('div', { className: 'p-3 bg-slate-50 rounded border' }, React.createElement('div', { className: 'text-xs text-slate-500' }, 'Total Paid'), React.createElement('div', { className: 'text-lg font-semibold', id: 'bh-total-paid' })),
                                React.createElement('div', { className: 'p-3 bg-slate-50 rounded border' }, React.createElement('div', { className: 'text-xs text-slate-500' }, 'Total Transactions'), React.createElement('div', { className: 'text-lg font-semibold' }, pagination.total_count || 0)),
                                React.createElement('div', { className: 'p-3 bg-slate-50 rounded border' }, React.createElement('div', { className: 'text-xs text-slate-500' }, 'Last Payment'), React.createElement('div', { className: 'text-lg font-semibold', id: 'bh-last-payment' })),
                                React.createElement('div', { className: 'p-3 bg-slate-50 rounded border' }, React.createElement('div', { className: 'text-xs text-slate-500' }, 'Failed Payments'), React.createElement('div', { className: 'text-lg font-semibold', id: 'bh-failed' }))
                            ),
                            // Filters
                            React.createElement('div', { className: 'flex flex-wrap gap-2 mb-3' },
                                React.createElement('select', { id: 'bh-status', className: 'p-2 bg-white border rounded' }, ['all','success','failed','pending'].map(s => React.createElement('option', { key: s, value: s === 'all' ? '' : s }, s.charAt(0).toUpperCase()+s.slice(1)))),
                                React.createElement('input', { id: 'bh-start', type: 'date', className: 'p-2 bg-white border rounded' }),
                                React.createElement('input', { id: 'bh-end', type: 'date', className: 'p-2 bg-white border rounded' }),
                                React.createElement('button', { onClick: () => {
                                    const status = document.getElementById('bh-status').value;
                                    const start = document.getElementById('bh-start').value;
                                    const end = document.getElementById('bh-end').value;
                                    const filters = {};
                                    if (status) filters.status = status;
                                    if (start) filters.start_date = start;
                                    if (end) filters.end_date = end;
                                    fetchBillingHistory(1, filters);
                                }, className: 'px-3 py-2 bg-slate-900 text-white rounded' }, 'Apply')
                            ),
                            React.createElement('div', { className: 'overflow-x-auto' },
                                React.createElement('table', { className: 'min-w-full text-sm' },
                                    React.createElement('thead', null,
                                        React.createElement('tr', { className: 'text-left text-slate-600' },
                                            ['Date','Transaction ID','Amount','Status','Invoice'].map(h => React.createElement('th', { key: h, className: 'py-2 px-3 border-b' }, h))
                                        )
                                    ),
                                    React.createElement('tbody', null,
                                        billingHistory.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 5, className: 'py-4 px-3 text-center text-slate-500' }, 'No transactions found')) :
                                        billingHistory.map(tx => (
                                            React.createElement('tr', { key: tx.id, className: 'hover:bg-slate-50' },
                                                React.createElement('td', { className: 'py-2 px-3 border-b' }, tx.created_at || ''),
                                                React.createElement('td', { className: 'py-2 px-3 border-b' }, tx.razorpay_payment_id || ''),
                                                React.createElement('td', { className: 'py-2 px-3 border-b' }, `₹${tx.amount}`),
                                                React.createElement('td', { className: 'py-2 px-3 border-b' }, tx.status),
                                                React.createElement('td', { className: 'py-2 px-3 border-b' }, tx.invoice_available ? React.createElement('button', { onClick: () => downloadInvoice(tx.id), className: 'text-indigo-600 hover:underline' }, 'Download') : '—')
                                            )
                                        ))
                                    )
                                )
                            ),
                            // Pagination controls
                            React.createElement('div', { className: 'flex items-center justify-between mt-3' },
                                React.createElement('button', { disabled: !(pagination.page > 1), onClick: () => fetchBillingHistory(pagination.page - 1), className: 'px-3 py-1 rounded bg-slate-100 disabled:opacity-50' }, 'Previous'),
                                React.createElement('div', { className: 'text-sm text-slate-600' }, `Page ${pagination.page || 1} of ${pagination.total_pages || 1}`),
                                React.createElement('button', { disabled: !(pagination.page < (pagination.total_pages || 1)), onClick: () => fetchBillingHistory(pagination.page + 1), className: 'px-3 py-1 rounded bg-slate-100 disabled:opacity-50' }, 'Next')
                            )
                        ),
                        activeTab === 'upgrade' && (function(){
                            // New pricing structure: Base plans with included users
                            const planBasePrices = {
                                'basic': 1700,      // ₹1,700/month - includes up to 5 users
                                'si_plus': 2600,    // ₹2,600/month - includes up to 10 users
                                'pro': 4300         // ₹4,300/month - includes up to 100 users
                            };
                            const planIncludedUsers = {
                                'basic': 5,
                                'si_plus': 10,
                                'pro': 100
                            };
                            const extraUserPrice = 500; // ₹500/month per extra user
                            
                            const amountPreview = (plan, users, cycle) => {
                                const basePrice = planBasePrices[plan] || 0;
                                const includedUsers = planIncludedUsers[plan] || 0;
                                const userCount = Math.max(1, parseInt(users||1,10));
                                const extraUsers = Math.max(0, userCount - includedUsers);
                                const extraCost = extraUsers * extraUserPrice;
                                const monthlyTotal = basePrice + extraCost;
                                const mult = cycle === 'yearly' ? 12 : 1;
                                return monthlyTotal * mult;
                            };
                            
                            return React.createElement('div', { className: 'space-y-4' },
                                React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-3 gap-3' },
                                    ['basic','si_plus','pro'].map(p => {
                                        const basePrice = planBasePrices[p];
                                        const includedUsers = planIncludedUsers[p];
                                        const planName = p === 'si_plus' ? 'SI+' : p.toUpperCase();
                                        return React.createElement('div', { key: p, className: `p-4 rounded-lg border ${selPlan===p?'border-indigo-500':'border-slate-200'} cursor-pointer`, onClick: () => setSelPlan(p) },
                                            React.createElement('div', { className: 'text-sm text-slate-500 mb-1' }, planName),
                                            React.createElement('div', { className: 'text-xl font-semibold text-slate-800' }, `₹${basePrice.toLocaleString('en-IN')}/mo`),
                                            React.createElement('div', { className: 'text-xs text-slate-600 mt-1' }, `Includes ${includedUsers} users`),
                                            React.createElement('div', { className: 'text-xs text-slate-500 mt-1' }, `₹${extraUserPrice}/user extra`)
                                        );
                                    })
                                ),
                                React.createElement('div', { className: 'flex flex-wrap gap-3' },
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-xs text-slate-500 mb-1' }, 'Users'),
                                        React.createElement('input', { type: 'number', min: 1, value: selUsers, onChange: e => setSelUsers(e.target.value), className: 'p-2 border rounded w-24' })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'text-xs text-slate-500 mb-1' }, 'Billing Cycle'),
                                        React.createElement('select', { value: selCycle, onChange: e => setSelCycle(e.target.value), className: 'p-2 border rounded' },
                                            React.createElement('option', { value: 'monthly' }, 'Monthly'),
                                            React.createElement('option', { value: 'yearly' }, 'Yearly')
                                        )
                                    ),
                                    React.createElement('div', { className: 'ml-auto p-2 rounded bg-slate-50 border' }, 
                                        React.createElement('div', { className: 'text-xs text-slate-500 mb-1' }, 'Total Amount'),
                                        React.createElement('div', { className: 'text-lg font-semibold text-slate-800' }, 
                                            `₹${amountPreview(selPlan, selUsers, selCycle).toLocaleString('en-IN')}${selCycle === 'yearly' ? '/year' : '/month'}`
                                        )
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('button', { onClick: () => handleUpgrade(selPlan, parseInt(selUsers||1,10), selCycle), className: 'px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg' }, 'Confirm Upgrade')
                                )
                            );
                        })()
                    )
                )
            );
            return React.createElement(React.Fragment, null, closeArea, content);
        };

        // Trial Countdown Banner Component
        const TrialCountdownBanner = ({ trialStatus, onUpgradeClick, onDismiss, isDismissed }) => {
            // Conditional rendering checks
            if (!trialStatus || !trialStatus.is_trial) return null;
            if (isDismissed && !trialStatus.is_expired) return null;
            
            // Determine banner state
            const isExpired = trialStatus.is_expired;
            const isExpiringSoon = trialStatus.days_remaining <= 3 && !isExpired;
            const isActive = !isExpired && !isExpiringSoon;
            
            // Styling based on state
            const bgColor = isExpired ? 'bg-gradient-to-r from-red-600 to-red-700' : 
                            isExpiringSoon ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                            'bg-gradient-to-r from-blue-500 to-blue-600';
            
            const textColor = 'text-white';
            
            // Message text
            const message = isExpired ? 'Your trial has ended. Upgrade now to continue using PROTON.' :
                            isExpiringSoon ? `Your trial expires in ${trialStatus.days_remaining} day${trialStatus.days_remaining !== 1 ? 's' : ''}! Upgrade now to continue.` :
                            `Your trial expires in ${trialStatus.days_remaining} days`;
            
            // Render banner with React.createElement
            return React.createElement('div', {
                className: `fixed top-0 left-0 right-0 z-50 ${bgColor} ${textColor} px-6 py-3 shadow-lg trial-banner-enter`,
                role: 'alert',
                'aria-live': isExpired ? 'assertive' : 'polite'
            },
                React.createElement('div', { className: 'flex flex-col sm:flex-row items-center justify-between gap-3 max-w-7xl mx-auto' },
                    // Left side: Icon and message
                    React.createElement('div', { className: 'flex items-center gap-3' },
                        // Icon (conditional based on state)
                        React.createElement('span', { className: 'text-2xl' }, isExpired ? '🚫' : isExpiringSoon ? '⚠️' : 'ℹ️'),
                        // Message text
                        React.createElement('p', { className: 'font-semibold text-base sm:text-lg' }, message)
                    ),
                    // Right side: Buttons
                    React.createElement('div', { className: 'flex items-center gap-3' },
                        // Upgrade button
                        React.createElement('button', {
                            onClick: onUpgradeClick,
                            className: `px-6 py-2 font-semibold rounded-lg transition-all ${isExpired || isExpiringSoon ? 'bg-white text-red-600 hover:bg-gray-100 trial-banner-pulse' : 'bg-white/20 hover:bg-white/30'}`
                        }, 'Upgrade Now'),
                        // Dismiss button (only for non-expired)
                        !isExpired && React.createElement('button', {
                            onClick: onDismiss,
                            className: 'p-1 hover:bg-white/20 rounded',
                            'aria-label': 'Dismiss banner'
                        }, React.createElement('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
                        ))
                    )
                )
            );
        };

        const App = () => {
            const { useState, useEffect, useCallback, useMemo } = React;
            const [loggedInUser, setLoggedInUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [appError, setAppError] = useState(null);
            const [notification, setNotification] = useState(null);
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState('');
            const [tasks, setTasks] = useState([]);
            const [pendingAdmins, setPendingAdmins] = useState([]);
            const [currentView, setCurrentView] = useState('admin');
            const [showEditModal, setShowEditModal] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showNotesModal, setShowNotesModal] = useState(false);
            const [showClientCommModal, setShowClientCommModal] = useState(false);
            const [showAddProjectModal, setShowAddProjectModal] = useState(false);
            const [showAddTaskModal, setShowAddTaskModal] = useState(false);
            const [showDetailsModal, setShowDetailsModal] = useState(false);
            const [showActivityLogModal, setShowActivityLogModal] = useState(false);
            const [showCSVImportModal, setShowCSVImportModal] = useState(false);
            const [showUserManagementModal, setShowUserManagementModal] = useState(false);
            const [showSubscriptionManagement, setShowSubscriptionManagement] = useState(false);
            const [subscriptionData, setSubscriptionData] = useState(null);
            const [trialStatus, setTrialStatus] = useState(null);
            const [isTrialBannerDismissed, setIsTrialBannerDismissed] = useState(false);
            const isTrialExpired = !!(trialStatus && trialStatus.is_trial && trialStatus.is_expired);
            const [selectedTask, setSelectedTask] = useState(null);
            const [addTaskContext, setAddTaskContext] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [startDateFilter, setStartDateFilter] = useState('');
            const [endDateFilter, setEndDateFilter] = useState('');
            const [sortBy, setSortBy] = useState({ field: 'wbs', order: 'asc' });
            const [areAllExpanded, setAreAllExpanded] = useState(true);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [dashboardData, setDashboardData] = useState(null);
            const [showNotificationDropdown, setShowNotificationDropdown] = useState(false);

            // --- Role-Based UI Helper Functions (already defined above for TaskRow access) ---
            // Note: These functions are defined before TaskRow component for scope access

            // --- Role Badge Helper ---
            const getRoleBadge = (role) => {
                const badges = {
                    'super_admin': { label: 'Super Admin', color: 'bg-purple-100 text-purple-700' },
                    'org_admin': { label: 'Org Admin', color: 'bg-blue-100 text-blue-700' },
                    'org_user': { label: 'User', color: 'bg-green-100 text-green-700' },
                    'client': { label: 'Client', color: 'bg-slate-100 text-slate-700' }
                };
                
                const badge = badges[role] || badges['org_user'];
                
                return React.createElement('span', {
                    className: `px-2 py-1 text-xs font-semibold rounded-full ${badge.color}`
                }, badge.label);
            };

            // --- Role-Based Welcome Message ---
            const getWelcomeMessage = (role) => {
                const messages = {
                    'super_admin': 'Welcome, Super Admin! You have full system access.',
                    'org_admin': 'Welcome, Organization Admin! Manage your team and projects.',
                    'org_user': 'Welcome! View and update your assigned tasks.',
                    'client': 'Welcome! View your project deliverables.'
                };
                return messages[role] || 'Welcome to PROTON!';
            };

            // --- Centralized API 403 Error Handler ---
            const handleAPIError = (response, data) => {
                if (response && response.status === 403) {
                    const msg = (loggedInUser && loggedInUser.role === 'org_user')
                        ? 'This action requires Org Admin privileges.'
                        : (data && data.message) || 'You do not have permission to perform this action.';
                    setAppError(msg);
                    return true;
                }
                return false;
            };


            const openEditModal = (task) => { setSelectedTask(task); setShowEditModal(true); };
            const openAIModal = (task) => { setSelectedTask(task); setShowAIModal(true); };
            const openNotesModal = (task) => { setSelectedTask(task); setShowNotesModal(true); };
            const openClientCommModal = (task) => {
                // When an admin opens the modal, find ALL unread comments for that task and mark them as seen.
                if (loggedInUser.userType !== 'client') {
                    const unreadCommentsExist = task.clientComments && task.clientComments.some(c => c.clientStatus && c.adminSeen === false);
                    if (unreadCommentsExist) {
                        const updatedComments = task.clientComments.map(c =>
                            (c.clientStatus && c.adminSeen === false) ? { ...c, adminSeen: true } : c
                        );
                        handleUpdateTask(task.id, { clientComments: updatedComments });
                    }
                }
                setSelectedTask(task);
                setShowClientCommModal(true);
            };

            const openDetailsModal = (task) => { setSelectedTask(task); setShowDetailsModal(true); };
            const openAddTaskModal = (task, mode) => { setAddTaskContext({ task, mode }); setShowAddTaskModal(true); };

            // Trial banner handlers
            const handleDismissTrialBanner = () => {
                setIsTrialBannerDismissed(true);
                sessionStorage.setItem('trial_banner_dismissed', 'true');
            };

            const handleTrialUpgrade = () => {
                setShowSubscriptionManagement(true);
            };

            const APP_SUBTITLE = selectedProject || "No Project Selected";

            useEffect(() => {
                const accessToken = localStorage.getItem('access_token');
                const userData = localStorage.getItem('user_data');
                
                if (accessToken && userData) {
                    try {
                        const authData = JSON.parse(userData);
                        
                        // Parse role from JWT token
                        let userRole = 'org_user'; // default fallback
                        let orgId = null;
                        let plan = null;
                        
                        try {
                            // JWT format: header.payload.signature
                            const payload = accessToken.split('.')[1];
                            const decodedPayload = JSON.parse(decodeBase64Url(payload));
                            userRole = decodedPayload.role || 'org_user';
                            orgId = decodedPayload.org_id || null;
                            plan = decodedPayload.plan || null;
                        } catch (jwtError) {
                            console.warn('Failed to parse JWT token:', jwtError);
                            // Fallback to userType for backward compatibility
                            if (authData.userType === 'admin') {
                                userRole = 'org_admin'; // fallback for existing admin users
                            }
                        }
                        
                        // Enhanced authData with role information
                        const enhancedAuthData = {
                            ...authData,
                            role: userRole,
                            org_id: orgId,
                            plan: plan
                        };
                        
                        setLoggedInUser(enhancedAuthData);
                        // Expose loggedInUser and a global notifier for centralized handlers
                        try {
                            window.loggedInUser = enhancedAuthData;
                            window.showNotification = ({ message, type = 'info', action, duration }) => {
                                setNotification({ message, type, action, duration });
                            };
                        } catch (e) {}
                        if (authData.userType === 'client') {
                            setCurrentView('client');
                            setSelectedProject(authData.project);
                        }
                    } catch (e) {
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('refresh_token');
                        localStorage.removeItem('user_data');
                    }
                } else {
                    // Clean up legacy auth format if present
                    localStorage.removeItem('aiProjectControlTowerAuth_v2');
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                window.openSubscriptionManagement = () => setShowSubscriptionManagement(true);
                return () => { try { delete window.openSubscriptionManagement; } catch (e) {} };
            }, []);

            useEffect(() => {
                if (loggedInUser) {
                    setIsLoading(true);
                    makeAuthenticatedRequest('/api/projects', { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                        .then(res => res.json())
                        .then(data => {
                            setProjects(data);
                            if (loggedInUser.userType !== 'client' && data.length > 0 && !selectedProject) {
                                setSelectedProject(data[0].name);
                            }
                        })
                        .catch(err => setAppError('Could not load projects list.'))
                        .finally(() => {
                            // Only set loading to false if we're not a client or if we don't have a selected project
                            // For clients, the loading will be managed by the task loading in loadInitialData
                            if (loggedInUser.userType !== 'client' || !selectedProject) {
                                setIsLoading(false);
                            }
                        });

                    if (loggedInUser.userType === 'super_admin') {
                        makeAuthenticatedRequest('/api/pending_admins', { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                            .then(res => res.json())
                            .then(data => setPendingAdmins(data))
                            .catch(err => console.error("Could not fetch pending admins"));
                    }
                }
            }, [loggedInUser]);

            // Fetch trial status when user logs in
            useEffect(() => {
                if (loggedInUser && loggedInUser.role !== 'super_admin' && loggedInUser.userType !== 'client') {
                    // Fetch trial status
                    makeAuthenticatedRequest('/api/org/trial-status', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            setTrialStatus(data);
                        }
                    })
                    .catch(err => {
                        console.error('Failed to fetch trial status:', err);
                        // Don't show error - banner simply won't appear
                    });
                    
                    // Check if banner was dismissed
                    const dismissed = sessionStorage.getItem('trial_banner_dismissed') === 'true';
                    setIsTrialBannerDismissed(dismissed);
                }
            }, [loggedInUser]);

            const normalizeTasks = (tasksToNormalize) => {
                if (!tasksToNormalize || !Array.isArray(tasksToNormalize)) return [];
                return tasksToNormalize.map(t => {
                    const subtasks = (t.subtasks && t.subtasks.length > 0) ? normalizeTasks(t.subtasks) : [];

                    return {
                        id: t.id || generateUUID(),
                        wbs: t.wbs || '',
                        taskName: t.taskName || '',
                        plannedStartDate: parseCSVDate(t.plannedStartDate || ''),
                        plannedEndDate: parseCSVDate(t.plannedEndDate || ''),
                        predecessorString: t.predecessorString || '',
                        originalDurationDays: String(t.originalDurationDays || '0').replace(' days', ''),
                        weightage: t.weightage ?? 0,
                        actualStartDate: parseCSVDate(t.actualStartDate || ''),
                        actualEndDate: parseCSVDate(t.actualEndDate || ''),
                        progress: t.progress || 0, // Will be recalculated
                        status: t.status || 'Not Started',
                        notes: Array.isArray(t.notes) ? t.notes : (typeof t.notes === 'string' && t.notes.trim() ? [{ text: t.notes, timestamp: new Date().toISOString(), source: 'AI Risk Assessment' }] : []),
                        isClientDeliverable: t.isClientDeliverable || false,
                        isCritical: t.isCritical || false,
                        dependencies: t.dependencies || [],
                        clientComments: (t.clientComments || []).map(c => ({ ...c, id: c.id || generateUUID() })), // Ensure comments have IDs
                        delayWeatherDays: t.delayWeatherDays || 0,
                        delayContractorDays: t.delayContractorDays || 0,
                        delayClientDays: t.delayClientDays || 0,
                        isExpanded: t.isExpanded !== undefined ? t.isExpanded : true,
                        subtasks: subtasks
                    };
                });
            };

            const [currentPage, setCurrentPage] = useState(1);
            const [hasMoreTasks, setHasMoreTasks] = useState(true);
            const [isLoadingMore, setIsLoadingMore] = useState(false);

            const loadInitialData = useCallback((projectName) => {
                setIsLoading(true);
                setCurrentPage(1);
                setHasMoreTasks(true);

                makeAuthenticatedRequest(`/api/load?project=${encodeURIComponent(projectName)}&page=1&per_page=50`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                    .then(res => res.ok ? res.json() : res.json().then(err => Promise.reject(err)))
                    .then(response => {
                        const raw = response.data || response; // Handle both paginated and non-paginated responses
                        const normalized = normalizeTasks(raw || []);
                        setTasks(recalculateParentProgress(normalized));

                        // Update pagination state
                        if (response.pagination) {
                            setHasMoreTasks(response.pagination.has_more);
                        }
                    })
                    .catch(err => setAppError(`Could not load tasks for ${projectName}: ${err.message}`))
                    .finally(() => setIsLoading(false));

                makeAuthenticatedRequest(`/api/chart_data?project=${encodeURIComponent(projectName)}`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                    .then(res => res.json())
                    .then(data => setDashboardData(data))
                    .catch(err => console.error("Failed to load dashboard data:", err));
            }, []);

            const loadMoreTasks = useCallback(() => {
                if (isLoadingMore || !hasMoreTasks || !selectedProject) return;

                setIsLoadingMore(true);
                const nextPage = currentPage + 1;

                makeAuthenticatedRequest(`/api/load?project=${encodeURIComponent(selectedProject)}&page=${nextPage}&per_page=50`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                    .then(res => res.ok ? res.json() : res.json().then(err => Promise.reject(err)))
                    .then(response => {
                        const newTasks = response.data || [];
                        const normalized = normalizeTasks(newTasks);

                        setTasks(prevTasks => {
                            const updatedTasks = [...prevTasks, ...recalculateParentProgress(normalized)];
                            return updatedTasks;
                        });

                        setCurrentPage(nextPage);
                        if (response.pagination) {
                            setHasMoreTasks(response.pagination.has_more);
                        }
                    })
                    .catch(err => console.error("Failed to load more tasks:", err))
                    .finally(() => setIsLoadingMore(false));
            }, [currentPage, hasMoreTasks, selectedProject, isLoadingMore]);

            // Helper function to fetch trial status
            const fetchTrialStatus = useCallback(() => {
                if (!loggedInUser || loggedInUser.role === 'super_admin' || loggedInUser.userType === 'client') {
                    return;
                }
                
                makeAuthenticatedRequest('/api/org/trial-status', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        setTrialStatus(data);
                    }
                })
                .catch(err => console.error('Failed to fetch trial status:', err));
            }, [loggedInUser]);

            useEffect(() => {
                if (loggedInUser && selectedProject) {
                    loadInitialData(selectedProject);
                } else {
                    setTasks([]);
                }
            }, [loggedInUser, selectedProject, loadInitialData]);

            const recalculateParentProgress = (taskList) => {
                return taskList.map(task => {
                    if (task.subtasks && task.subtasks.length > 0) {
                        const updatedSubtasks = recalculateParentProgress(task.subtasks);
                        let totalWeight = 0;
                        let weightedProgressSum = 0;
                        updatedSubtasks.forEach(st => {
                            const weight = parseFloat(st.weightage ?? 0);
                            const progress = parseFloat(st.progress || 0);
                            if (!isNaN(weight) && !isNaN(progress)) {
                                totalWeight += weight;
                                weightedProgressSum += progress * weight;
                            }
                        });
                        const newProgress = totalWeight > 0 ? parseFloat((weightedProgressSum / totalWeight).toFixed(2)) : 0;
                        return { ...task, subtasks: updatedSubtasks, progress: newProgress };
                    }
                    return task;
                });
            };

            const handleUpdateTask = useCallback((taskId, updatedData) => {
                const originalTasks = tasks; // Keep a copy of the original state to revert on error

                // Optimistically update UI
                const updateTaskRecursively = (taskList, id, data) => {
                    return taskList.map(task => {
                        if (task.id === id) {
                            return { ...task, ...data };
                        }
                        if (task.subtasks && task.subtasks.length > 0) {
                            return { ...task, subtasks: updateTaskRecursively(task.subtasks, id, data) };
                        }
                        return task;
                    });
                };

                const optimisticallyUpdatedTasks = updateTaskRecursively(tasks, taskId, updatedData);
                const finalTasksState = recalculateParentProgress(optimisticallyUpdatedTasks);
                setTasks(finalTasksState);

                // Prepare payload for the efficient endpoint
                const payload = {
                    taskId: taskId,
                    updatedData: updatedData,
                    user_email: loggedInUser.email
                };

                // Call the efficient endpoint
                makeAuthenticatedRequest(`/api/update_task?project=${encodeURIComponent(selectedProject)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(res => {
                        if (!res.ok) {
                            // If server returns an error, revert the optimistic update
                            setTasks(originalTasks);
                            return res.json().then(err => { throw new Error(err.message || 'Server update failed.') });
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.status !== 'success') {
                            // Handle logical errors from the server and revert
                            setTasks(originalTasks);
                            throw new Error(data.message || 'An unknown error occurred.');
                        }
                        setNotification({ message: 'Task updated successfully!', type: 'success' });
                    })
                    .catch(err => {
                        setTasks(originalTasks);
                        setAppError('Save error: ' + err.message);
                    });
            }, [tasks, selectedProject, loggedInUser]);


            const saveDataToServer = useCallback((tasksToSave, successMessage = 'Saved successfully') => {
                let updatedTasks = recalculateParentProgress(tasksToSave);
                const payload = { tasks: updatedTasks, user_email: loggedInUser.email };
                makeAuthenticatedRequest(`/api/save?project=${encodeURIComponent(selectedProject)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(async res => {
                        const data = await res.json();
                        if (handleAPIError(res, data)) return;
                        return data;
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            setTasks(updatedTasks);
                            setNotification({ message: successMessage, type: 'success' });
                        } else {
                            throw new Error(data.message || 'Save failed');
                        }
                    })
                    .catch(err => setAppError('Save error: ' + err.message));
            }, [selectedProject, loggedInUser]);

            const handleConfirmAddTask = useCallback((newTaskData) => {
                if (!addTaskContext) return;

                const payload = {
                    newTask: newTaskData,
                    context: addTaskContext,
                    user_email: loggedInUser.email
                };

                makeAuthenticatedRequest(`/api/add_task?project=${encodeURIComponent(selectedProject)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(async res => {
                        const data = await res.json();
                        if (handleAPIError(res, data)) return;
                        if (!res.ok) {
                            throw new Error(data.message || 'Failed to add task.');
                        }
                        return data;
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            setTasks(normalizeTasks(data.updatedTasks));
                            setNotification({ message: 'New task added successfully.', type: 'success' });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .catch(err => setAppError('Add task error: ' + err.message))
                    .finally(() => {
                        setAddTaskContext(null); // Close the modal regardless of outcome
                    });
            }, [selectedProject, addTaskContext, loggedInUser]);

            const handleDeleteTask = useCallback((taskId) => {
                if (!window.confirm("Are you sure you want to delete this task and all its subtasks? This action is irreversible.")) return;

                const payload = {
                    taskId: taskId,
                    user_email: loggedInUser.email
                };

                makeAuthenticatedRequest(`/api/delete_task?project=${encodeURIComponent(selectedProject)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(async res => {
                        const data = await res.json();
                        if (handleAPIError(res, data)) return;
                        if (!res.ok) {
                            throw new Error(data.message || 'Failed to delete task.');
                        }
                        return data;
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            setTasks(normalizeTasks(data.updatedTasks));
                            setNotification({ message: 'Task deleted successfully.', type: 'info' });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .catch(err => setAppError('Delete task error: ' + err.message));
            }, [selectedProject, loggedInUser]);

            const handleAddProject = (name, code) => {
                // Proactive check for project limits
                const usage = window.latestUsageStats;
                if (usage && usage.at_limit && usage.at_limit.projects) {
                    alert('You have reached the maximum number of projects allowed by your plan.');
                    if (typeof window.refreshUsageStats === 'function') window.refreshUsageStats();
                    return;
                }
                makeAuthenticatedRequest('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: name, client_access_code: code })
                })
                    .then(async res => {
                        const data = await res.json();
                        if (handleAPIError(res, data)) return;
                        return data;
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            setProjects(prev => [...prev, data.project]);
                            setSelectedProject(name);
                            setNotification({ message: 'Project added!', type: 'success' });
                        } else { throw new Error(data.message); }
                    })
                    .catch(err => setAppError(err.message));
            };

            const handleCSVImportSuccess = (rowCount) => {
                setNotification({ message: `${rowCount} tasks imported successfully.`, type: 'success' });
                loadInitialData(selectedProject);
            };

            const handleExport = (format) => {
                const getTasksForExport = () => {
                    if (loggedInUser.userType === 'client' || currentView === 'client') {
                        return clientViewTasks;
                    }
                    return tasks;
                };

                const tasksToExport = getTasksForExport();
                const viewLabel = (loggedInUser.userType === 'client' || currentView === 'client') ? ' (Client View)' : '';
                const viewLabelForFilename = (loggedInUser.userType === 'client' || currentView === 'client') ? '_client_view' : '';

                if (format === 'csv') {
                    const csvContent = generateCSV(tasksToExport);
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `${selectedProject}_tasks.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(18); doc.text(APP_TITLE, 14, 22);
                    doc.setFontSize(11); doc.setTextColor(100); doc.text(APP_SUBTITLE, 14, 28);
                    doc.setFontSize(10); doc.setTextColor(150); doc.text(`Project: ${selectedProject}${viewLabel}`, 14, 34);

                    const flattenedTasksForExport = [];
                    const flatten = (tasksToFlatten) => {
                        tasksToFlatten.forEach(task => {
                            flattenedTasksForExport.push(task);
                            if (task.subtasks) flatten(task.subtasks);
                        });
                    };
                    flatten(tasksToExport);

                    const head = [['WBS', 'Task Name', 'Planned Start', 'Planned End', 'Status', 'Progress (%)', 'Critical']];
                    const body = flattenedTasksForExport.map(task => [task.wbs, task.taskName, formatDateForDisplay(task.plannedStartDate), formatDateForDisplay(task.plannedEndDate), task.status, task.progress || 0, task.isCritical ? 'Yes' : 'No']);

                    doc.autoTable({ startY: 40, head, body, theme: 'grid' });
                    doc.save(`${selectedProject}_schedule${viewLabelForFilename}.pdf`);
                } else if (format === 'gantt') {
                    const ganttElement = document.getElementById('gantt-chart-render-area');
                    if (!ganttElement) {
                        setAppError("Gantt chart not found. Please ensure the chart is visible before exporting.");
                        return;
                    }
                    if (!window.html2canvas) {
                        setAppError("Export library not loaded. Please refresh the page and try again.");
                        return;
                    }
                    if (!tasksToExport || tasksToExport.length === 0) {
                        setAppError("No tasks available for Gantt export.");
                        return;
                    }

                    const scrollWidth = ganttElement.scrollWidth;
                    const scrollHeight = ganttElement.scrollHeight;

                    // You can keep this check as a preliminary guard
                    const MAX_CANVAS_AREA = 16384 * 16384;
                    if (scrollWidth * scrollHeight > MAX_CANVAS_AREA) {
                        setAppError("The Gantt chart is too large to export as a single image. Please apply filters to reduce the number of tasks.");
                        return;
                    }

                    setNotification({ message: 'Generating high-quality Gantt chart image...', type: 'info' });

                    window.html2canvas(ganttElement, {
                        backgroundColor: '#ffffff',
                        width: scrollWidth,
                        height: scrollHeight,
                        windowWidth: scrollWidth,
                        windowHeight: scrollHeight,
                        useCORS: true,
                        scale: 2
                    }).then(canvas => {
                        const image = canvas.toDataURL('image/png', 1.0);

                        // --- Validate the generated image data ---
                        if (!image || image.length < 100 || image === 'data:,') {
                            setAppError("The Gantt chart is too large to export as a single image. Please apply filters to reduce the number of tasks.");
                            setNotification(null); // Clear the "generating" message
                            return;
                        }

                        const link = document.createElement('a');
                        link.download = `${selectedProject}_gantt_chart${viewLabelForFilename}.png`;
                        link.href = image;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        setNotification({ message: 'High-quality Gantt chart exported successfully!', type: 'success' });
                    }).catch(err => {
                        console.error("Failed to capture Gantt chart:", err);
                        setAppError("Could not generate Gantt chart image. " + err.message);
                    });
                }
            };

            const handleLogout = () => {
                const accessToken = localStorage.getItem('access_token');
                
                // Call logout API to revoke token on server
                if (accessToken) {
                    fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + accessToken
                        }
                    }).catch(err => console.error('Logout API error:', err));
                }
                
                // Clear all authentication data from localStorage
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_data');
                // Clean up legacy auth format if present
                localStorage.removeItem('aiProjectControlTowerAuth_v2');
                sessionStorage.removeItem('trial_banner_dismissed');
                sessionStorage.removeItem('trial_banner_dismissed_at');
                
                window.location.href = '/';
            };

            const handleToggleExpansion = (taskId) => {
                const toggle = (taskList) => {
                    return taskList.map(t => {
                        if (t.id === taskId) {
                            return { ...t, isExpanded: !t.isExpanded };
                        }
                        if (t.subtasks && t.subtasks.length > 0) {
                            return { ...t, subtasks: toggle(t.subtasks) };
                        }
                        return t;
                    });
                };
                setTasks(toggle(tasks));
            };

            const handleToggleAllExpansion = useCallback(() => {
                const nextExpansionState = !areAllExpanded;
                const toggleRecursively = (taskList) => {
                    return taskList.map(t => ({
                        ...t,
                        isExpanded: nextExpansionState,
                        subtasks: t.subtasks ? toggleRecursively(t.subtasks) : []
                    }));
                };
                setTasks(toggleRecursively(tasks));
                setAreAllExpanded(nextExpansionState);
            }, [tasks, areAllExpanded]);

            const handleToggleAllClientDeliverables = useCallback((shouldSelectAll) => {
                // Optimistically update the UI for a responsive feel
                const toggleRecursively = (taskList) => {
                    return taskList.map(t => ({
                        ...t,
                        isClientDeliverable: shouldSelectAll,
                        subtasks: t.subtasks ? toggleRecursively(t.subtasks) : []
                    }));
                };
                const optimisticallyUpdatedTasks = toggleRecursively(tasks);
                setTasks(optimisticallyUpdatedTasks);

                const payload = {
                    should_select_all: shouldSelectAll,
                    user_email: loggedInUser.email
                };

                // Call the new, efficient endpoint
                makeAuthenticatedRequest(`/api/toggle_all_client_deliverables?project=${encodeURIComponent(selectedProject)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(res => {
                        if (!res.ok) {
                            // If the server fails, revert the optimistic update
                            setTasks(tasks);
                            return res.json().then(err => { throw new Error(err.message || 'Server update failed.') });
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            const message = shouldSelectAll ? 'All tasks marked for client view.' : 'All tasks removed from client view.';
                            setNotification({ message: message, type: 'success' });
                            // Optionally, you can re-fetch data here to ensure perfect sync, 
                            // but the optimistic update should suffice.
                            // loadInitialData(selectedProject);
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .catch(err => {
                        setTasks(tasks); // Revert on any failure
                        setAppError('Bulk update error: ' + err.message);
                    });
            }, [tasks, selectedProject, loggedInUser, saveDataToServer]);

            const handleNavigate = useCallback((page) => {
                if (page === 'home') {
                    window.location.href = '/home';
                } else if (page === 'charts') {
                    window.location.href = `/charts?project=${encodeURIComponent(selectedProject)}`;
                }
                setIsSidebarOpen(false);
            }, [selectedProject]);

            const clientViewTasks = useMemo(() => {
                if (!tasks) return [];
                const filterDeliverables = (taskList) => {
                    if (!taskList) return [];
                    return taskList
                        .map(task => ({ ...task, subtasks: filterDeliverables(task.subtasks) }))
                        .filter(task => task.isClientDeliverable || (task.subtasks && task.subtasks.length > 0));
                };
                return filterDeliverables(tasks);
            }, [tasks]);

            const filteredAndSortedTasks = useMemo(() => {
                if (!loggedInUser) return [];

                let baseTasks = (currentView === 'client' && loggedInUser.userType !== 'client') ? clientViewTasks : tasks;

                if (loggedInUser.userType === 'client') {
                    baseTasks = clientViewTasks;
                }

                let filtered = baseTasks;

                if (searchTerm || startDateFilter || endDateFilter) {
                    const searchFilter = (taskList) => {
                        if (!taskList) return [];
                        return taskList.map(task => {
                            const hasVisibleSubtasks = task.subtasks && task.subtasks.length > 0;
                            const subtasks = hasVisibleSubtasks ? searchFilter(task.subtasks) : [];

                            const matchesSearch = searchTerm ? (task.taskName || '').toLowerCase().includes(searchTerm.toLowerCase()) || (task.wbs || '').toLowerCase().includes(searchTerm.toLowerCase()) : true;

                            const matchesStartDate = startDateFilter && task.plannedStartDate ? task.plannedStartDate >= startDateFilter : true;
                            const matchesEndDate = endDateFilter && task.plannedEndDate ? task.plannedEndDate <= endDateFilter : true;

                            const selfMatches = matchesSearch && matchesStartDate && matchesEndDate;

                            if (selfMatches || subtasks.length > 0) {
                                return { ...task, subtasks };
                            }
                            return null;
                        }).filter(Boolean);
                    }
                    filtered = searchFilter(filtered);
                }

                const sortRecursively = (taskList) => {
                    if (!taskList) return;
                    taskList.sort((a, b) => {
                        const fieldA = a[sortBy.field], fieldB = b[sortBy.field]; let comparison = 0;
                        if (sortBy.field === 'wbs') {
                            comparison = a.wbs.localeCompare(b.wbs, undefined, { numeric: true, sensitivity: 'base' });
                        } else {
                            if (fieldA > fieldB) comparison = 1; else if (fieldA < fieldB) comparison = -1;
                        }
                        return sortBy.order === 'asc' ? comparison : comparison * -1;
                    });
                    taskList.forEach(task => { if (task.subtasks) sortRecursively(task.subtasks); });
                };

                const sorted = [...filtered];
                sortRecursively(sorted);
                return sorted;
            }, [tasks, clientViewTasks, currentView, loggedInUser, searchTerm, startDateFilter, endDateFilter, sortBy]);

            const handleSort = (field) => { setSortBy(prev => ({ field, order: prev.field === field && prev.order === 'asc' ? 'desc' : 'asc' })); };

            useEffect(() => {
                if (appError) { const timer = setTimeout(() => setAppError(null), 7000); return () => clearTimeout(timer); }
            }, [appError]);

            const unreadNotifications = useMemo(() => {
                if (!loggedInUser) return [];
                const notifications = new Map(); // Use a Map to prevent duplicate tasks in the list

                const findUnread = (taskList) => {
                    if (!taskList) return;
                    taskList.forEach(task => {
                        if (task.clientComments && task.clientComments.length > 0) {
                            // For Client: Check if ANY comment is un-replied to
                            if (loggedInUser.userType === 'client') {
                                const hasPending = task.clientComments.some(c => !c.clientStatus);
                                if (hasPending && !notifications.has(task.id)) {
                                    const latestPending = [...task.clientComments].reverse().find(c => !c.clientStatus);
                                    let notificationText = "New communication received.";
                                    const type = latestPending.communicationType;
                                    if (type === 'Information') { notificationText = "Information regarding project has been delivered."; }
                                    else if (type === 'Review') { notificationText = "A comment for your review has been received."; }
                                    else if (type === 'Approval') { notificationText = "Something needs your approval."; }
                                    notifications.set(task.id, { ...task, notificationText });
                                }
                            }
                            // For Admin: Check if ANY comment has an unread client response
                            else if (loggedInUser.userType !== 'client') {
                                const hasUnread = task.clientComments.some(c => c.clientStatus && c.adminSeen === false);
                                if (hasUnread && !notifications.has(task.id)) {
                                    notifications.set(task.id, { ...task, notificationText: "Client has responded to a communication." });
                                }
                            }
                        }
                        if (task.subtasks) findUnread(task.subtasks);
                    });
                };
                findUnread(tasks);
                return Array.from(notifications.values());
            }, [tasks, loggedInUser]);

            // Moved icon definitions and other functions before the conditional return
            const scrollToWbs = (id) => {
                const element = document.getElementById(id);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            const OverallIcon = () => React.createElement("svg", { className: "oepc-icon", fill: "none", viewBox: "0 0 24 24", strokeWidth: "2.5", stroke: "#157dc2" },
                React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: "M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" })
            );

            const EngineeringIcon = () => React.createElement("img", { src: "static/Engineering.png", alt: "Engineering", className: "oepc-icon" });
            const ProcurementIcon = () => React.createElement("img", { src: "static/Procurement.png", alt: "Procurement", className: "oepc-icon" });
            const ConstructionIcon = () => React.createElement("img", { src: "static/Construction.png", alt: "Construction", className: "oepc-icon" });

            const NotificationIcon = () => (
                React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: "feather feather-bell" },
                    React.createElement("path", { d: "M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" }),
                    React.createElement("path", { d: "M13.73 21a2 2 0 0 1-3.46 0" })
                )
            );

            if (isLoading && !loggedInUser) {
                return React.createElement(LoadingSpinner, { message: "Authenticating..." });
            }


            return React.createElement("div", { className: `min-h-screen bg-slate-100 p-2 sm:p-4 md:p-8 font-sans ${trialStatus && trialStatus.is_trial && (!isTrialBannerDismissed || trialStatus.is_expired) ? 'pt-20' : ''}` },
                // Trial Countdown Banner
                loggedInUser && loggedInUser.role !== 'super_admin' && loggedInUser.userType !== 'client' && trialStatus && 
                    React.createElement(TrialCountdownBanner, {
                        trialStatus: trialStatus,
                        onUpgradeClick: handleTrialUpgrade,
                        onDismiss: handleDismissTrialBanner,
                        isDismissed: isTrialBannerDismissed
                    }),
                React.createElement("div", { className: "oepc-nav-bar-right" }, // Changed class name here
                    // Overall
                    React.createElement("a", { href: "#", onClick: (e) => { e.preventDefault(); scrollToWbs("wbs-1"); }, className: "oepc-nav-link" },
                        React.createElement(OverallIcon),
                        React.createElement("span", { className: "tooltip" }, "Overall")
                    ),
                    // Engineering
                    React.createElement("a", { href: "#", onClick: (e) => { e.preventDefault(); scrollToWbs("wbs-1.2"); }, className: "oepc-nav-link" },
                        React.createElement(EngineeringIcon),
                        React.createElement("span", { className: "tooltip" }, "Engineering")
                    ),
                    // Procurement
                    React.createElement("a", { href: "#", onClick: (e) => { e.preventDefault(); scrollToWbs("wbs-1.3"); }, className: "oepc-nav-link" },
                        React.createElement(ProcurementIcon),
                        React.createElement("span", { className: "tooltip" }, "Procurement")
                    ),
                    // Construction
                    React.createElement("a", { href: "#", onClick: (e) => { e.preventDefault(); scrollToWbs("wbs-1.4"); }, className: "oepc-nav-link" },
                        React.createElement(ConstructionIcon),
                        React.createElement("span", { className: "tooltip" }, "Construction")
                    )
                ),

                React.createElement("div", {},
                    React.createElement("div", { className: `fixed inset-0 bg-black bg-opacity-50 z-40 ${isSidebarOpen ? 'block' : 'hidden'}`, onClick: () => setIsSidebarOpen(false) }),
                    React.createElement("div", { className: `fixed top-0 left-0 h-full bg-slate-800 text-white w-64 p-4 z-50 transform transition-transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}` },
                        React.createElement('h2', { className: 'text-2xl font-bold mb-8 text-sky-400' }, 'PROTON'),
                        React.createElement('ul', { className: 'space-y-2' },
                            React.createElement('li', null, React.createElement('button', { onClick: () => handleNavigate('home'), className: 'w-full text-left flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-700' }, React.createElement(HomeIcon, null), 'Home')),
                            React.createElement('li', null, React.createElement('button', { onClick: () => handleNavigate('charts'), className: 'w-full text-left flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-700' }, React.createElement(BarChartIcon, null), 'Charts'))
                        ),
                        (loggedInUser && (loggedInUser.role === 'super_admin' || loggedInUser.role === 'org_admin')) && React.createElement(UsageStatsWidget, { role: loggedInUser.role }),
                        (loggedInUser && (loggedInUser.role === 'super_admin' || loggedInUser.role === 'org_admin')) && React.createElement('div', { className: 'mt-4' },
                            React.createElement('button', { onClick: () => setShowSubscriptionManagement(true), className: 'w-full text-left flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-700 text-white' },
                                React.createElement('span', { className: 'w-5 h-5' }, '💳'), 'Manage Subscription'
                            )
                        )
                    )
                ),
                React.createElement("header", { className: "mb-6 p-4 bg-white shadow-md rounded-lg" },
                    React.createElement("div", { className: "flex flex-wrap items-center justify-between gap-4" },
                        React.createElement("div", { className: "flex items-center space-x-3" },
                            React.createElement("button", { onClick: () => setIsSidebarOpen(true), className: "p-2 rounded-md hover:bg-slate-100 lg:hidden" }, React.createElement(MenuIcon, { size: 24, className: "text-slate-600" })),
                            React.createElement("img", { src: '/static/logo.png', alt: "App Logo", className: "h-10 w-auto", crossOrigin: "anonymous" }),
                            React.createElement("div", null,
                                React.createElement("span", { className: "text-xl sm:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-blue-700" }, APP_TITLE),
                                React.createElement("span", { className: "text-base bg-clip-text text-slate-500 italic" }, APP_TITLE2),
                                loggedInUser && React.createElement("div", { className: "mt-2 flex items-center space-x-2" },
                                    React.createElement("span", { className: "text-sm text-slate-600" }, loggedInUser.email),
                                    getRoleBadge(loggedInUser.role)
                                ),
                                React.createElement("h1", { className: "text-sm font-bold text-slate-500" }, APP_SUBTITLE)
                            )
                        ),
                        React.createElement("div", { className: "hidden lg:flex items-center gap-4" },
                            React.createElement("nav", { className: "flex items-center gap-1" },
                                React.createElement("a", { href: "/home", className: 'px-4 py-2 text-sm font-semibold rounded-lg text-slate-600 hover:bg-slate-100' }, "Home"),
                                React.createElement("a", { href: `/charts?project=${encodeURIComponent(selectedProject)}`, className: 'px-4 py-2 text-sm font-semibold rounded-lg text-slate-600 hover:bg-slate-100' }, "Charts")
                            ),
                            React.createElement("div", { className: "h-6 w-px bg-slate-200" }),
                            React.createElement("div", { className: "relative" },
                                React.createElement("button", { onClick: () => setShowNotificationDropdown(!showNotificationDropdown), className: "p-2 rounded-full hover:bg-slate-100" },
                                    React.createElement(NotificationIcon, null),
                                    unreadNotifications.length > 0 && React.createElement("span", { className: "absolute -top-1 -right-1 block h-3 w-3 rounded-full bg-red-500 ring-2 ring-white" })
                                ),
                                showNotificationDropdown && React.createElement("div", { className: "absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-20" },
                                    React.createElement("div", { className: "p-4 font-bold border-b" }, "Notifications"),
                                    React.createElement("div", { className: "max-h-96 overflow-y-auto" },
                                        unreadNotifications.length > 0 ?
                                            unreadNotifications.map(task => (
                                                React.createElement("div", { key: task.id, onClick: () => { openClientCommModal(task); setShowNotificationDropdown(false); }, className: "p-4 border-b hover:bg-slate-50 cursor-pointer" },
                                                    React.createElement("p", { className: "font-semibold" }, task.taskName),
                                                    React.createElement("p", { className: "text-sm text-slate-500" }, task.notificationText)
                                                )
                                            )) :
                                            React.createElement("p", { className: "p-4 text-slate-500" }, "No new notifications.")
                                    )
                                )
                            ),
                            React.createElement("div", { className: "flex items-center gap-2" },
                                (loggedInUser && loggedInUser.role === 'super_admin') && React.createElement("button", { onClick: () => { window.location.href = '/superadmin'; }, className: "px-4 py-2 text-sm font-medium bg-gradient-to-r from-purple-600 to-blue-600 text-white hover:from-purple-700 hover:to-blue-700 border border-slate-200 rounded-lg flex items-center" }, React.createElement(BarChartIcon, { size: 16, className: "mr-2" }), "SuperAdmin Dashboard"),
                                canManageUsers(loggedInUser.role) && React.createElement("button", { onClick: () => setShowUserManagementModal(true), className: "px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 border border-slate-200 rounded-lg flex items-center" }, React.createElement(UserCog, { size: 16, className: "mr-2" }), "Manage Users"),
                                canViewActivityLogs(loggedInUser.role) && React.createElement("button", { onClick: () => setShowActivityLogModal(true), className: "px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 border border-slate-200 rounded-lg flex items-center" }, React.createElement(HistoryIcon, { size: 16, className: "mr-2" }), "Activity Log"),
                                React.createElement("button", { onClick: handleLogout, className: "px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 border border-slate-200 rounded-lg flex items-center" }, React.createElement(LogOutIcon, { size: 16, className: "mr-2" }), "Logout")
                            )
                        )
                    ),
                    loggedInUser && loggedInUser.userType !== 'client' && React.createElement("div", { className: "mt-4 flex flex-col sm:flex-col justify-between items-center gap-4" },
                        React.createElement("div", { className: "flex items-center gap-2" },
                            React.createElement("select", { value: selectedProject, onChange: e => setSelectedProject(e.target.value), className: "w-full p-2 bg-slate-50 text-slate-700 rounded-md border border-slate-300 focus:ring-2 focus:ring-sky-500 outline-none" },
                                projects.length === 0 && React.createElement("option", null, "No projects available"),
                                projects.map(p => React.createElement("option", { key: p.name, value: p.name }, p.name))
                            ),
                            canManageProjects(loggedInUser.role) && React.createElement("button", { 
                                onClick: () => setShowAddProjectModal(true), 
                                disabled: isTrialExpired,
                                title: isTrialExpired ? 'Trial expired. Upgrade to continue.' : undefined,
                                className: `p-2 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-lg flex items-center justify-center ${isTrialExpired ? 'opacity-50 cursor-not-allowed' : ''}` 
                            }, React.createElement(PlusCircle, { size: 16 }))
                        ),
                        React.createElement("div", { className: "flex items-center gap-2 bg-slate-100 rounded-lg p-1" },
                            React.createElement("button", { onClick: () => setCurrentView('admin'), className: `px-3 py-1.5 text-sm font-semibold rounded-md transition-colors ${currentView === 'admin' ? 'bg-white shadow text-sky-600' : 'text-slate-600 hover:bg-slate-200'}` }, "Admin View"),
                            React.createElement("button", { onClick: () => setCurrentView('client'), className: `px-3 py-1.5 text-sm font-semibold rounded-md transition-colors flex items-center ${currentView === 'client' ? 'bg-white shadow text-sky-600' : 'text-slate-600 hover:bg-slate-200'}` }, React.createElement(EyeIcon, { size: 16, className: "mr-1.5" }), "Client View")
                        )
                    ),
                    loggedInUser && React.createElement("div", { className: "mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg" },
                        React.createElement("p", { className: "text-sm text-blue-700" }, getWelcomeMessage(loggedInUser.role))
                    ),
                    dashboardData && dashboardData.next_critical_activity && (
                        React.createElement("div", { className: "mt-4 p-3 bg-red-50 border-l-4 border-red-400 text-red-800 text-sm" },
                            React.createElement("strong", null, "Next Critical Activity: "),
                            `${dashboardData.next_critical_activity.wbs} - ${dashboardData.next_critical_activity.taskName}`
                        )
                    )
                ),
                notification && React.createElement(NotificationToast, { message: notification.message, type: notification.type, onDismiss: () => setNotification(null) }),
                appError && React.createElement("div", { className: "mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm", role: "alert" }, React.createElement("strong", null, "Error: "), appError),
                React.createElement('div', null,
                    canApproveAdmins(loggedInUser.role) && React.createElement(ApprovalDashboard, { pendingAdmins: pendingAdmins, onApprove: (email) => setPendingAdmins(prev => prev.filter(p => p.email !== email)), onReject: (email) => setPendingAdmins(prev => prev.filter(p => p.email !== email)), setNotification, setAppError }),
                    tasks.length > 0 && !isLoading && React.createElement(OverallProgress, { tasks: tasks, selectedProject: selectedProject }),
                    React.createElement("div", { className: "mb-4 p-4 bg-white shadow-md rounded-lg flex flex-col sm:flex-row sm:items-center gap-4 flex-wrap" },
                        React.createElement("input", { type: "text", placeholder: "Search Tasks...", value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "w-full sm:w-auto flex-grow p-2 border border-slate-300 rounded-lg" }),
                        React.createElement("input", { type: "date", value: startDateFilter, onChange: e => setStartDateFilter(e.target.value), className: "w-full sm:w-auto p-2 border border-slate-300 rounded-lg" }),
                        React.createElement("input", { type: "date", value: endDateFilter, onChange: e => setEndDateFilter(e.target.value), className: "w-full sm:w-auto p-2 border border-slate-300 rounded-lg" }),

                        loggedInUser && loggedInUser.userType !== 'client' && React.createElement(React.Fragment, null,
                            canManageProjects(loggedInUser.role) && React.createElement("button", { 
                                onClick: () => setShowCSVImportModal(true), 
                                disabled: isTrialExpired,
                                title: isTrialExpired ? 'Trial expired. Upgrade to continue.' : undefined,
                                className: `px-4 py-2 text-sm font-semibold rounded-lg bg-gradient-to-r from-sky-500 to-blue-600 text-white hover:from-sky-600 hover:to-blue-700 shadow-lg transition-all duration-300 flex items-center justify-center gap-2 ${isTrialExpired ? 'opacity-50 cursor-not-allowed' : ''}` 
                            }, React.createElement(UploadCloud, { size: 18, className: "mr-2" }), "Import CSV"),
                            React.createElement("button", { 
                                onClick: () => handleExport('csv'), 
                                disabled: isTrialExpired,
                                title: isTrialExpired ? 'Trial expired. Upgrade to continue.' : undefined,
                                className: `px-4 py-2 text-sm font-semibold rounded-lg bg-gradient-to-r from-green-400 to-green-600 text-white shadow-lg hover:from-green-500 hover:to-green-700 transition-all duration-300 flex items-center justify-center gap-2 ${isTrialExpired ? 'opacity-50 cursor-not-allowed' : ''}` 
                            }, React.createElement(DownloadCloud, { size: 18, className: "mr-2" }), "Export CSV")
                        ),

                        React.createElement("button", { 
                            onClick: () => handleExport('pdf'), 
                            disabled: isTrialExpired,
                            title: isTrialExpired ? 'Trial expired. Upgrade to continue.' : undefined,
                            className: `px-4 py-2 text-sm font-semibold rounded-lg bg-gradient-to-r from-purple-400 to-purple-600 text-white shadow-lg hover:from-purple-500 hover:to-purple-700 transition-all duration-300 flex items-center justify-center gap-2 ${isTrialExpired ? 'opacity-50 cursor-not-allowed' : ''}` 
                        }, React.createElement(FileText, { size: 18, className: "mr-2" }), "Export PDF"),
                        React.createElement("button", { 
                            onClick: () => handleExport('gantt'), 
                            disabled: isTrialExpired,
                            title: isTrialExpired ? 'Trial expired. Upgrade to continue.' : undefined,
                            className: `px-4 py-2 text-sm font-semibold rounded-lg bg-gradient-to-r from-pink-400 to-pink-600 text-white shadow-lg hover:from-pink-500 hover:to-pink-700 transition-all duration-300 flex items-center justify-center gap-2 ${isTrialExpired ? 'opacity-50 cursor-not-allowed' : ''}` 
                        }, React.createElement(Image, { size: 18, className: "mr-2" }), "Export Gantt")
                    ),
                    isLoading ? React.createElement(LoadingSpinner, { message: loggedInUser && loggedInUser.userType === 'client' ? "Loading Project Data..." : "Loading Tasks..." }) : (filteredAndSortedTasks.length > 0 ?
                        React.createElement(TaskTable, {
                            tasks: filteredAndSortedTasks,
                            viewType: currentView,
                            loggedInUserType: loggedInUser.userType,
                            sortBy: sortBy,
                            onSort: handleSort,
                            areAllExpanded: areAllExpanded,
                            onToggleAllExpansion: handleToggleAllExpansion,
                            onUpdateTask: handleUpdateTask,
                            onAddTask: (task) => openAddTaskModal(task, 'sibling'),
                            onAddSubTask: (task) => openAddTaskModal(task, 'child'),
                            onDeleteTask: handleDeleteTask,
                            onEditTask: openEditModal,
                            onAIUpdate: openAIModal,
                            onShowNotes: openNotesModal,
                            onShowDetails: openDetailsModal,
                            onClientComm: openClientCommModal,
                            onToggleClientDeliverable: (task, isChecked) => handleUpdateTask(task.id, { isClientDeliverable: isChecked }),
                            onToggleExpansion: handleToggleExpansion,
                            onToggleAllClientDeliverables: handleToggleAllClientDeliverables,
                            hasMoreTasks: hasMoreTasks,
                            isLoadingMore: isLoadingMore,
                            loadMoreTasks: loadMoreTasks,
                            isTrialExpired: isTrialExpired
                        }) :
                        React.createElement("div", { className: "text-center py-10 bg-white shadow rounded-lg" }, "No tasks found.")
                    ),
                    ((currentView === 'admin' && loggedInUser.userType !== 'client') || currentView === 'client') && !isLoading && filteredAndSortedTasks.length > 0 && React.createElement(GanttChart, { tasks: filteredAndSortedTasks })
                ),
                showActivityLogModal && React.createElement(ActivityLogModal, { onClose: () => setShowActivityLogModal(false) }),
                showCSVImportModal && React.createElement(CSVImportModal, { 
                    onClose: () => setShowCSVImportModal(false), 
                    onImport: handleCSVImportSuccess, 
                    selectedProject: selectedProject,
                    loggedInUser: loggedInUser 
                }),
                showDetailsModal && selectedTask && React.createElement(TaskDetailsModal, { task: selectedTask, onClose: () => setShowDetailsModal(false), loggedInUserType: loggedInUser.userType }),
                showEditModal && selectedTask && React.createElement(EditTaskModal, {
                    task: selectedTask,
                    onClose: () => setShowEditModal(false),
                    onSave: (updatedData) => {
                        handleUpdateTask(selectedTask.id, updatedData);
                        setShowEditModal(false);
                    },
                    isTrialExpired: isTrialExpired
                }),
                showAddProjectModal && React.createElement(AddProjectModal, { onClose: () => setShowAddProjectModal(false), onAdd: (name, code) => { handleAddProject(name, code); setShowAddProjectModal(false); } }),
                showAddTaskModal && addTaskContext && React.createElement(AddTaskModal, { mode: addTaskContext.mode, onClose: () => setAddTaskContext(null), onAdd: handleConfirmAddTask }),
                showAIModal && selectedTask && React.createElement(AIUpdateModal, {
                    task: selectedTask,
                    allTasks: tasks,
                    loggedInUserType: loggedInUser.userType,
                    onClose: () => setShowAIModal(false),
                    setAppError: setAppError,
                    onApplySuggestion: (taskId, suggestedData) => {
                        handleUpdateTask(taskId, suggestedData);
                        setShowAIModal(false);
                    },
                }),
                showNotesModal && selectedTask && React.createElement(NotesModal, {
                    task: selectedTask,
                    loggedInUser: loggedInUser,
                    onClose: () => setShowNotesModal(false),
                    onAddNote: (taskId, noteText) => {
                        const taskToUpdate = findTaskById(tasks, taskId);
                        if (taskToUpdate) {
                            const newNote = {
                                text: noteText,
                                timestamp: new Date().toISOString(),
                                source: loggedInUser.name
                            };
                            const updatedNotes = [...(taskToUpdate.notes || []), newNote];
                            handleUpdateTask(taskId, { notes: updatedNotes });
                        }
                        setShowNotesModal(false);
                    }
                }),
                showClientCommModal && selectedTask && React.createElement(ClientCommunicationModal, {
                    task: selectedTask,
                    loggedInUser: loggedInUser,
                    selectedProject: selectedProject, // Pass selectedProject as a prop
                    onClose: () => setShowClientCommModal(false),
                    onAdminAddComment: (taskId, comment, type, attachmentPaths) => { // Note: attachmentPaths is an array
                        const taskToUpdate = findTaskById(tasks, taskId);
                        if (taskToUpdate) {
                            const newComment = {
                                id: generateUUID(),
                                adminName: loggedInUser.name,
                                adminTimestamp: new Date().toISOString(),
                                adminComment: comment,
                                communicationType: type,
                                attachments: attachmentPaths || [] // Save as an array
                            };
                            const updatedComments = [...(taskToUpdate.clientComments || []), newComment];
                            handleUpdateTask(taskId, { clientComments: updatedComments });
                        }
                        setShowClientCommModal(false);
                    },
                    onClientRespond: (taskId, commentId, status, commentText, clientAttachmentPaths = []) => {
                        const taskToUpdate = findTaskById(tasks, taskId);
                        if (taskToUpdate) {
                            const updatedComments = (taskToUpdate.clientComments || []).map(cc =>
                                cc.id === commentId
                                    ? {
                                        ...cc,
                                        clientStatus: status,
                                        clientComment: commentText,
                                        clientResponseTimestamp: new Date().toISOString(),
                                        clientAttachments: clientAttachmentPaths
                                    }
                                    : cc
                            );
                            handleUpdateTask(taskId, { clientComments: updatedComments });
                        }
                        setShowClientCommModal(false);
                    }
                }),
                showUserManagementModal && React.createElement(UserManagementModal, {
                    onClose: () => setShowUserManagementModal(false),
                    loggedInUser: loggedInUser,
                    onUserCreated: (user) => {
                        setNotification({ message: 'User created successfully', type: 'success' });
                    },
                    onUserUpdated: (user) => {
                        setNotification({ message: 'User updated successfully', type: 'success' });
                    },
                    onUserDeleted: (userId) => {
                        setNotification({ message: 'User deleted successfully', type: 'success' });
                    }
                }),
                showSubscriptionManagement && React.createElement(SubscriptionManagementModal, {
                    onClose: () => setShowSubscriptionManagement(false),
                    loggedInUser: loggedInUser,
                    onSubscriptionUpdated: () => {
                        if (typeof window.refreshUsageStats === 'function') window.refreshUsageStats();
                        fetchTrialStatus();
                        setIsTrialBannerDismissed(false);
                        sessionStorage.removeItem('trial_banner_dismissed');
                    }
                }),
                React.createElement(Chatbot, { projectTasks: tasks, projectName: selectedProject })
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));

        // Hide loading overlay once page is fully loaded
        window.addEventListener('load', function() {
            // Wait a bit for React to render initial content
            setTimeout(function() {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                    // Remove from DOM after animation completes
                    setTimeout(function() {
                        loadingOverlay.remove();
                    }, 500);
                }
            }, 300);
        });

        // Fallback: Hide loading overlay if window.load doesn't fire
        // This ensures the loading screen doesn't stay forever
        setTimeout(function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay && !loadingOverlay.classList.contains('hidden')) {
                loadingOverlay.classList.add('hidden');
                setTimeout(function() {
                    loadingOverlay.remove();
                }, 500);
            }
        }, 5000);
    </script>
</body>

</html>